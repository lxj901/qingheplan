# ç™½å™ªéŸ³åå°æ’­æ”¾é—®é¢˜ä¿®å¤æ–¹æ¡ˆ

## é—®é¢˜è¯Šæ–­

### å‘ç°çš„é—®é¢˜

1. **éŸ³é¢‘ä¼šè¯å†²çª**
   - `AudioRecordingManager` åœ¨å½•éŸ³æ—¶ä½¿ç”¨ `.playAndRecord` ç±»åˆ«
   - `AudioMessageManager` åœ¨æ’­æ”¾æ—¶ä½¿ç”¨ `.playAndRecord` ç±»åˆ«
   - `WorkoutAudioPlayer` åœ¨æ’­æ”¾æ—¶ä½¿ç”¨ `.playback` + `.duckOthers`
   - è¿™äº›ç»„ä»¶åœ¨å¯åŠ¨æ—¶ä¼š**è¦†ç›–** WhiteNoisePlayer çš„éŸ³é¢‘ä¼šè¯é…ç½®

2. **éŸ³é¢‘ä¼šè¯æ¿€æ´»æ—¶æœº**
   - å„ä¸ªéŸ³é¢‘ç»„ä»¶åœ¨å¯åŠ¨æ—¶ä¼šè°ƒç”¨ `setActive(true)`
   - åœ¨åœæ­¢æ—¶ä¼šè°ƒç”¨ `setActive(false)`
   - ä½†**ç™½å™ªéŸ³æ’­æ”¾å™¨çš„ä¼šè¯å¯èƒ½è¢«å…¶ä»–ç»„ä»¶åœç”¨**

3. **ç¼ºå°‘ç»Ÿä¸€ç®¡ç†**
   - è™½ç„¶æœ‰ `AudioSessionManager`ï¼Œä½†å„ç»„ä»¶å¹¶æœªå®Œå…¨ä½¿ç”¨å®ƒ
   - å¯¼è‡´éŸ³é¢‘ä¼šè¯çŠ¶æ€ä¸ä¸€è‡´

## ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šå¢å¼º AudioSessionManagerï¼ˆæ¨èï¼‰

åˆ›å»ºä¸€ä¸ªç»Ÿä¸€çš„éŸ³é¢‘ä¼šè¯ç®¡ç†å™¨ï¼Œæ‰€æœ‰éŸ³é¢‘ç»„ä»¶é€šè¿‡å®ƒæ¥è¯·æ±‚å’Œé‡Šæ”¾éŸ³é¢‘ä¼šè¯ã€‚

**ä¼˜ç‚¹**ï¼š
- é›†ä¸­ç®¡ç†ï¼Œé¿å…å†²çª
- å¯ä»¥å¤„ç†ä¼˜å…ˆçº§
- æ˜“äºè°ƒè¯•å’Œç»´æŠ¤

**å®ç°æ­¥éª¤**ï¼š
1. å¢å¼º `AudioSessionManager` çš„åŠŸèƒ½
2. æ·»åŠ ä¼˜å…ˆçº§ç®¡ç†
3. å„ç»„ä»¶åœ¨ä½¿ç”¨å‰è¯·æ±‚éŸ³é¢‘ä¼šè¯
4. è‡ªåŠ¨å¤„ç†ä¼šè¯åˆ‡æ¢

### æ–¹æ¡ˆ 2ï¼šä¿®æ”¹ WhiteNoisePlayerï¼ˆå¿«é€Ÿä¿®å¤ï¼‰

åœ¨ WhiteNoisePlayer ä¸­æ·»åŠ éŸ³é¢‘ä¼šè¯ç›‘å¬å’Œæ¢å¤æœºåˆ¶ã€‚

**ä¼˜ç‚¹**ï¼š
- ä¿®æ”¹æœ€å°‘
- å¿«é€Ÿè§æ•ˆ
- ä¸å½±å“å…¶ä»–ç»„ä»¶

**å®ç°æ­¥éª¤**ï¼š
1. ç›‘å¬éŸ³é¢‘ä¼šè¯ç±»åˆ«å˜æ›´
2. åœ¨æ£€æµ‹åˆ°å˜æ›´åé‡æ–°æ–­è¨€ playback æ¨¡å¼
3. ç¡®ä¿æ’­æ”¾å™¨ä¸è¢«æš‚åœ

## æ¨èä¿®å¤ä»£ç 

### ä¿®å¤ 1ï¼šå¢å¼º AudioSessionManager

```swift
// åœ¨ AdditionalTypes.swift ä¸­æ›´æ–° AudioSessionManager

class AudioSessionManager: ObservableObject {
    static let shared = AudioSessionManager()

    enum AudioComponent: String {
        case whiteNoise = "WhiteNoise"
        case audioMessage = "AudioMessage"
        case audioRecording = "AudioRecording"
        case workoutAudio = "WorkoutAudio"
        case sleepTracking = "SleepTracking"

        var priority: Int {
            switch self {
            case .whiteNoise: return 100      // æœ€é«˜ä¼˜å…ˆçº§ï¼ˆåå°æ’­æ”¾ï¼‰
            case .sleepTracking: return 90    // æ¬¡é«˜ä¼˜å…ˆçº§ï¼ˆåå°å½•éŸ³ï¼‰
            case .audioRecording: return 80   // å½•éŸ³
            case .audioMessage: return 70     // è¯­éŸ³æ¶ˆæ¯
            case .workoutAudio: return 60     // è¿åŠ¨éŸ³é¢‘
            }
        }

        var category: AVAudioSession.Category {
            switch self {
            case .whiteNoise, .audioMessage, .workoutAudio:
                return .playback
            case .audioRecording:
                return .playAndRecord
            case .sleepTracking:
                return .playAndRecord
            }
        }

        var mode: AVAudioSession.Mode {
            switch self {
            case .whiteNoise, .audioMessage:
                return .default
            case .workoutAudio:
                return .spokenAudio
            case .audioRecording, .sleepTracking:
                return .default
            }
        }

        var options: AVAudioSession.CategoryOptions {
            switch self {
            case .whiteNoise:
                return []  // ç‹¬å æ¨¡å¼
            case .audioMessage:
                return [.defaultToSpeaker, .allowBluetooth]
            case .audioRecording:
                return [.defaultToSpeaker]
            case .workoutAudio:
                return [.duckOthers]
            case .sleepTracking:
                return [.allowBluetooth]
            }
        }
    }

    private var activeComponents: [AudioComponent: Int] = [:]  // component -> priority
    private var currentComponent: AudioComponent?

    private init() {}

    /// è¯·æ±‚éŸ³é¢‘ä¼šè¯ï¼ˆå¸¦ä¼˜å…ˆçº§ï¼‰
    func requestAudioSession(for component: AudioComponent) {
        print("ğŸµ [AudioSessionManager] \(component.rawValue) è¯·æ±‚éŸ³é¢‘ä¼šè¯")

        activeComponents[component] = component.priority

        // å¦‚æœå½“å‰æ²¡æœ‰ç»„ä»¶ï¼Œæˆ–è€…è¯·æ±‚çš„ç»„ä»¶ä¼˜å…ˆçº§æ›´é«˜ï¼Œåˆ™åˆ‡æ¢
        if currentComponent == nil || component.priority >= (currentComponent?.priority ?? 0) {
            switchToComponent(component)
        } else {
            print("â„¹ï¸ [AudioSessionManager] \(component.rawValue) ä¼˜å…ˆçº§è¾ƒä½ï¼Œä¸åˆ‡æ¢ä¼šè¯")
        }
    }

    /// é‡Šæ”¾éŸ³é¢‘ä¼šè¯
    func releaseAudioSession(for component: AudioComponent) {
        print("ğŸµ [AudioSessionManager] \(component.rawValue) é‡Šæ”¾éŸ³é¢‘ä¼šè¯")

        activeComponents.removeValue(forKey: component)

        // å¦‚æœé‡Šæ”¾çš„æ˜¯å½“å‰ç»„ä»¶ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªä¼˜å…ˆçº§æœ€é«˜çš„ç»„ä»¶
        if currentComponent == component {
            if let nextComponent = getHighestPriorityComponent() {
                switchToComponent(nextComponent)
            } else {
                deactivateAudioSession()
            }
        }
    }

    /// æ ‡è®°ç»„ä»¶æ´»è·ƒï¼ˆä¸åˆ‡æ¢ä¼šè¯ï¼Œä»…æ ‡è®°ï¼‰
    func markActive(componentId: String) {
        // ä¿æŒå…¼å®¹æ€§
        print("ğŸ”’ [AudioSessionManager] æ ‡è®°æ´»è·ƒ: \(componentId)")
    }

    /// å–æ¶ˆæ ‡è®°æ´»è·ƒ
    func unmarkActive(componentId: String) {
        // ä¿æŒå…¼å®¹æ€§
        print("ğŸ”“ [AudioSessionManager] å–æ¶ˆæ ‡è®°: \(componentId)")
    }

    // MARK: - Private Methods

    private func switchToComponent(_ component: AudioComponent) {
        guard currentComponent != component else {
            print("â„¹ï¸ [AudioSessionManager] å·²æ˜¯ \(component.rawValue)ï¼Œæ— éœ€åˆ‡æ¢")
            return
        }

        print("ğŸ”„ [AudioSessionManager] åˆ‡æ¢éŸ³é¢‘ä¼šè¯: \(currentComponent?.rawValue ?? "æ— ") -> \(component.rawValue)")

        do {
            let session = AVAudioSession.sharedInstance()

            // è®¾ç½®éŸ³é¢‘ä¼šè¯ç±»åˆ«
            try session.setCategory(
                component.category,
                mode: component.mode,
                options: component.options
            )

            // æ¿€æ´»éŸ³é¢‘ä¼šè¯
            try session.setActive(true, options: [])

            currentComponent = component

            print("âœ… [AudioSessionManager] éŸ³é¢‘ä¼šè¯å·²åˆ‡æ¢åˆ°: \(component.rawValue)")
            print("   ç±»åˆ«: \(component.category.rawValue), æ¨¡å¼: \(component.mode.rawValue)")

        } catch {
            print("âŒ [AudioSessionManager] éŸ³é¢‘ä¼šè¯åˆ‡æ¢å¤±è´¥: \(error)")
        }
    }

    private func deactivateAudioSession() {
        print("ğŸ”‡ [AudioSessionManager] åœç”¨éŸ³é¢‘ä¼šè¯")

        do {
            try AVAudioSession.sharedInstance().setActive(false, options: .notifyOthersOnDeactivation)
            currentComponent = nil
            print("âœ… [AudioSessionManager] éŸ³é¢‘ä¼šè¯å·²åœç”¨")
        } catch {
            print("âš ï¸ [AudioSessionManager] éŸ³é¢‘ä¼šè¯åœç”¨å¤±è´¥: \(error)")
        }
    }

    private func getHighestPriorityComponent() -> AudioComponent? {
        return activeComponents.max(by: { $0.value < $1.value })?.key
    }

    // MARK: - å…¶ä»–æ–¹æ³•ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰

    func configureForPlayback() {
        print("ğŸ”Š [AudioSessionManager] configureForPlayback (åºŸå¼ƒ)")
    }

    func configureForRecording() {
        print("ğŸ¤ [AudioSessionManager] configureForRecording (åºŸå¼ƒ)")
    }

    func deactivate() {
        print("ğŸ”‡ [AudioSessionManager] deactivate (åºŸå¼ƒ)")
    }

    func configureForBackgroundRecording(componentId: String = "SleepTracking") async throws {
        requestAudioSession(for: .sleepTracking)
    }
}
```

### ä¿®å¤ 2ï¼šæ›´æ–° WhiteNoisePlayer

åœ¨ `WhiteNoisePlayer.swift` ä¸­æ›´æ–°éŸ³é¢‘ä¼šè¯ç®¡ç†ï¼š

```swift
// æ›¿æ¢ setupAudioSession() æ–¹æ³•
private func setupAudioSession() {
    // ä½¿ç”¨ AudioSessionManager è¯·æ±‚éŸ³é¢‘ä¼šè¯
    AudioSessionManager.shared.requestAudioSession(for: .whiteNoise)
    print("ğŸ”Š ç™½å™ªéŸ³æ’­æ”¾å™¨éŸ³é¢‘ä¼šè¯é…ç½®æˆåŠŸ - æ”¯æŒåå°æ’­æ”¾ï¼ˆç‹¬å æ¨¡å¼ï¼‰")
}

// åœ¨ play() æ–¹æ³•ä¸­æ·»åŠ 
func play(whiteNoise: WhiteNoise) {
    // ... ç°æœ‰ä»£ç  ...

    // ç¡®ä¿éŸ³é¢‘ä¼šè¯æ¿€æ´»
    AudioSessionManager.shared.requestAudioSession(for: .whiteNoise)

    // ... ç°æœ‰ä»£ç  ...
}

// åœ¨ stop() æ–¹æ³•ä¸­æ›´æ–°
func stop() {
    player?.pause()
    removeTimeObserver()
    cancelSleepTimer()
    stopPlaybackMonitor()
    player = nil
    isPlaying = false
    progress = 0.0
    currentTime = 0
    duration = 0
    hasRecordedPlay = false
    loadedArtworkUrl = nil

    // æ¸…é™¤ Now Playing ä¿¡æ¯
    MPNowPlayingInfoCenter.default().nowPlayingInfo = nil

    // é‡Šæ”¾éŸ³é¢‘ä¼šè¯
    AudioSessionManager.shared.releaseAudioSession(for: .whiteNoise)
}
```

### ä¿®å¤ 3ï¼šæ›´æ–°å…¶ä»–éŸ³é¢‘ç»„ä»¶

#### AudioRecordingManager

```swift
// åœ¨ startRecording() ä¸­
func startRecording() async -> Bool {
    // ... æƒé™æ£€æŸ¥ä»£ç  ...

    do {
        // ä½¿ç”¨ AudioSessionManager è¯·æ±‚éŸ³é¢‘ä¼šè¯
        AudioSessionManager.shared.requestAudioSession(for: .audioRecording)

        // ... åˆ›å»ºå½•éŸ³å™¨ä»£ç  ...
    }
}

// åœ¨ stopRecording() ä¸­
func stopRecording() -> URL? {
    // ... ç°æœ‰ä»£ç  ...

    // é‡Šæ”¾éŸ³é¢‘ä¼šè¯
    AudioSessionManager.shared.releaseAudioSession(for: .audioRecording)

    // ... è¿”å› URL ä»£ç  ...
}
```

#### AudioMessageManager

```swift
// åœ¨ setupAudioSession() ä¸­
private func setupAudioSession() {
    AudioSessionManager.shared.requestAudioSession(for: .audioMessage)
}

// åœ¨ stopAudio() ä¸­
func stopAudio() {
    // ... ç°æœ‰ä»£ç  ...

    // é‡Šæ”¾éŸ³é¢‘ä¼šè¯
    AudioSessionManager.shared.releaseAudioSession(for: .audioMessage)
}
```

#### WorkoutAudioPlayer

```swift
// åœ¨ setupAudioSession() ä¸­
private func setupAudioSession() {
    AudioSessionManager.shared.requestAudioSession(for: .workoutAudio)
}

// åœ¨ stopCurrentAudio() ä¸­
private func stopCurrentAudio() {
    // ... ç°æœ‰ä»£ç  ...

    // é‡Šæ”¾éŸ³é¢‘ä¼šè¯
    AudioSessionManager.shared.releaseAudioSession(for: .workoutAudio)
}
```

## æµ‹è¯•æ­¥éª¤

1. **æ„å»ºå¹¶è¿è¡Œåº”ç”¨**
2. **æµ‹è¯•ç™½å™ªéŸ³åå°æ’­æ”¾**
   - æ‰“å¼€ç™½å™ªéŸ³é¡µé¢
   - å¼€å§‹æ’­æ”¾ç™½å™ªéŸ³
   - æŒ‰ Home é”®åˆ‡åˆ°åå°
   - éªŒè¯éŸ³é¢‘ç»§ç»­æ’­æ”¾
   - æ£€æŸ¥é”å±ç•Œé¢æ˜¾ç¤ºæ’­æ”¾æ§åˆ¶

3. **æµ‹è¯•éŸ³é¢‘ç»„ä»¶åˆ‡æ¢**
   - ç™½å™ªéŸ³æ’­æ”¾ä¸­ï¼Œå½•åˆ¶è¯­éŸ³æ¶ˆæ¯
   - éªŒè¯å½•éŸ³å®Œæˆåç™½å™ªéŸ³æ¢å¤æ’­æ”¾
   - ç™½å™ªéŸ³æ’­æ”¾ä¸­ï¼Œæ’­æ”¾è¯­éŸ³æ¶ˆæ¯
   - éªŒè¯è¯­éŸ³æ’­æ”¾å®Œæˆåç™½å™ªéŸ³æ¢å¤æ’­æ”¾

4. **æµ‹è¯•ä¼˜å…ˆçº§**
   - ç™½å™ªéŸ³æ’­æ”¾ä¸­ï¼Œå¼€å§‹è¿åŠ¨
   - éªŒè¯è¿åŠ¨éŸ³é¢‘æ˜¯å¦æ­£ç¡®æ’­æ”¾
   - éªŒè¯è¿åŠ¨ç»“æŸåç™½å™ªéŸ³æ¢å¤

## é¢„æœŸç»“æœ

âœ… ç™½å™ªéŸ³åœ¨åå°æŒç»­æ’­æ”¾
âœ… é”å±ç•Œé¢æ˜¾ç¤ºæ’­æ”¾æ§åˆ¶
âœ… å…¶ä»–éŸ³é¢‘ç»„ä»¶ä½¿ç”¨å®Œåç™½å™ªéŸ³è‡ªåŠ¨æ¢å¤
âœ… ä¸åŒç»„ä»¶ä¹‹é—´ä¸ä¼šç›¸äº’å¹²æ‰°
âœ… æ§åˆ¶å°æ—¥å¿—æ¸…æ™°æ˜¾ç¤ºéŸ³é¢‘ä¼šè¯åˆ‡æ¢è¿‡ç¨‹

## å›æ»šæ–¹æ¡ˆ

å¦‚æœä¿®å¤åå‡ºç°é—®é¢˜ï¼Œå¯ä»¥ï¼š
1. è¿˜åŸåˆ°åŸå§‹ä»£ç 
2. ä»…åº”ç”¨æ–¹æ¡ˆ 2ï¼ˆWhiteNoisePlayer ä¿®å¤ï¼‰
3. é€ä¸ªç»„ä»¶åº”ç”¨ä¿®å¤ï¼Œä¾¿äºå®šä½é—®é¢˜

## æ³¨æ„äº‹é¡¹

1. **çœŸæœºæµ‹è¯•**ï¼šåå°éŸ³é¢‘æ’­æ”¾å¿…é¡»åœ¨çœŸæœºä¸Šæµ‹è¯•ï¼Œæ¨¡æ‹Ÿå™¨å¯èƒ½è¡¨ç°ä¸ä¸€è‡´
2. **iOS ç‰ˆæœ¬**ï¼šä¸åŒ iOS ç‰ˆæœ¬çš„éŸ³é¢‘ä¼šè¯è¡Œä¸ºå¯èƒ½ç•¥æœ‰å·®å¼‚
3. **åå°æ—¶é—´é™åˆ¶**ï¼šå¦‚æœåº”ç”¨åœ¨åå°ä¸æ’­æ”¾éŸ³é¢‘ï¼Œç³»ç»Ÿä¼šåœ¨ 3 åˆ†é’Ÿåæš‚åœåº”ç”¨
4. **ç”µæ± ä¼˜åŒ–**ï¼šé•¿æ—¶é—´åå°æ’­æ”¾ä¼šæ¶ˆè€—ç”µæ± ï¼Œå»ºè®®æç¤ºç”¨æˆ·

## ç›¸å…³æ–‡æ¡£

- [Apple: Background Execution](https://developer.apple.com/documentation/avfoundation/media_playback/configuring_your_app_for_background_audio)
- [Apple: AVAudioSession](https://developer.apple.com/documentation/avfaudio/avaudiosession)
- [Apple: Audio Session Categories](https://developer.apple.com/documentation/avfaudio/avaudiosession/category)

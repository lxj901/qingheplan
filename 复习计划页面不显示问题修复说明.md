# å¤ä¹ è®¡åˆ’é¡µé¢ä¸æ˜¾ç¤ºé—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ“‹ é—®é¢˜æè¿°

å¤ä¹ è®¡åˆ’é¡µé¢ï¼ˆ`ReviewPlanView`ï¼‰ä¸æ˜¾ç¤ºç”¨æˆ·åˆ›å»ºçš„å¤ä¹ è®¡åˆ’æ•°æ®ã€‚

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

åœ¨ `ReviewViewModel.swift` ä¸­ï¼Œè·å–ç”¨æˆ· ID çš„æ–¹å¼ä¸é¡¹ç›®å…¶ä»–åœ°æ–¹ä¸ä¸€è‡´ï¼š

**é—®é¢˜ä»£ç ï¼š**
```swift
// ReviewViewModel.swift ç¬¬ 60 è¡Œ
guard let userId = AuthManager.shared.currentUser?.id else {
    errorMessage = "ç”¨æˆ·æœªç™»å½•"
    isLoading = false
    return
}
```

**æ­£ç¡®æ–¹å¼ï¼ˆå‚è€ƒ ClassicsReadingView.swiftï¼‰ï¼š**
```swift
guard let userId = AuthManager.shared.getCurrentUserId() else {
    errorMessage = "ç”¨æˆ·æœªç™»å½•"
    isLoading = false
    return
}
```

### ä¸ºä»€ä¹ˆä¼šå‡ºç°é—®é¢˜ï¼Ÿ

1. **`currentUser?.id`** - ä¾èµ–äº `AuthUser` å¯¹è±¡ï¼Œå¯èƒ½åœ¨æŸäº›æƒ…å†µä¸‹ä¸º `nil`
2. **`getCurrentUserId()`** - ç›´æ¥ä» UserDefaults è¯»å–ï¼Œæ›´å¯é ä¸”ä¸é¡¹ç›®å…¶ä»–åœ°æ–¹ä¿æŒä¸€è‡´

### å¯¹æ¯”é¡¹ç›®ä¸­çš„å…¶ä»–å®ç°

åœ¨ `ClassicsReadingView.swift` ä¸­ï¼Œæ‰€æœ‰å¤ä¹ è®¡åˆ’ç›¸å…³çš„ API è°ƒç”¨éƒ½ä½¿ç”¨äº† `getCurrentUserId()`ï¼š

```swift
// åŠ è½½å¤ä¹ è®¡åˆ’æ•°æ®
private func loadReviewPlans(bookId: String) async {
    guard let userId = AuthManager.shared.getCurrentUserId() else {
        print("âš ï¸ ç”¨æˆ·æœªç™»å½•ï¼Œè·³è¿‡åŠ è½½å¤ä¹ è®¡åˆ’")
        return
    }
    // ...
}

// åˆ›å»ºå¤ä¹ è®¡åˆ’
private func createReviewPlan(excerpt: String, range: NSRange, sectionId: String) {
    guard let userId = AuthManager.shared.getCurrentUserId() else {
        toastMessage = "è¯·å…ˆç™»å½•"
        showToast = true
        return
    }
    // ...
}
```

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹æ–‡ä»¶ï¼š`qinghe/ /qinghe/qinghe/ReviewViewModel.swift`

#### 1. ä¿®æ”¹ `loadReviewList` æ–¹æ³•ï¼ˆç¬¬ 60 è¡Œï¼‰

**ä¿®æ”¹å‰ï¼š**
```swift
guard let userId = AuthManager.shared.currentUser?.id else {
    errorMessage = "ç”¨æˆ·æœªç™»å½•"
    isLoading = false
    return
}
```

**ä¿®æ”¹åï¼š**
```swift
guard let userId = AuthManager.shared.getCurrentUserId() else {
    print("âš ï¸ å¤ä¹ è®¡åˆ’ï¼šç”¨æˆ·æœªç™»å½•")
    errorMessage = "ç”¨æˆ·æœªç™»å½•"
    isLoading = false
    return
}
```

#### 2. ä¿®æ”¹ `completeReview` æ–¹æ³•ï¼ˆç¬¬ 135 è¡Œï¼‰

**ä¿®æ”¹å‰ï¼š**
```swift
guard let userId = AuthManager.shared.currentUser?.id else {
    errorMessage = "ç”¨æˆ·æœªç™»å½•"
    isLoading = false
    completion(nil)
    return
}
```

**ä¿®æ”¹åï¼š**
```swift
guard let userId = AuthManager.shared.getCurrentUserId() else {
    errorMessage = "ç”¨æˆ·æœªç™»å½•"
    isLoading = false
    completion(nil)
    return
}
```

#### 3. æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

ä¸ºäº†æ›´å¥½åœ°è¿½è¸ªé—®é¢˜ï¼Œåœ¨ `loadReviewList` æ–¹æ³•ä¸­æ·»åŠ äº†è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼š

```swift
print("ğŸ“ å¤ä¹ è®¡åˆ’ï¼šå¼€å§‹åŠ è½½å¤ä¹ åˆ—è¡¨")
print("ğŸ“ è¯·æ±‚ URL: \(urlString)")
print("ğŸ“ å¤ä¹ è®¡åˆ’ï¼šå·²æ·»åŠ è®¤è¯ Token")
print("ğŸ“ å¤ä¹ è®¡åˆ’ API å“åº”: \(jsonString)")
print("âœ… å¤ä¹ è®¡åˆ’ï¼šæˆåŠŸè·å– \(apiResponse.data.count) æ¡å¤ä¹ è®¡åˆ’")
```

## ğŸ”Œ API æ¥å£éªŒè¯

### åç«¯ API æ–‡æ¡£

æ ¹æ® `qinghe/ /qinghe/åç«¯ API æ–‡æ¡£/å›½å­¦ç»å…¸ API æ–‡æ¡£.md`ï¼š

**æ¥å£**: `GET /api/v1/classics/review/list`

**æŸ¥è¯¢å‚æ•°**:
- `userId`: number - ç”¨æˆ·ID
- `dueOnly`: boolean (å¯é€‰) - åªè·å–åˆ°æœŸçš„å¤ä¹ é¡¹ï¼Œé»˜è®¤ true

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "id": "uuid",
      "sectionId": "uuid",
      "bookId": "lunyu",
      "chapterId": "xueer",
      "original": "å­æ›°ï¼šã€Œå­¦è€Œæ—¶ä¹ ä¹‹...",
      "nextReviewAt": "2024-10-19T10:00:00.000Z",
      "reviewCount": 3,
      "interval": 7
    }
  ]
}
```

### å‰ç«¯å®ç°éªŒè¯

âœ… **API æ¥å£åœ°å€æ­£ç¡®**ï¼š`GET /api/v1/classics/review/list`  
âœ… **è¯·æ±‚å‚æ•°æ­£ç¡®**ï¼š`userId` å’Œ `dueOnly` å‚æ•°éƒ½æœ‰ä¼ é€’  
âœ… **è®¤è¯ Token æ­£ç¡®**ï¼šä½¿ç”¨äº† `AuthManager.shared.getToken()`  
âœ… **æ•°æ®æ¨¡å‹åŒ¹é…**ï¼š`ReviewItem` æ¨¡å‹ä¸ API å“åº”ç»“æ„ä¸€è‡´  

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. ç¼–è¯‘é¡¹ç›®

```bash
cd "qinghe/ /qinghe"
xcodebuild -project qinghe.xcodeproj -scheme qinghe -configuration Debug -sdk iphonesimulator clean build CODE_SIGNING_ALLOWED=NO
```

**ç»“æœ**: âœ… ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯

### 2. è¿è¡Œåº”ç”¨æµ‹è¯•

1. **ç™»å½•åº”ç”¨**
   - ç¡®ä¿ç”¨æˆ·å·²ç™»å½•
   - æ£€æŸ¥ `AuthManager.shared.getCurrentUserId()` è¿”å›æœ‰æ•ˆçš„ç”¨æˆ· ID

2. **åˆ›å»ºå¤ä¹ è®¡åˆ’**
   - è¿›å…¥å›½å­¦ä¹¦æ–‹
   - æ‰“å¼€ä»»æ„ä¹¦ç±ç« èŠ‚
   - é•¿æŒ‰å¥æ®µï¼Œé€‰æ‹©"æ·»åŠ åˆ°å¤ä¹ è®¡åˆ’"
   - è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—ï¼Œç¡®è®¤ API è°ƒç”¨æˆåŠŸ

3. **æŸ¥çœ‹å¤ä¹ è®¡åˆ’é¡µé¢**
   - ä»å›½å­¦ä¹¦æ–‹é¦–é¡µç‚¹å‡»"å¤ä¹ è®¡åˆ’"å…¥å£
   - è¿›å…¥ `ReviewPlanView`
   - è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—ï¼š
     ```
     ğŸ“ å¤ä¹ è®¡åˆ’ï¼šå¼€å§‹åŠ è½½å¤ä¹ åˆ—è¡¨
     ğŸ“ è¯·æ±‚ URL: https://api.qinghejihua.com.cn/api/v1/classics/review/list?userId=xxx&dueOnly=false
     ğŸ“ å¤ä¹ è®¡åˆ’ï¼šå·²æ·»åŠ è®¤è¯ Token
     ğŸ“ å¤ä¹ è®¡åˆ’ API å“åº”: {...}
     âœ… å¤ä¹ è®¡åˆ’ï¼šæˆåŠŸè·å– X æ¡å¤ä¹ è®¡åˆ’
     ```

4. **éªŒè¯æ•°æ®æ˜¾ç¤º**
   - æ£€æŸ¥"ä»Šæ—¥å¾…å¤ä¹ "åŒºåŸŸæ˜¯å¦æ˜¾ç¤ºåˆ°æœŸçš„å¤ä¹ é¡¹
   - æ£€æŸ¥"æœªæ¥å¤ä¹ è®¡åˆ’"åŒºåŸŸæ˜¯å¦æ˜¾ç¤ºæœªåˆ°æœŸçš„å¤ä¹ é¡¹
   - ç‚¹å‡»å¤ä¹ é¡¹ï¼Œè¿›å…¥è¯¦æƒ…é¡µ
   - å®Œæˆå¤ä¹ ï¼ŒéªŒè¯æ•°æ®æ›´æ–°

### 3. è°ƒè¯•æ—¥å¿—è¯´æ˜

å¦‚æœå¤ä¹ è®¡åˆ’ä»ç„¶ä¸æ˜¾ç¤ºï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ï¼š

- âš ï¸ **"ç”¨æˆ·æœªç™»å½•"** - ç”¨æˆ·æœªç™»å½•æˆ– Token å·²è¿‡æœŸ
- âš ï¸ **"æœªæ‰¾åˆ°è®¤è¯ Token"** - Token è·å–å¤±è´¥
- âŒ **"ç½‘ç»œé”™è¯¯"** - ç½‘ç»œè¿æ¥é—®é¢˜
- âŒ **"API è¿”å›é”™è¯¯"** - åç«¯ API è¿”å›é”™è¯¯
- âŒ **"æ•°æ®è§£æå¤±è´¥"** - å“åº”æ•°æ®æ ¼å¼ä¸åŒ¹é…

## ğŸ“ ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
- `qinghe/ /qinghe/qinghe/ReviewViewModel.swift`

### å‚è€ƒæ–‡ä»¶
- `qinghe/ /qinghe/qinghe/ClassicsReadingView.swift` - å‚è€ƒäº†æ­£ç¡®çš„ç”¨æˆ· ID è·å–æ–¹å¼
- `qinghe/ /qinghe/qinghe/AuthManager.swift` - è®¤è¯ç®¡ç†å™¨
- `qinghe/ /qinghe/qinghe/ClassicsAPIService.swift` - API æœåŠ¡
- `qinghe/ /qinghe/åç«¯ API æ–‡æ¡£/å›½å­¦ç»å…¸ API æ–‡æ¡£.md` - API æ–‡æ¡£

## ğŸ¯ æ€»ç»“

### ä¿®å¤å†…å®¹
1. âœ… å°† `currentUser?.id` æ”¹ä¸º `getCurrentUserId()`ï¼Œä¸é¡¹ç›®å…¶ä»–åœ°æ–¹ä¿æŒä¸€è‡´
2. âœ… æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—ï¼Œä¾¿äºè¿½è¸ªé—®é¢˜
3. âœ… éªŒè¯ API æ¥å£å®ç°ä¸æ–‡æ¡£ä¸€è‡´

### é¢„æœŸæ•ˆæœ
- å¤ä¹ è®¡åˆ’é¡µé¢èƒ½å¤Ÿæ­£ç¡®åŠ è½½å¹¶æ˜¾ç¤ºç”¨æˆ·çš„å¤ä¹ è®¡åˆ’
- ä»Šæ—¥å¾…å¤ä¹ å’Œæœªæ¥å¤ä¹ è®¡åˆ’æ­£ç¡®åˆ†ç»„æ˜¾ç¤º
- å®Œæˆå¤ä¹ åæ•°æ®æ­£ç¡®æ›´æ–°

### åç»­å»ºè®®
1. å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œæ£€æŸ¥åç«¯ API æ˜¯å¦æ­£å¸¸è¿”å›æ•°æ®
2. ä½¿ç”¨ Postman æˆ– curl ç›´æ¥æµ‹è¯• API æ¥å£
3. æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰è¯¥ç”¨æˆ·çš„å¤ä¹ è®¡åˆ’è®°å½•

## ğŸ“… ä¿®å¤æ—¥æœŸ

- **ä¿®å¤æ—¥æœŸ**: 2025-10-21
- **ä¿®å¤ç‰ˆæœ¬**: 1.2.1
- **ç›¸å…³é—®é¢˜**: å¤ä¹ è®¡åˆ’é¡µé¢ä¸æ˜¾ç¤ºæ•°æ®


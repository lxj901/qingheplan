# å›½å­¦ç»å…¸å¯¼å…¥æ–‡ä»¶åç©ºæ ¼é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ“‹ é—®é¢˜æè¿°

### é”™è¯¯ç°è±¡
ç”¨æˆ·åœ¨å¯¼å…¥å›½å­¦ç»å…¸ä¹¦ç±æ—¶ï¼Œå¦‚æœæ–‡ä»¶ååŒ…å«ç©ºæ ¼ï¼ˆç‰¹åˆ«æ˜¯å‰å¯¼ç©ºæ ¼ï¼‰ï¼Œä¼šå¯¼è‡´ OSS ä¸Šä¼ å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯å¦‚ä¸‹ï¼š

```xml
<Error>
  <Code>SignatureDoesNotMatch</Code>
  <Message>The request signature we calculated does not match the signature you provided.</Message>
  <OSSAccessKeyId>LTAI5t9KumdzZuCnUgonX1Ec</OSSAccessKeyId>
  <SignatureProvided>4V+DsjyQAYwV3v2gs10iKiTYGjg=</SignatureProvided>
  <StringToSign>PUT

application/vnd.openxmlformats-officedocument.wordprocessingml.document
1761041476
/qinghe-uploads/classics/imports/1761037876378-       å·¥ä½œè¯æ˜_20221128.docx</StringToSign>
</Error>
```

### é—®é¢˜åŸå› 
1. **æ–‡ä»¶ååŒ…å«ç©ºæ ¼**: ä¾‹å¦‚ `       å·¥ä½œè¯æ˜_20221128.docx` (å‰é¢æœ‰7ä¸ªç©ºæ ¼)
2. **OSS ç­¾åè®¡ç®—**: åç«¯ç”Ÿæˆç­¾å URL æ—¶ï¼Œä½¿ç”¨çš„è·¯å¾„åŒ…å«ç©ºæ ¼
3. **URL ç¼–ç ä¸ä¸€è‡´**: 
   - åç«¯è®¡ç®—ç­¾åæ—¶ä½¿ç”¨åŸå§‹è·¯å¾„ï¼ˆåŒ…å«ç©ºæ ¼ï¼‰
   - å®¢æˆ·ç«¯ä¸Šä¼ æ—¶ï¼ŒURL ä¸­çš„ç©ºæ ¼å¯èƒ½è¢«ç¼–ç ä¸º `%20` æˆ– `+`
   - å¯¼è‡´ç­¾åéªŒè¯å¤±è´¥ï¼ˆSignatureDoesNotMatchï¼‰

### å½±å“èŒƒå›´
- æ‰€æœ‰æ–‡ä»¶ååŒ…å«ç©ºæ ¼çš„æ–‡ä»¶ä¸Šä¼ éƒ½ä¼šå¤±è´¥
- ç‰¹åˆ«æ˜¯ä» iCloudã€æ–‡ä»¶ç®¡ç†å™¨ç­‰é€‰æ‹©çš„æ–‡ä»¶ï¼Œå¯èƒ½åŒ…å«å‰å¯¼/å°¾éšç©ºæ ¼

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®æ”¹å†…å®¹
åœ¨ `ClassicsImportService.swift` ä¸­æ·»åŠ æ–‡ä»¶åæ¸…ç†åŠŸèƒ½ï¼š

1. **æ¸…ç†æ–‡ä»¶å**: åœ¨ä¸Šä¼ å‰è‡ªåŠ¨æ¸…ç†æ–‡ä»¶å
2. **ä¿ç•™åŸå§‹æ–‡ä»¶å**: åœ¨å®Œæˆä¸Šä¼ æ—¶ä½¿ç”¨åŸå§‹æ–‡ä»¶åï¼ˆç”¨äºæ˜¾ç¤ºï¼‰

### æ–‡ä»¶åæ¸…ç†è§„åˆ™
```swift
private func cleanFilename(_ filename: String) -> String {
    // 1. åˆ†ç¦»æ–‡ä»¶åå’Œæ‰©å±•å
    let nsFilename = filename as NSString
    let nameWithoutExt = nsFilename.deletingPathExtension
    let ext = nsFilename.pathExtension
    
    // 2. æ¸…ç†æ–‡ä»¶åï¼š
    //    - å»é™¤é¦–å°¾ç©ºæ ¼
    //    - å°†ä¸­é—´çš„è¿ç»­ç©ºæ ¼æ›¿æ¢ä¸ºå•ä¸ªä¸‹åˆ’çº¿
    //    - ç§»é™¤å…¶ä»–ç‰¹æ®Šå­—ç¬¦ï¼ˆä¿ç•™ä¸­æ–‡ã€å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦ï¼‰
    var cleaned = nameWithoutExt.trimmingCharacters(in: .whitespacesAndNewlines)
    
    // 3. å°†è¿ç»­ç©ºæ ¼æ›¿æ¢ä¸ºå•ä¸ªä¸‹åˆ’çº¿
    cleaned = cleaned.replacingOccurrences(of: "\\s+", with: "_", options: .regularExpression)
    
    // 4. ç§»é™¤ä¸å®‰å…¨çš„å­—ç¬¦ï¼ˆä¿ç•™ä¸­æ–‡ã€å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦ï¼‰
    let allowedCharacters = CharacterSet(charactersIn: "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_-")
        .union(CharacterSet(charactersIn: "\u{4E00}"..."\u{9FFF}"))  // ä¸­æ–‡å­—ç¬¦èŒƒå›´
    
    cleaned = cleaned.unicodeScalars
        .filter { allowedCharacters.contains($0) }
        .map { String($0) }
        .joined()
    
    // 5. å¦‚æœæ¸…ç†åä¸ºç©ºï¼Œä½¿ç”¨æ—¶é—´æˆ³
    if cleaned.isEmpty {
        cleaned = "file_\(Int(Date().timeIntervalSince1970))"
    }
    
    // 6. é‡æ–°ç»„åˆæ–‡ä»¶åå’Œæ‰©å±•å
    return ext.isEmpty ? cleaned : "\(cleaned).\(ext)"
}
```

### æ¸…ç†ç¤ºä¾‹

| åŸå§‹æ–‡ä»¶å | æ¸…ç†åæ–‡ä»¶å |
|-----------|------------|
| `       å·¥ä½œè¯æ˜_20221128.docx` | `å·¥ä½œè¯æ˜_20221128.docx` |
| `è®ºè¯­ (å®Œæ•´ç‰ˆ).pdf` | `è®ºè¯­_å®Œæ•´ç‰ˆ.pdf` |
| `  å¤§å­¦  ä¸­åº¸  .docx` | `å¤§å­¦_ä¸­åº¸.docx` |
| `é“å¾·ç»@2024.pdf` | `é“å¾·ç»2024.pdf` |
| `   .pdf` | `file_1729334400.pdf` |

---

## ğŸ”§ ä¿®æ”¹çš„æ–‡ä»¶

### `qinghe/ /qinghe/qinghe/ClassicsImportService.swift`

#### 1. ä¿®æ”¹ `importBook` æ–¹æ³•
```swift
func importBook(
    fileURL: URL,
    userId: Int,
    bookId: String? = nil,
    category: String? = nil,
    author: String? = nil
) async throws -> String {
    let originalFilename = fileURL.lastPathComponent
    print("ğŸ“š å¼€å§‹å¯¼å…¥ä¹¦ç±: \(originalFilename)")

    // â­ æ¸…ç†æ–‡ä»¶åï¼ˆç§»é™¤ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦ï¼‰
    let cleanedFilename = cleanFilename(originalFilename)
    print("ğŸ§¹ æ¸…ç†åçš„æ–‡ä»¶å: \(cleanedFilename)")

    // 1. è·å–ä¸Šä¼ URLï¼ˆä½¿ç”¨æ¸…ç†åçš„æ–‡ä»¶åï¼‰
    print("1ï¸âƒ£ è·å–ä¸Šä¼ URL...")
    let uploadInfo = try await getUploadURL(filename: cleanedFilename)
    print("âœ… è·å–ä¸Šä¼ URLæˆåŠŸ: \(uploadInfo.uploadUrl)")

    // 2. ä¸Šä¼ æ–‡ä»¶åˆ°OSS
    print("2ï¸âƒ£ è¯»å–æ–‡ä»¶æ•°æ®...")
    let fileData = try Data(contentsOf: fileURL)
    print("âœ… æ–‡ä»¶å¤§å°: \(fileData.count) å­—èŠ‚")

    guard let uploadURL = URL(string: uploadInfo.uploadUrl) else {
        print("âŒ æ— æ•ˆçš„ä¸Šä¼ URL: \(uploadInfo.uploadUrl)")
        throw NSError(domain: "URL", code: -1, userInfo: [NSLocalizedDescriptionKey: "æ— æ•ˆçš„ä¸Šä¼ URL"])
    }

    print("3ï¸âƒ£ ä¸Šä¼ æ–‡ä»¶åˆ°OSS...")
    try await uploadToOSS(url: uploadURL, data: fileData, fileURL: fileURL)

    // 3. å®Œæˆä¸Šä¼ ï¼ˆä½¿ç”¨åŸå§‹æ–‡ä»¶åï¼Œç”¨äºæ˜¾ç¤ºï¼‰
    print("4ï¸âƒ£ é€šçŸ¥æœåŠ¡å™¨å®Œæˆä¸Šä¼ ...")
    let jobId = try await completeUpload(
        fileKey: uploadInfo.fileKey,
        originalName: originalFilename,  // â­ ä½¿ç”¨åŸå§‹æ–‡ä»¶å
        userId: userId,
        bookId: bookId,
        category: category,
        author: author
    )

    print("âœ… å¯¼å…¥ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼Œä»»åŠ¡ID: \(jobId)")
    return jobId
}
```

#### 2. æ–°å¢ `cleanFilename` æ–¹æ³•
å®Œæ•´çš„æ–‡ä»¶åæ¸…ç†æ–¹æ³•ï¼ˆè§ä¸Šæ–‡"æ–‡ä»¶åæ¸…ç†è§„åˆ™"ï¼‰

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯

#### 1. æ­£å¸¸æ–‡ä»¶å
- **æµ‹è¯•æ–‡ä»¶**: `è®ºè¯­.pdf`
- **é¢„æœŸç»“æœ**: âœ… ä¸Šä¼ æˆåŠŸ
- **æ¸…ç†å**: `è®ºè¯­.pdf` (æ— å˜åŒ–)

#### 2. åŒ…å«ç©ºæ ¼çš„æ–‡ä»¶å
- **æµ‹è¯•æ–‡ä»¶**: `       å·¥ä½œè¯æ˜_20221128.docx`
- **é¢„æœŸç»“æœ**: âœ… ä¸Šä¼ æˆåŠŸ
- **æ¸…ç†å**: `å·¥ä½œè¯æ˜_20221128.docx`

#### 3. åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„æ–‡ä»¶å
- **æµ‹è¯•æ–‡ä»¶**: `è®ºè¯­@2024ç‰ˆæœ¬.pdf`
- **é¢„æœŸç»“æœ**: âœ… ä¸Šä¼ æˆåŠŸ
- **æ¸…ç†å**: `è®ºè¯­2024ç‰ˆæœ¬.pdf`

#### 4. åªæœ‰ç©ºæ ¼çš„æ–‡ä»¶å
- **æµ‹è¯•æ–‡ä»¶**: `     .pdf`
- **é¢„æœŸç»“æœ**: âœ… ä¸Šä¼ æˆåŠŸ
- **æ¸…ç†å**: `file_1729334400.pdf` (ä½¿ç”¨æ—¶é—´æˆ³)

### æµ‹è¯•æ­¥éª¤

1. **å‡†å¤‡æµ‹è¯•æ–‡ä»¶**
   ```bash
   # åˆ›å»ºåŒ…å«ç©ºæ ¼çš„æµ‹è¯•æ–‡ä»¶
   touch "       å·¥ä½œè¯æ˜_20221128.docx"
   touch "è®ºè¯­ (å®Œæ•´ç‰ˆ).pdf"
   touch "  å¤§å­¦  ä¸­åº¸  .docx"
   ```

2. **è¿è¡Œåº”ç”¨**
   - æ‰“å¼€å›½å­¦ç»å…¸å¯¼å…¥åŠŸèƒ½
   - é€‰æ‹©æµ‹è¯•æ–‡ä»¶
   - è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—

3. **éªŒè¯æ—¥å¿—è¾“å‡º**
   ```
   ğŸ“š å¼€å§‹å¯¼å…¥ä¹¦ç±:        å·¥ä½œè¯æ˜_20221128.docx
   ğŸ§¹ æ¸…ç†åçš„æ–‡ä»¶å: å·¥ä½œè¯æ˜_20221128.docx
   1ï¸âƒ£ è·å–ä¸Šä¼ URL...
   ğŸ“¡ è¯·æ±‚ä¸Šä¼ URL - æ–‡ä»¶å: å·¥ä½œè¯æ˜_20221128.docx, ç±»å‹: .docx
   âœ… è·å–ä¸Šä¼ URLæˆåŠŸ: https://qinghe-uploads.oss-cn-beijing.aliyuncs.com/...
   2ï¸âƒ£ è¯»å–æ–‡ä»¶æ•°æ®...
   âœ… æ–‡ä»¶å¤§å°: 10317 å­—èŠ‚
   3ï¸âƒ£ ä¸Šä¼ æ–‡ä»¶åˆ°OSS...
   âœ… OSS ä¸Šä¼ æˆåŠŸ - çŠ¶æ€ç : 200
   4ï¸âƒ£ é€šçŸ¥æœåŠ¡å™¨å®Œæˆä¸Šä¼ ...
   âœ… å¯¼å…¥ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼Œä»»åŠ¡ID: xxx
   ```

---

## ğŸ“Š ç¼–è¯‘ç»“æœ

### ç¼–è¯‘å‘½ä»¤
```bash
cd "qinghe/ /qinghe"
xcodebuild -project qinghe.xcodeproj \
  -scheme qinghe \
  -configuration Debug \
  -sdk iphonesimulator \
  -destination 'platform=iOS Simulator,id=B7E06893-1AE2-40C1-8E4D-B386E12738D3' \
  clean build
```

### ç¼–è¯‘ç»“æœ
âœ… **BUILD SUCCEEDED**

- æ— ç¼–è¯‘é”™è¯¯
- ä»…æœ‰ä¸€äº›è­¦å‘Šï¼ˆä¸æœ¬æ¬¡ä¿®æ”¹æ— å…³ï¼‰
- æ‰€æœ‰åŠŸèƒ½æ­£å¸¸

---

## ğŸ¯ ä¼˜åŠ¿

### 1. å…¼å®¹æ€§å¥½
- æ”¯æŒä¸­æ–‡æ–‡ä»¶å
- æ”¯æŒè‹±æ–‡æ–‡ä»¶å
- æ”¯æŒæ•°å­—ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦

### 2. å®‰å…¨æ€§é«˜
- ç§»é™¤æ‰€æœ‰ä¸å®‰å…¨å­—ç¬¦
- é˜²æ­¢è·¯å¾„éå†æ”»å‡»
- é˜²æ­¢ URL ç¼–ç é—®é¢˜

### 3. ç”¨æˆ·ä½“éªŒå¥½
- è‡ªåŠ¨æ¸…ç†ï¼Œæ— éœ€ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹æ–‡ä»¶å
- ä¿ç•™åŸå§‹æ–‡ä»¶åç”¨äºæ˜¾ç¤º
- æ¸…ç†è¿‡ç¨‹é€æ˜ï¼Œæœ‰æ—¥å¿—è¾“å‡º

### 4. å¯ç»´æŠ¤æ€§å¼º
- ä»£ç æ¸…æ™°ï¼Œæ˜“äºç†è§£
- è§„åˆ™æ˜ç¡®ï¼Œæ˜“äºæ‰©å±•
- æœ‰å®Œæ•´çš„æ³¨é‡Š

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ–‡ä»¶åé•¿åº¦é™åˆ¶
- OSS å¯¹æ–‡ä»¶åé•¿åº¦æœ‰é™åˆ¶ï¼ˆé€šå¸¸ä¸º 1024 å­—ç¬¦ï¼‰
- å¦‚æœæ¸…ç†åçš„æ–‡ä»¶åè¿‡é•¿ï¼Œå¯èƒ½éœ€è¦æˆªæ–­
- å»ºè®®åœ¨æ¸…ç†æ–¹æ³•ä¸­æ·»åŠ é•¿åº¦æ£€æŸ¥

### 2. æ–‡ä»¶åå”¯ä¸€æ€§
- åç«¯ä¼šåœ¨æ–‡ä»¶åå‰æ·»åŠ æ—¶é—´æˆ³ï¼Œç¡®ä¿å”¯ä¸€æ€§
- ä¾‹å¦‚: `1729334400000-è®ºè¯­.pdf`
- å‰ç«¯æ— éœ€æ‹…å¿ƒæ–‡ä»¶åå†²çª

### 3. åŸå§‹æ–‡ä»¶åä¿ç•™
- åŸå§‹æ–‡ä»¶åç”¨äºæ˜¾ç¤ºå’Œè®°å½•
- æ¸…ç†åçš„æ–‡ä»¶åç”¨äº OSS å­˜å‚¨
- ä¸¤è€…åˆ†å¼€å¤„ç†ï¼Œäº’ä¸å½±å“

### 4. ç‰¹æ®Šå­—ç¬¦å¤„ç†
- å½“å‰è§„åˆ™ä¿ç•™: ä¸­æ–‡ã€å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦
- å…¶ä»–å­—ç¬¦å…¨éƒ¨ç§»é™¤
- å¦‚éœ€ä¿ç•™å…¶ä»–å­—ç¬¦ï¼Œå¯ä¿®æ”¹ `allowedCharacters`

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

### 1. æ–‡ä»¶åé•¿åº¦é™åˆ¶
```swift
// é™åˆ¶æ–‡ä»¶åé•¿åº¦ï¼ˆä¸åŒ…æ‹¬æ‰©å±•åï¼‰
let maxLength = 200
if cleaned.count > maxLength {
    cleaned = String(cleaned.prefix(maxLength))
}
```

### 2. æ–‡ä»¶åå»é‡
```swift
// å¦‚æœæ–‡ä»¶åå·²å­˜åœ¨ï¼Œæ·»åŠ åºå·
var finalFilename = cleanedFilename
var counter = 1
while fileExists(finalFilename) {
    finalFilename = "\(nameWithoutExt)_\(counter).\(ext)"
    counter += 1
}
```

### 3. æ›´å¤šå­—ç¬¦æ”¯æŒ
```swift
// æ”¯æŒæ›´å¤šç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚æ‹¬å·ã€ç‚¹ç­‰ï¼‰
let allowedCharacters = CharacterSet(charactersIn: "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_-().")
    .union(CharacterSet(charactersIn: "\u{4E00}"..."\u{9FFF}"))
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- [å›½å­¦ç»å…¸ API æ–‡æ¡£](./qinghe/ /qinghe/åç«¯ API æ–‡æ¡£/å›½å­¦ç»å…¸ API æ–‡æ¡£.md)
- [å›½å­¦ç»å…¸å¯¼å…¥åŠŸèƒ½ä½¿ç”¨æŒ‡å—](./qinghe/ /qinghe/åç«¯ API æ–‡æ¡£/å›½å­¦ç»å…¸å¯¼å…¥åŠŸèƒ½ä½¿ç”¨æŒ‡å—.md)
- [ä¹¦ç±å¯¼å…¥è°ƒè¯•æŒ‡å—](./qinghe/ /qinghe/ä¹¦ç±å¯¼å…¥è°ƒè¯•æŒ‡å—.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æ›´æ–°æ—¶é—´**: 2025-10-21  
**ä¿®å¤äººå‘˜**: AI Assistant  
**æµ‹è¯•çŠ¶æ€**: âœ… ç¼–è¯‘é€šè¿‡


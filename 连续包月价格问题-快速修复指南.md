# 连续包月价格问题 - 快速修复指南

## 🎯 问题总结

**发现的问题**：
- 连续包月套餐在 App Store Connect 中的价格是 **¥198.00**
- 但后端和 StoreKit 配置文件中的价格是 **¥29.9**
- 价格不一致导致真机测试时要求登录 Apple ID

**日志证据**：
```
✅ 找到产品: com.qinghe.qinghe.membership.monthlyv4 - 连续包月
💰 价格: ¥198.00  ← ❌ 这是从 App Store Connect 获取的价格
```

## ⚡ 快速修复步骤

### 步骤 1：修改 App Store Connect 价格

1. **登录 App Store Connect**
   ```
   https://appstoreconnect.apple.com
   ```

2. **导航到产品配置**
   - 我的 App → 青禾计划
   - 左侧菜单 → **App 内购买项目**
   - 找到产品：`com.qinghe.qinghe.membership.monthlyv4`

3. **修改价格**
   - 当前价格：¥198.00
   - 修改为：¥29.9（或选择价格档位 Tier 30）
   - 点击"保存"

4. **等待同步**
   - 通常需要 5-30 分钟
   - 可以在沙盒环境中测试验证

### 步骤 2：验证修复

1. **重新运行应用**
   ```bash
   # 在 Xcode 中
   Product → Clean Build Folder (Cmd + Shift + K)
   Product → Run (Cmd + R)
   ```

2. **查看控制台日志**
   ```
   ✅ 找到产品: com.qinghe.qinghe.membership.monthlyv4 - 连续包月
   💰 价格: ¥29.90  ← ✅ 应该显示正确的价格
   ```

3. **测试购买流程**
   - 点击"连续包月"套餐
   - 应该直接弹出沙盒支付对话框
   - 不应该要求登录 Apple ID

## 🔍 价格档位参考

App Store Connect 使用价格档位（Price Tier）系统：

| 价格档位 | 中国区价格 | 说明 |
|---------|-----------|------|
| Tier 30 | ¥30.00 | 最接近 ¥29.9 |
| Tier 40 | ¥40.00 | 月度会员 |
| Tier 68 | ¥68.00 | 季度会员 |
| Tier 168 | ¥168.00 | 年度会员 |
| Tier 198 | ¥198.00 | 当前错误的价格 |

**建议**：选择 **Tier 30 (¥30.00)** 作为连续包月的价格。

## 📋 完整的价格配置检查清单

### ✅ 需要确认的配置

| 位置 | 产品 ID | 价格 | 状态 |
|------|---------|------|------|
| **后端数据库** | com.qinghe.qinghe.membership.monthlyv4 | ¥29.9 | ✅ 正确 |
| **StoreKit 配置** | com.qinghe.qinghe.membership.monthlyv4 | ¥29.9 | ✅ 正确 |
| **App Store Connect** | com.qinghe.qinghe.membership.monthlyv4 | ¥198.00 | ❌ 需要修改为 ¥30.00 |

### 其他产品价格检查

同时检查其他产品的价格是否一致：

| 产品 | 后端价格 | StoreKit 价格 | App Store Connect 价格 |
|------|---------|--------------|----------------------|
| 连续包月 | ¥29.9 | ¥29.9 | ❌ ¥198.00 → 改为 ¥30.00 |
| 月度会员 | ¥39.9 | ¥39.9 | ✅ ¥39.90 |
| 季度会员 | ¥69.9 | ¥69.9 | ✅ ¥69.90 |
| 年度会员 | ¥169 | ¥169.0 | ✅ ¥169.00 |

## 🚨 注意事项

### 1. 价格修改的影响

- **沙盒环境**：修改后立即生效（5-30分钟）
- **生产环境**：如果产品已上线，价格修改可能需要审核
- **现有用户**：不影响已购买用户的订阅价格

### 2. 产品类型问题

从日志中发现，连续包月的产品类型配置可能不一致：

**后端配置**：
```json
"product_type": "auto_renewable_subscription"  // 自动续期订阅
```

**StoreKit 配置**：
```json
"type": "NonRenewingSubscription"  // 非自动续期订阅 ❌
```

**建议**：
- 如果是"连续包月"（自动续费），应该使用 `AutoRenewableSubscription`
- 需要在 App Store Connect 和 StoreKit 配置中都设置为自动续期订阅

### 3. 测试建议

修改价格后，建议进行以下测试：

- [ ] 模拟器测试（使用 StoreKit 配置文件）
- [ ] 真机沙盒测试（使用沙盒账号）
- [ ] 验证价格显示正确
- [ ] 验证购买流程正常
- [ ] 验证取消购买不显示成功
- [ ] 验证后端验证流程正常

## 🔧 如果修改后仍有问题

### 问题 1：价格仍然显示 ¥198.00

**可能原因**：
- App Store Connect 同步延迟
- 设备缓存了旧的产品信息

**解决方法**：
```bash
# 1. 清理 Xcode 缓存
rm -rf ~/Library/Developer/Xcode/DerivedData

# 2. 重置模拟器
xcrun simctl erase all

# 3. 重新安装应用
```

### 问题 2：仍然要求登录 Apple ID

**可能原因**：
- 产品类型配置不一致
- 沙盒账号未登录

**解决方法**：
1. 在设备上登录沙盒测试账号
   - 设置 → App Store → 沙盒账户
2. 检查产品类型配置
3. 确认 Xcode Scheme 中启用了 StoreKit 配置文件

### 问题 3：取消购买仍显示"购买成功"

**解决方法**：
- 这个问题已经在之前的修复中解决
- 确认使用了最新的代码（包含 `purchaseSuccess` 标志）

## 📞 需要帮助？

如果修改后仍有问题，请提供：

1. **完整的控制台日志**（从应用启动到购买）
2. **App Store Connect 截图**（产品配置页面）
3. **测试环境信息**（模拟器/真机，iOS 版本）

---

## 📝 修复记录

**问题发现时间**：2025-10-13  
**问题类型**：价格配置不一致  
**影响范围**：连续包月套餐（com.qinghe.qinghe.membership.monthlyv4）  
**修复方案**：修改 App Store Connect 中的产品价格  
**预计修复时间**：5-30 分钟（同步时间）

---

## ✅ 修复完成检查清单

完成以下检查后，问题应该已解决：

- [ ] App Store Connect 中的价格已修改为 ¥30.00
- [ ] 等待同步完成（5-30分钟）
- [ ] 重新运行应用，查看日志确认价格正确
- [ ] 测试购买流程，不再要求登录 Apple ID
- [ ] 测试取消购买，不显示"购买成功"
- [ ] 测试完整购买流程，验证后端激活成功
- [ ] 其他套餐的购买流程正常

**全部完成后，问题修复完成！** 🎉

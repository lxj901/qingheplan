# å›½å­¦ç»å…¸æ ‡è®°åŠŸèƒ½é—®é¢˜ä¿®å¤è¯´æ˜

## ä¿®å¤æ—¥æœŸ
2025-10-20

## é—®é¢˜æè¿°

### é—®é¢˜ 1: é«˜äº®åŠŸèƒ½å½±å“æ‰€æœ‰æ–­å¥
**ç°è±¡**: åœ¨ä¸€ä¸ªå¥æ®µæ·»åŠ é«˜äº®åï¼Œå…¶ä»–å¥æ®µä¹Ÿè·Ÿç€æ˜¾ç¤ºé«˜äº®

**åŸå› **:
- åŸæ¥ä½¿ç”¨å…¨å±€æ•°ç»„ `@State private var coloredHighlights: [ColoredHighlight] = []`
- æ‰€æœ‰ section çš„ `SelectableTextView` éƒ½ç»‘å®šåˆ°åŒä¸€ä¸ª `$coloredHighlights`
- å¯¼è‡´ä¸€ä¸ª section çš„é«˜äº®ä¼šæ˜¾ç¤ºåœ¨æ‰€æœ‰ section ä¸Š

### é—®é¢˜ 2: å¤ä¹ è®¡åˆ’å“åº”æ ¼å¼é”™è¯¯
**ç°è±¡**: ç‚¹å‡»å¤ä¹ è®¡åˆ’åæç¤º"å“åº”æ ¼å¼æœ‰è¯¯"

**åŸå› **:
- ä½¿ç”¨ä¸´æ—¶ UUID ä½œä¸º sectionId: `"temp-section-\(UUID().uuidString)"`
- API æ— æ³•æ‰¾åˆ°å¯¹åº”çš„ sectionï¼Œè¿”å›é”™è¯¯æˆ–ç©ºæ•°æ®
- ç¼ºå°‘ sectionId çš„ä¼ é€’é“¾è·¯

## è§£å†³æ–¹æ¡ˆ

### 1. é«˜äº®/ç¬”è®°æ•°æ®ç»“æ„ä¼˜åŒ–

**ä¿®æ”¹å‰**:
```swift
@State private var coloredHighlights: [ColoredHighlight] = []
@State private var notes: [AnnotatedNote] = []
```

**ä¿®æ”¹å**:
```swift
@State private var coloredHighlights: [String: [ColoredHighlight]] = [:]  // æŒ‰ sectionId å­˜å‚¨
@State private var notes: [String: [AnnotatedNote]] = [:]  // æŒ‰ sectionId å­˜å‚¨
```

**ä¼˜ç‚¹**:
- æ¯ä¸ª section ç‹¬ç«‹å­˜å‚¨é«˜äº®å’Œç¬”è®°
- ä¸ä¼šç›¸äº’å½±å“
- æ–¹ä¾¿æŒ‰ sectionId æŸ¥è¯¢å’Œç®¡ç†

### 2. ä¿®æ”¹ createOriginalTextView æ–¹æ³•

ä¸ºæ¯ä¸ª section åˆ›å»ºç‹¬ç«‹çš„é«˜äº®å’Œç¬”è®°ç»‘å®š:

```swift
// è·å–å½“å‰ section çš„é«˜äº®å’Œç¬”è®°
let sectionHighlights = Binding<[ColoredHighlight]>(
    get: { coloredHighlights[section.id] ?? [] },
    set: { coloredHighlights[section.id] = $0 }
)
let sectionNotes = notes[section.id] ?? []

return SelectableTextView(
    attributedText: attributedText,
    coloredHighlights: sectionHighlights,  // ä½¿ç”¨ç‹¬ç«‹ç»‘å®š
    notes: sectionNotes,                    // ä½¿ç”¨ç‹¬ç«‹æ•°ç»„
    ...
)
```

### 3. ä¿®æ”¹é«˜äº®æ·»åŠ é€»è¾‘

**ä¿®æ”¹å‰**:
```swift
if !coloredHighlights.contains(where: { ... }) {
    coloredHighlights.append(ColoredHighlight(range: r, color: uiColor))
}
```

**ä¿®æ”¹å**:
```swift
// åªä¸ºå½“å‰ section æ·»åŠ é«˜äº®
if let sectionId = currentSectionId, let r = pendingRange {
    var sectionHighlights = coloredHighlights[sectionId] ?? []
    if !sectionHighlights.contains(where: { ... }) {
        sectionHighlights.append(ColoredHighlight(range: r, color: uiColor))
        coloredHighlights[sectionId] = sectionHighlights
    }
}
```

### 4. ä¿®æ”¹å¤ä¹ è®¡åˆ’åŠŸèƒ½

**ä¿®æ”¹å‰**:
```swift
private func createReviewPlan(excerpt: String, range: NSRange) {
    let sectionId = "temp-section-\(UUID().uuidString)"  // âŒ é”™è¯¯ï¼šä¸´æ—¶ UUID
    ...
}
```

**ä¿®æ”¹å**:
```swift
// åœ¨è°ƒç”¨æ—¶ä¼ é€’çœŸå®çš„ sectionId
onReviewPlan: { excerpt, range in
    currentSectionId = section.id
    createReviewPlan(excerpt: excerpt, range: range, sectionId: section.id)
}

// æ–¹æ³•ç­¾åæ·»åŠ  sectionId å‚æ•°
private func createReviewPlan(excerpt: String, range: NSRange, sectionId: String) {
    // ä½¿ç”¨çœŸå®çš„ sectionId
    let body: [String: Any] = [
        "userId": userId,
        "sectionId": sectionId  // âœ… ä½¿ç”¨çœŸå® ID
    ]
}
```

### 5. æ·»åŠ è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯

```swift
// æ‰“å°åŸå§‹å“åº”
if let jsonString = String(data: data, encoding: .utf8) {
    print("ğŸ“ å¤ä¹ è®¡åˆ’ API å“åº”: \(jsonString)")
}

// åˆ†æ­¥æ£€æŸ¥å“åº”å­—æ®µ
guard let code = json["code"] as? Int else {
    toastMessage = "å“åº”æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘ code å­—æ®µ"
    return
}

guard let responseData = json["data"] as? [String: Any] else {
    print("âŒ data å­—æ®µå†…å®¹: \(json["data"] ?? "nil")")
    return
}
```

### 6. ä¿®å¤ç¬”è®°åˆ é™¤åŠŸèƒ½

**ä¿®æ”¹å‰**:
```swift
private func deleteNote(_ note: AnnotatedNote) {
    notes.removeAll { $0.id == note.id }  // âŒ notes ç°åœ¨æ˜¯å­—å…¸
}
```

**ä¿®æ”¹å**:
```swift
private func deleteNote(_ note: AnnotatedNote) {
    // ä»æ‰€æœ‰ section çš„ç¬”è®°ä¸­æŸ¥æ‰¾å¹¶åˆ é™¤
    for (sectionId, var sectionNotes) in notes {
        if let index = sectionNotes.firstIndex(where: { $0.id == note.id }) {
            sectionNotes.remove(at: index)
            notes[sectionId] = sectionNotes
            break
        }
    }
    viewingNote = nil
}
```

### 7. ä¿®å¤å–æ¶ˆé«˜äº®åŠŸèƒ½

**ä¿®æ”¹å‰**:
```swift
coloredHighlights.removeAll { $0.range.location == r.location ... }
```

**ä¿®æ”¹å**:
```swift
if let sectionId = currentSectionId, let r = pendingRange {
    var sectionHighlights = coloredHighlights[sectionId] ?? []
    sectionHighlights.removeAll { $0.range.location == r.location ... }
    coloredHighlights[sectionId] = sectionHighlights
}
```

## ä¿®æ”¹æ–‡ä»¶æ¸…å•

### ClassicsReadingView.swift
1. **ç¬¬ 65-67 è¡Œ**: ä¿®æ”¹æ•°æ®ç»“æ„ï¼Œæ”¹ä¸ºå­—å…¸ç±»å‹
2. **ç¬¬ 217-227 è¡Œ**: ä¿®å¤ `deleteNote` æ–¹æ³•
3. **ç¬¬ 881-943 è¡Œ**: ä¿®æ”¹ `createOriginalTextView` æ–¹æ³•
4. **ç¬¬ 1172-1204 è¡Œ**: ä¿®æ”¹ `highlightColorOption` æ–¹æ³•
5. **ç¬¬ 1137-1143 è¡Œ**: ä¿®å¤å–æ¶ˆé«˜äº®åŠŸèƒ½
6. **ç¬¬ 1291-1312 è¡Œ**: ä¿®å¤ç¬”è®°ä¿å­˜æŒ‰é’®
7. **ç¬¬ 1450-1455 è¡Œ**: ä¿®æ”¹ `addNote` æ–¹æ³•
8. **ç¬¬ 1504-1605 è¡Œ**: ä¿®å¤å¤ä¹ è®¡åˆ’åŠŸèƒ½å¹¶æ·»åŠ è°ƒè¯•ä¿¡æ¯

## æµ‹è¯•å»ºè®®

### 1. é«˜äº®åŠŸèƒ½æµ‹è¯•
- âœ… æµ‹è¯•åœ¨ä¸åŒå¥æ®µæ·»åŠ é«˜äº®
- âœ… éªŒè¯é«˜äº®åªæ˜¾ç¤ºåœ¨å¯¹åº”å¥æ®µ
- âœ… æµ‹è¯•å–æ¶ˆé«˜äº®åŠŸèƒ½
- âœ… æµ‹è¯•ä¸åŒé¢œè‰²çš„é«˜äº®

### 2. ç¬”è®°åŠŸèƒ½æµ‹è¯•
- âœ… æµ‹è¯•åœ¨ä¸åŒå¥æ®µæ·»åŠ ç¬”è®°
- âœ… éªŒè¯ç¬”è®°åªå…³è”å¯¹åº”å¥æ®µ
- âœ… æµ‹è¯•ç¬”è®°çš„æŸ¥çœ‹å’Œåˆ é™¤
- âœ… æµ‹è¯•ç¬”è®°å­—æ•°é™åˆ¶

### 3. å¤ä¹ è®¡åˆ’æµ‹è¯•
- âœ… æµ‹è¯•åˆ›å»ºå¤ä¹ è®¡åˆ’
- âœ… æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ç¡®è®¤ sectionId æ­£ç¡®
- âœ… éªŒè¯ API å“åº”æ ¼å¼
- âœ… æµ‹è¯•é”™è¯¯æç¤ºä¿¡æ¯

### 4. æ•°æ®éš”ç¦»æµ‹è¯•
- âœ… åœ¨å¤šä¸ªå¥æ®µåˆ†åˆ«æ·»åŠ æ ‡è®°
- âœ… éªŒè¯æ ‡è®°æ•°æ®ç›¸äº’ç‹¬ç«‹
- âœ… åˆ‡æ¢ç« èŠ‚åéªŒè¯æ ‡è®°æ­£ç¡®åŠ è½½

## é¢„æœŸæ•ˆæœ

### ä¿®å¤åçš„è¡Œä¸º

1. **é«˜äº®åŠŸèƒ½**:
   - åœ¨ç¬¬ 1 æ®µæ·»åŠ é»„è‰²é«˜äº® â†’ åªåœ¨ç¬¬ 1 æ®µæ˜¾ç¤º
   - åœ¨ç¬¬ 2 æ®µæ·»åŠ ç»¿è‰²é«˜äº® â†’ åªåœ¨ç¬¬ 2 æ®µæ˜¾ç¤º
   - ä¸¤ä¸ªé«˜äº®äº’ä¸å½±å“

2. **ç¬”è®°åŠŸèƒ½**:
   - åœ¨ç¬¬ 1 æ®µæ·»åŠ ç¬”è®° â†’ ç¬”è®°åªå…³è”ç¬¬ 1 æ®µ
   - åœ¨ç¬¬ 2 æ®µæ·»åŠ ç¬”è®° â†’ ç¬”è®°åªå…³è”ç¬¬ 2 æ®µ
   - åˆ é™¤ç¬”è®°åªå½±å“å¯¹åº”å¥æ®µ

3. **å¤ä¹ è®¡åˆ’**:
   - ç‚¹å‡»å¤ä¹ è®¡åˆ’ â†’ ä½¿ç”¨çœŸå® sectionId
   - API è°ƒç”¨æˆåŠŸ â†’ æ˜¾ç¤º"å·²åŠ å…¥å¤ä¹ è®¡åˆ’"
   - API è°ƒç”¨å¤±è´¥ â†’ æ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯
   - æ§åˆ¶å°è¾“å‡ºè¯¦ç»†è°ƒè¯•ä¿¡æ¯

## æ³¨æ„äº‹é¡¹

1. **æ•°æ®è¿ç§»**: å¦‚æœä¹‹å‰æœ‰æœ¬åœ°ç¼“å­˜çš„é«˜äº®/ç¬”è®°æ•°æ®ï¼Œéœ€è¦æ¸…é™¤æˆ–è¿ç§»åˆ°æ–°æ ¼å¼

2. **æ€§èƒ½è€ƒè™‘**: ä½¿ç”¨å­—å…¸å­˜å‚¨åï¼ŒæŸ¥è¯¢æ•ˆç‡æ›´é«˜ï¼Œä½†éœ€è¦æ³¨æ„å­—å…¸çš„å†…å­˜å ç”¨

3. **è°ƒè¯•ä¿¡æ¯**: æ·»åŠ äº†è¯¦ç»†çš„ print è¯­å¥ï¼Œç”Ÿäº§ç¯å¢ƒå¯è€ƒè™‘ç§»é™¤æˆ–ä½¿ç”¨æ—¥å¿—ç³»ç»Ÿ

4. **API å…¼å®¹æ€§**: ç¡®ä¿åç«¯ API çš„å“åº”æ ¼å¼ä¸å‰ç«¯æœŸæœ›ä¸€è‡´

## åç»­ä¼˜åŒ–å»ºè®®

1. **æ•°æ®æŒä¹…åŒ–**: å°†æ ‡è®°æ•°æ®ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“ï¼ˆCore Data æˆ– Realmï¼‰
2. **ç¦»çº¿æ”¯æŒ**: æ”¯æŒç¦»çº¿æ·»åŠ æ ‡è®°ï¼Œä¸Šçº¿ååŒæ­¥
3. **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡åˆ é™¤/å¯¼å‡ºæ ‡è®°
4. **æ•°æ®åŒæ­¥**: å®ç°å¤šè®¾å¤‡é—´çš„æ ‡è®°æ•°æ®åŒæ­¥
5. **è§†è§‰åé¦ˆ**: åœ¨å¥æ®µæ—æ˜¾ç¤ºæ ‡è®°çŠ¶æ€ï¼ˆæ”¶è—å›¾æ ‡ã€é«˜äº®æ•°é‡ç­‰ï¼‰

## ç‰ˆæœ¬ä¿¡æ¯

- **ä¿®å¤ç‰ˆæœ¬**: 1.1.0
- **ä¿®å¤æ—¥æœŸ**: 2025-10-20
- **å½±å“èŒƒå›´**: ClassicsReadingView.swift
- **å‘åå…¼å®¹**: å¦ï¼ˆæ•°æ®ç»“æ„å˜æ›´ï¼‰

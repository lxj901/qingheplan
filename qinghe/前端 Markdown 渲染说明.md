# 🎨 健康助手 AI 回复 Markdown 渲染功能

## 📋 功能说明

健康助手的 AI 回复现已支持 **Markdown 格式渲染**，可以显示丰富的文本排版效果，提升用户阅读体验。

## ✨ 支持的 Markdown 语法

### 1. 标题
```markdown
# 一级标题
## 二级标题
### 三级标题
```

### 2. 列表
```markdown
• 项目符号列表（使用 • 或 -）
- 另一个列表项

1. 数字列表项 1
2. 数字列表项 2
```

### 3. 文本样式
```markdown
**粗体文字**
*斜体文字*
```

### 4. 段落
使用空行分隔段落：
```markdown
这是第一段文字。

这是第二段文字。
```

### 5. 链接 ⭐ **新功能**
```markdown
[链接文字](qinghe://post/{postId})
```

**示例**：
```markdown
[1. 八段锦-官方横屏观看跟练版](qinghe://post/1e0c51be-62fb-47ac-be7d-d41564228dc1)
[2. 太极拳](qinghe://post/7cae9b1c-fc43-4b5b-9ded-432a848203b5)
```

**渲染效果**：
- 蓝色文字（`#4A90E2`）
- 带下划线
- 可点击，点击后自动跳转到帖子详情页

## 📱 前端实现

### 核心组件
文件位置：`qinghe/HealthAssistantView.swift`

新增了 `MarkdownTextView` 组件，用于渲染 Markdown 格式的文本。

### 链接点击处理机制

**双重处理机制**：

1. **内部点击处理**（`.onTapGesture`）
   - 用于 Markdown 文本中的链接点击
   - 直接调用 `NavigationManager` 进行导航
   - 无需依赖系统 URL scheme
   - ✅ 在预览环境和真机上都能正常工作

2. **外部 URL 处理**（`.onOpenURL`）
   - 用于从其他应用或系统打开链接
   - 处理 `qinghe://post/{postId}` URL scheme
   - 作为备用方案，提供更好的兼容性

### 渲染效果
- **标题**：使用不同字号和字重显示
  - ## 二级标题：18pt，粗体
  - ### 三级标题：16pt，半粗体
- **列表**：带有蓝色项目符号（•）
- **粗体**：使用加粗字体
- **段落**：自动间距，提升可读性

### 示例代码
```swift
// 在消息气泡中使用
MarkdownTextView(text: displayedText)
    .padding()
    .background(Color.white.opacity(0.7))
    .cornerRadius(16)
```

## 🔧 后端配置

### AI 回复格式要求

后端返回的 `response` 或 `aiReply` 字段应使用 Markdown 格式：

```json
{
  "success": true,
  "data": {
    "response": "## 2. 日常轻度运动\n\n• **散步**：每天30分钟左右的慢走...\n\n• **慢跑/快走**：选择平坦路面..."
  }
}
```

### 推荐格式模板

```markdown
## 主标题

这是一段描述性文字。

### 小标题

• **重点内容**：具体说明文字。

• **另一个重点**：更多说明。

### 注意事项

1. 第一条建议
2. 第二条建议
3. 第三条建议
```

## 📝 注意事项

1. **段落分隔**：段落之间使用 `\n\n`（两个换行符）分隔
2. **列表格式**：每个列表项占一行，前面加 `- ` 或 `• `
3. **粗体标记**：使用 `**文字**` 标记粗体
4. **标题层级**：建议使用 ## 和 ### 层级，避免使用 # 一级标题（太大）

## 🎯 效果展示

### 渲染前（纯文本）
```
2. 日常轻度运动散步：每天30分钟左右的慢走（可分次完成），以身体微微发热、不疲劳为度，逐步提升心肺功能。慢跑/快走：选择平坦路面，速度以能正常说话为宜，避免大汗淋漓。
```

### 渲染后（Markdown）
- **标题**清晰醒目
- **列表项**带有项目符号，层次分明
- **粗体关键词**突出重点
- **段落间距**舒适易读

## ✅ 已实现功能

- [x] 标题渲染（##、###）
- [x] 列表渲染（• 和数字列表）
- [x] 粗体文字渲染
- [x] 段落间距优化
- [x] **链接点击跳转**（qinghe://post/{postId}）
- [x] 自定义 URL Scheme 处理
- [x] 自动导航到帖子详情页

## 🚀 后续优化建议

1. 支持更多 Markdown 语法（引用块、代码块等）
2. 支持表格渲染（如 AI 返回对比表格）
3. 支持图片显示（如需要）
4. 添加文本复制功能
5. 支持其他类型的深度链接（用户主页、话题页等）

## 📚 相关文档

- API 文档：`后端 API 文档/健康管理系统 API 文档.md` 第 7.1 节
- SwiftUI Markdown 官方文档：[AttributedString - Apple Developer](https://developer.apple.com/documentation/foundation/attributedstring)

---

**最后更新**：2025-10-04  
**更新人**：AI Assistant


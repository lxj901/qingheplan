# é’ç¦¾è®¡åˆ’ - å‰ç«¯è‹¹æœå†…è´­(IAP)é›†æˆæŒ‡å—

## ğŸ“± æ¦‚è¿°

æœ¬æ–‡æ¡£ä¸ºå‰ç«¯å¼€å‘è€…æä¾›è‹¹æœå†…è´­åŠŸèƒ½çš„å®Œæ•´é›†æˆæŒ‡å—ï¼ŒåŒ…æ‹¬APIæ¥å£è¯´æ˜ã€è°ƒç”¨æµç¨‹ã€é”™è¯¯å¤„ç†ç­‰ã€‚

---

## ğŸ”‘ APIåŸºç¡€ä¿¡æ¯

### æœåŠ¡å™¨åœ°å€
```
ç”Ÿäº§ç¯å¢ƒ: https://api.qinghejihua.com.cn/api/v1
```

### è®¤è¯æ–¹å¼
å¤§éƒ¨åˆ†æ¥å£éœ€è¦JWT Tokenè®¤è¯ï¼Œè¯·åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ ï¼š
```
Authorization: Bearer <your_jwt_token>
```

---

## ğŸ“‹ å¯ç”¨çš„APIæ¥å£

### 1. è·å–å¯è´­ä¹°çš„äº§å“åˆ—è¡¨ âœ…

**æ¥å£ï¼š** `GET /apple-iap/products`

**è®¤è¯ï¼š** âŒ ä¸éœ€è¦

**ç”¨é€”ï¼š** åœ¨æ˜¾ç¤ºä¼šå‘˜è´­ä¹°é¡µé¢æ—¶è°ƒç”¨ï¼Œè·å–æ‰€æœ‰å¯è´­ä¹°çš„è‹¹æœå†…è´­äº§å“

**è¯·æ±‚ç¤ºä¾‹ï¼š**
```javascript
const response = await fetch('https://api.qinghejihua.com.cn/api/v1/apple-iap/products');
const data = await response.json();
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": [
    {
      "id": 2,
      "product_id": "com.qinghe.qinghe.membership.monthlyv4",
      "product_name": "æ ‡å‡†ä¼šå‘˜ï¼ˆæœˆä»˜ï¼‰",
      "product_description": "æœ€å—æ¬¢è¿çš„æœˆåº¦è®¢é˜…",
      "product_type": "auto_renewable_subscription",
      "display_price": 29.9,
      "price": 29.9,
      "currency": "CNY",
      "has_free_trial": false,
      "is_recommended": false,
      "membership_plan": {
        "id": 2,
        "plan_code": "monthly_auto",
        "plan_name": "è¿ç»­åŒ…æœˆä¼šå‘˜",
        "duration_type": "monthly",
        "duration_months": 1
      }
    },
    {
      "id": 3,
      "product_id": "com.qinghe.qinghe.membership.monthly.autov5",
      "product_name": "é«˜çº§ä¼šå‘˜ï¼ˆæœˆä»˜ï¼‰",
      "product_description": "äº«å—å…¨éƒ¨åŠŸèƒ½çš„æœˆåº¦è®¢é˜…",
      "product_type": "non_renewing_subscription",
      "display_price": 39.9,
      "price": 39.9,
      "currency": "CNY",
      "membership_plan": {
        "id": 3,
        "plan_code": "monthly",
        "plan_name": "æœˆåº¦ä¼šå‘˜",
        "duration_months": 1
      }
    }
  ]
}
```

**å‰ç«¯ä½¿ç”¨åœºæ™¯ï¼š**
- Appå¯åŠ¨æ—¶é¢„åŠ è½½äº§å“åˆ—è¡¨
- è¿›å…¥ä¼šå‘˜è´­ä¹°é¡µé¢æ—¶è·å–æœ€æ–°äº§å“ä¿¡æ¯
- æ ¹æ® `is_recommended` å­—æ®µé«˜äº®æ¨èäº§å“
- æ˜¾ç¤ºä»·æ ¼ã€æè¿°ã€æ˜¯å¦æœ‰å…è´¹è¯•ç”¨ç­‰ä¿¡æ¯

---

### 2. éªŒè¯è‹¹æœæ”¶æ®å¹¶æ¿€æ´»ä¼šå‘˜ â­

**æ¥å£ï¼š** `POST /apple-iap/verify`

**è®¤è¯ï¼š** âœ… éœ€è¦JWT Token

**ç”¨é€”ï¼š** ç”¨æˆ·å®Œæˆè‹¹æœæ”¯ä»˜åï¼Œæäº¤æ”¶æ®æ•°æ®åˆ°æœåŠ¡å™¨è¿›è¡ŒéªŒè¯å¹¶æ¿€æ´»ä¼šå‘˜

**è¯·æ±‚ç¤ºä¾‹ï¼š**
```javascript
// 1. å…ˆé€šè¿‡StoreKitå®Œæˆè´­ä¹°
const transaction = await StoreKit.purchase(productId);

// 2. è·å–æ”¶æ®æ•°æ®
const receiptData = await StoreKit.getReceiptData(); // Base64ç¼–ç çš„æ”¶æ®

// 3. æäº¤åˆ°æœåŠ¡å™¨éªŒè¯
const response = await fetch('https://api.qinghejihua.com.cn/api/v1/apple-iap/verify', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${userToken}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    receiptData: receiptData,
    productId: productId  // ä¾‹å¦‚: "com.qinghe.qinghe.membership.monthlyv4"
  })
});

const data = await response.json();
```

**è¯·æ±‚å‚æ•°ï¼š**
```typescript
{
  receiptData: string;  // Base64ç¼–ç çš„è‹¹æœæ”¶æ®æ•°æ®ï¼ˆå¿…å¡«ï¼‰
  productId: string;    // äº§å“IDï¼ˆå¿…å¡«ï¼‰
}
```

**æˆåŠŸå“åº”ï¼š**
```json
{
  "success": true,
  "message": "è®¢é˜…éªŒè¯æˆåŠŸ",
  "data": {
    "transaction": {
      "id": 123,
      "userId": 1,
      "productId": "com.qinghe.qinghe.membership.monthlyv4",
      "transactionId": "2000000123456789",
      "originalTransactionId": "2000000123456789",
      "purchaseDate": "2025-10-11T10:30:00.000Z",
      "expiresDate": "2025-11-11T10:30:00.000Z",
      "isActive": true,
      "autoRenewStatus": true
    },
    "membership": {
      "plan_name": "è¿ç»­åŒ…æœˆä¼šå‘˜",
      "expires_at": "2025-11-11T10:30:00.000Z",
      "is_active": true
    }
  }
}
```

**é”™è¯¯å“åº”ï¼š**
```json
{
  "success": false,
  "message": "éªŒè¯æ”¶æ®å¤±è´¥",
  "error": "æ”¶æ®æ— æ•ˆæˆ–å·²è¿‡æœŸ"
}
```

**å‰ç«¯å¤„ç†æµç¨‹ï¼š**
```javascript
async function handlePurchase(productId) {
  try {
    // 1. è°ƒç”¨StoreKitå‘èµ·è´­ä¹°
    showLoading('æ­£åœ¨å¤„ç†è´­ä¹°...');
    const transaction = await StoreKit.purchase(productId);
    
    // 2. è·å–æ”¶æ®
    const receiptData = await StoreKit.getReceiptData();
    
    // 3. æäº¤åˆ°æœåŠ¡å™¨éªŒè¯
    updateLoading('æ­£åœ¨éªŒè¯æ”¶æ®...');
    const response = await verifyReceipt(receiptData, productId);
    
    if (response.success) {
      // 4. éªŒè¯æˆåŠŸï¼Œæ›´æ–°æœ¬åœ°ä¼šå‘˜çŠ¶æ€
      await updateLocalMembershipStatus(response.data.membership);
      
      // 5. æ˜¾ç¤ºæˆåŠŸæç¤º
      hideLoading();
      showSuccessAlert('ä¼šå‘˜å¼€é€šæˆåŠŸï¼', response.data.membership);
      
      // 6. è·³è½¬åˆ°ä¼šå‘˜é¡µé¢æˆ–åˆ·æ–°å½“å‰é¡µé¢
      navigateToMembershipPage();
    } else {
      throw new Error(response.message || 'éªŒè¯å¤±è´¥');
    }
  } catch (error) {
    hideLoading();
    showErrorAlert('è´­ä¹°å¤±è´¥', error.message);
    console.error('Purchase failed:', error);
  }
}
```

---

### 3. è·å–ç”¨æˆ·ä¼šå‘˜çŠ¶æ€ âœ…

**æ¥å£ï¼š** `GET /apple-iap/status`

**è®¤è¯ï¼š** âœ… éœ€è¦JWT Token

**ç”¨é€”ï¼š** æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„ä¼šå‘˜çŠ¶æ€

**å‰ç«¯å®ç°çŠ¶æ€ï¼š** âœ… å·²å®ç°
- å®ç°ä½ç½®ï¼š`IAPService.getAppleIAPStatus()`
- ViewModelæ–¹æ³•ï¼š`MembershipViewModel.loadAppleIAPStatus()`
- æ•°æ®æ¨¡å‹ï¼š`AppleIAPStatusResponse` å’Œ `AppleIAPStatusData`

**è¯·æ±‚ç¤ºä¾‹ï¼š**
```javascript
const response = await fetch('https://api.qinghejihua.com.cn/api/v1/apple-iap/status', {
  headers: {
    'Authorization': `Bearer ${userToken}`
  }
});
const data = await response.json();
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": {
    "isMember": true,
    "membership": {
      "user_id": 1,
      "plan_code": "monthly_auto",
      "plan_name": "è¿ç»­åŒ…æœˆä¼šå‘˜",
      "expires_at": "2025-11-11T10:30:00.000Z",
      "is_active": true,
      "auto_renew": true
    },
    "latestTransaction": {
      "productId": "com.qinghe.qinghe.membership.monthlyv4",
      "purchaseDate": "2025-10-11T10:30:00.000Z",
      "expiresDate": "2025-11-11T10:30:00.000Z",
      "autoRenewStatus": true
    }
  }
}
```

**å‰ç«¯ä½¿ç”¨åœºæ™¯ï¼š**
- Appå¯åŠ¨æ—¶æ£€æŸ¥ä¼šå‘˜çŠ¶æ€
- è¿›å…¥ä¼šå‘˜ä¸“å±åŠŸèƒ½å‰éªŒè¯
- æ˜¾ç¤ºä¼šå‘˜æœ‰æ•ˆæœŸå’Œè‡ªåŠ¨ç»­è´¹çŠ¶æ€
- åœ¨ä¸ªäººä¸­å¿ƒæ˜¾ç¤ºä¼šå‘˜ä¿¡æ¯

---

### 4. è·å–ç”¨æˆ·è®¢é˜…å†å² âœ…

**æ¥å£ï¼š** `GET /apple-iap/subscriptions`

**è®¤è¯ï¼š** âœ… éœ€è¦JWT Token

**ç”¨é€”ï¼š** è·å–ç”¨æˆ·çš„æ‰€æœ‰è®¢é˜…è®°å½•

**å‰ç«¯å®ç°çŠ¶æ€ï¼š** âœ… å·²å®ç°
- å®ç°ä½ç½®ï¼š`IAPService.getAppleSubscriptions()`
- ViewModelæ–¹æ³•ï¼š`MembershipViewModel.loadAppleSubscriptions()`
- æ•°æ®æ¨¡å‹ï¼š`AppleSubscriptionsResponse` å’Œ `AppleSubscriptionTransaction`

**è¯·æ±‚ç¤ºä¾‹ï¼š**
```javascript
const response = await fetch('https://api.qinghejihua.com.cn/api/v1/apple-iap/subscriptions', {
  headers: {
    'Authorization': `Bearer ${userToken}`
  }
});
const data = await response.json();
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "transactions": [
    {
      "id": 123,
      "productId": "com.qinghe.qinghe.membership.monthlyv4",
      "transactionId": "2000000123456789",
      "purchaseDate": "2025-10-11T10:30:00.000Z",
      "expiresDate": "2025-11-11T10:30:00.000Z",
      "isActive": true,
      "autoRenewStatus": true,
      "membership": {
        "plan_name": "è¿ç»­åŒ…æœˆä¼šå‘˜",
        "price": 29.9
      }
    }
  ]
}
```

**å‰ç«¯ä½¿ç”¨åœºæ™¯ï¼š**
- åœ¨"æˆ‘çš„è®¢é˜…"é¡µé¢æ˜¾ç¤ºè®¢é˜…å†å²
- æ˜¾ç¤ºç»­è´¹æ—¶é—´ã€åˆ°æœŸæ—¶é—´
- æä¾›å–æ¶ˆç»­è´¹çš„å…¥å£

---

### 5. è·å–äº¤æ˜“å†å²

**æ¥å£ï¼š** `GET /apple-iap/transactions`

**è®¤è¯ï¼š** âœ… éœ€è¦JWT Token

**å‚æ•°ï¼š**
- `page`: é¡µç ï¼ˆé»˜è®¤1ï¼‰
- `limit`: æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤20ï¼‰

**è¯·æ±‚ç¤ºä¾‹ï¼š**
```javascript
const response = await fetch(
  'https://api.qinghejihua.com.cn/api/v1/apple-iap/transactions?page=1&limit=20',
  {
    headers: {
      'Authorization': `Bearer ${userToken}`
    }
  }
);
const data = await response.json();
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": {
    "transactions": [
      {
        "id": 123,
        "transactionId": "2000000123456789",
        "productId": "com.qinghe.qinghe.membership.monthlyv4",
        "productName": "æ ‡å‡†ä¼šå‘˜ï¼ˆæœˆä»˜ï¼‰",
        "price": 29.9,
        "currency": "CNY",
        "purchaseDate": "2025-10-11T10:30:00.000Z",
        "status": "å·²å®Œæˆ"
      }
    ],
    "total": 1,
    "page": 1,
    "limit": 20
  }
}
```

**å‰ç«¯ä½¿ç”¨åœºæ™¯ï¼š**
- åœ¨"äº¤æ˜“è®°å½•"é¡µé¢æ˜¾ç¤ºæ‰€æœ‰è´­ä¹°å†å²
- æ”¯æŒåˆ†é¡µåŠ è½½
- æ˜¾ç¤ºäº¤æ˜“çŠ¶æ€å’Œé‡‘é¢

---

### 6. åˆ·æ–°è®¢é˜…çŠ¶æ€ï¼ˆæ¢å¤è´­ä¹°ï¼‰ âœ…

**æ¥å£ï¼š** `POST /apple-iap/refresh`

**è®¤è¯ï¼š** âœ… éœ€è¦JWT Token

**ç”¨é€”ï¼š** å½“ç”¨æˆ·æ¢è®¾å¤‡æˆ–é‡è£…Appæ—¶ï¼Œæ¢å¤ä¹‹å‰çš„è´­ä¹°è®°å½•

**å‰ç«¯å®ç°çŠ¶æ€ï¼š** âœ… å·²å®ç°
- å®ç°ä½ç½®ï¼š`IAPService.restorePurchases()`
- UIå…¥å£ï¼šä¼šå‘˜ä¸­å¿ƒåº•éƒ¨"æ¢å¤è´­ä¹°"æŒ‰é’®
- å·¥ä½œæµç¨‹ï¼šåŒæ­¥StoreKit â†’ è°ƒç”¨åç«¯API â†’ åˆ·æ–°ä¼šå‘˜çŠ¶æ€

**è¯·æ±‚ç¤ºä¾‹ï¼š**
```javascript
const response = await fetch('https://api.qinghejihua.com.cn/api/v1/apple-iap/refresh', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${userToken}`,
    'Content-Type': 'application/json'
  }
});
const data = await response.json();
```

**æˆåŠŸå“åº”ï¼š**
```json
{
  "success": true,
  "message": "è®¢é˜…çŠ¶æ€å·²æ›´æ–°",
  "data": {
    "isActive": true,
    "expiresDate": "2025-11-11T10:30:00.000Z",
    "autoRenewStatus": true
  }
}
```

**å‰ç«¯ä½¿ç”¨åœºæ™¯ï¼š**
- åœ¨è®¾ç½®é¡µé¢æä¾›"æ¢å¤è´­ä¹°"æŒ‰é’®
- Appé¦–æ¬¡å®‰è£…åç™»å½•æ—¶è‡ªåŠ¨è°ƒç”¨
- ç”¨æˆ·åé¦ˆä¼šå‘˜çŠ¶æ€ä¸å¯¹æ—¶æ‰‹åŠ¨è§¦å‘

---

### 7. å–æ¶ˆè‡ªåŠ¨ç»­è´¹ï¼ˆè®°å½•ç”¨æˆ·æ„æ„¿ï¼‰

**æ¥å£ï¼š** `POST /apple-iap/cancel-renewal`

**è®¤è¯ï¼š** âœ… éœ€è¦JWT Token

**è¯´æ˜ï¼š** 
- è¿™ä¸ªæ¥å£åªè®°å½•ç”¨æˆ·å–æ¶ˆç»­è´¹çš„æ„æ„¿
- çœŸæ­£çš„å–æ¶ˆéœ€è¦ç”¨æˆ·åœ¨App Storeçš„è®¢é˜…ç®¡ç†ä¸­æ“ä½œ
- å‰ç«¯åº”è¯¥å¼•å¯¼ç”¨æˆ·è·³è½¬åˆ°App Storeè®¢é˜…ç®¡ç†é¡µé¢

**è¯·æ±‚ç¤ºä¾‹ï¼š**
```javascript
const response = await fetch('https://api.qinghejihua.com.cn/api/v1/apple-iap/cancel-renewal', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${userToken}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    reason: 'æš‚æ—¶ä¸éœ€è¦ä¼šå‘˜åŠŸèƒ½'  // å¯é€‰ï¼šå–æ¶ˆåŸå› 
  })
});
```

**å‰ç«¯å¤„ç†ï¼š**
```javascript
async function cancelSubscription() {
  try {
    // 1. å…ˆè®°å½•ç”¨æˆ·æ„æ„¿
    await fetch('/api/v1/apple-iap/cancel-renewal', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${userToken}`,
        'Content-Type': 'application/json'
      }
    });
    
    // 2. å¼•å¯¼ç”¨æˆ·åˆ°App Storeå–æ¶ˆ
    Alert.alert(
      'å–æ¶ˆè®¢é˜…',
      'è¯·åœ¨App Storeä¸­ç®¡ç†æ‚¨çš„è®¢é˜…',
      [
        { text: 'å–æ¶ˆ', style: 'cancel' },
        { 
          text: 'å»App Store', 
          onPress: () => {
            // iOS
            Linking.openURL('https://apps.apple.com/account/subscriptions');
          }
        }
      ]
    );
  } catch (error) {
    console.error('Cancel failed:', error);
  }
}
```

---

## ğŸ”„ å®Œæ•´çš„è´­ä¹°æµç¨‹ç¤ºä¾‹

### React Nativeç¤ºä¾‹

```javascript
import React, { useState, useEffect } from 'react';
import { View, Text, Button, Alert, ActivityIndicator } from 'react-native';
import * as StoreKit from 'react-native-iap';

const API_BASE = 'https://api.qinghejihua.com.cn/api/v1';

const MembershipPurchaseScreen = ({ userToken }) => {
  const [products, setProducts] = useState([]);
  const [loading, setLoading] = useState(false);
  const [membershipStatus, setMembershipStatus] = useState(null);

  // 1. é¡µé¢åŠ è½½æ—¶è·å–äº§å“åˆ—è¡¨å’Œä¼šå‘˜çŠ¶æ€
  useEffect(() => {
    loadProducts();
    checkMembershipStatus();
    
    // åˆå§‹åŒ–StoreKit
    StoreKit.initConnection();
    
    return () => {
      StoreKit.endConnection();
    };
  }, []);

  // è·å–äº§å“åˆ—è¡¨
  const loadProducts = async () => {
    try {
      const response = await fetch(`${API_BASE}/apple-iap/products`);
      const data = await response.json();
      
      if (data.success) {
        setProducts(data.data);
      }
    } catch (error) {
      console.error('Failed to load products:', error);
    }
  };

  // æ£€æŸ¥ä¼šå‘˜çŠ¶æ€
  const checkMembershipStatus = async () => {
    try {
      const response = await fetch(`${API_BASE}/apple-iap/status`, {
        headers: {
          'Authorization': `Bearer ${userToken}`
        }
      });
      const data = await response.json();
      
      if (data.success) {
        setMembershipStatus(data.data);
      }
    } catch (error) {
      console.error('Failed to check membership:', error);
    }
  };

  // å¤„ç†è´­ä¹°
  const handlePurchase = async (product) => {
    setLoading(true);
    
    try {
      // 2. è°ƒç”¨StoreKitå‘èµ·è´­ä¹°
      const purchase = await StoreKit.requestPurchase({
        sku: product.product_id,
      });
      
      // 3. è·å–æ”¶æ®
      const receipt = await StoreKit.getReceiptIOS();
      
      // 4. æäº¤åˆ°æœåŠ¡å™¨éªŒè¯
      const response = await fetch(`${API_BASE}/apple-iap/verify`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${userToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          receiptData: receipt,
          productId: product.product_id
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        // 5. è´­ä¹°æˆåŠŸ
        Alert.alert(
          'è´­ä¹°æˆåŠŸ',
          `æ­å–œæ‚¨å¼€é€š${product.product_name}ï¼`,
          [
            {
              text: 'å¥½çš„',
              onPress: () => {
                // åˆ·æ–°ä¼šå‘˜çŠ¶æ€
                checkMembershipStatus();
              }
            }
          ]
        );
        
        // 6. å®Œæˆäº¤æ˜“
        await StoreKit.finishTransaction({ purchase });
      } else {
        throw new Error(data.message || 'éªŒè¯å¤±è´¥');
      }
    } catch (error) {
      Alert.alert('è´­ä¹°å¤±è´¥', error.message);
      console.error('Purchase failed:', error);
    } finally {
      setLoading(false);
    }
  };

  // æ¢å¤è´­ä¹°
  const handleRestore = async () => {
    setLoading(true);
    
    try {
      const response = await fetch(`${API_BASE}/apple-iap/refresh`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${userToken}`
        }
      });
      
      const data = await response.json();
      
      if (data.success) {
        Alert.alert('æ¢å¤æˆåŠŸ', 'æ‚¨çš„è´­ä¹°è®°å½•å·²æ¢å¤');
        checkMembershipStatus();
      } else {
        Alert.alert('æç¤º', 'æœªæ‰¾åˆ°å¯æ¢å¤çš„è´­ä¹°è®°å½•');
      }
    } catch (error) {
      Alert.alert('æ¢å¤å¤±è´¥', error.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <View>
      {/* ä¼šå‘˜çŠ¶æ€æ˜¾ç¤º */}
      {membershipStatus?.isMember && (
        <View>
          <Text>å½“å‰ä¼šå‘˜ï¼š{membershipStatus.membership.plan_name}</Text>
          <Text>
            åˆ°æœŸæ—¶é—´ï¼š{new Date(membershipStatus.membership.expires_at).toLocaleDateString()}
          </Text>
        </View>
      )}

      {/* äº§å“åˆ—è¡¨ */}
      {products.map(product => (
        <View key={product.id}>
          <Text>{product.product_name}</Text>
          <Text>{product.product_description}</Text>
          <Text>Â¥{product.display_price}</Text>
          <Button
            title="ç«‹å³è´­ä¹°"
            onPress={() => handlePurchase(product)}
            disabled={loading}
          />
        </View>
      ))}

      {/* æ¢å¤è´­ä¹°æŒ‰é’® */}
      <Button
        title="æ¢å¤è´­ä¹°"
        onPress={handleRestore}
        disabled={loading}
      />

      {loading && <ActivityIndicator />}
    </View>
  );
};

export default MembershipPurchaseScreen;
```

---

## ğŸ›  å‰ç«¯å¼€å‘ä»»åŠ¡æ¸…å•

### å¿…é¡»å®ç°çš„åŠŸèƒ½

#### 1. ä¼šå‘˜è´­ä¹°é¡µé¢
- [ ] ä»APIè·å–äº§å“åˆ—è¡¨
- [ ] æ˜¾ç¤ºäº§å“åç§°ã€ä»·æ ¼ã€æè¿°
- [ ] é«˜äº®æ˜¾ç¤ºæ¨èäº§å“ï¼ˆ`is_recommended`ï¼‰
- [ ] é›†æˆStoreKitå‘èµ·è´­ä¹°
- [ ] è´­ä¹°æˆåŠŸåè°ƒç”¨éªŒè¯æ¥å£
- [ ] æ˜¾ç¤ºè´­ä¹°è¿›åº¦å’Œç»“æœ

#### 2. ä¼šå‘˜çŠ¶æ€æ˜¾ç¤º
- [ ] åœ¨ä¸ªäººä¸­å¿ƒæ˜¾ç¤ºä¼šå‘˜ä¿¡æ¯
- [ ] æ˜¾ç¤ºä¼šå‘˜åˆ°æœŸæ—¶é—´
- [ ] æ˜¾ç¤ºæ˜¯å¦è‡ªåŠ¨ç»­è´¹
- [ ] æä¾›å–æ¶ˆç»­è´¹çš„å¼•å¯¼

#### 3. æ¢å¤è´­ä¹°åŠŸèƒ½
- [ ] åœ¨è®¾ç½®é¡µé¢æ·»åŠ "æ¢å¤è´­ä¹°"æŒ‰é’®
- [ ] æ¢è®¾å¤‡/é‡è£…åè‡ªåŠ¨å°è¯•æ¢å¤
- [ ] æ˜¾ç¤ºæ¢å¤ç»“æœ

#### 4. è®¢é˜…ç®¡ç†
- [ ] æ˜¾ç¤ºè®¢é˜…å†å²
- [ ] æ˜¾ç¤ºäº¤æ˜“è®°å½•
- [ ] æä¾›è·³è½¬åˆ°App Storeç®¡ç†è®¢é˜…çš„é“¾æ¥

#### 5. é”™è¯¯å¤„ç†
- [ ] ç½‘ç»œé”™è¯¯æç¤º
- [ ] è´­ä¹°å¤±è´¥æç¤º
- [ ] éªŒè¯å¤±è´¥æç¤º
- [ ] é‡è¯•æœºåˆ¶

---

## ğŸ“± iOSåŸç”Ÿå¼€å‘æ³¨æ„äº‹é¡¹

### StoreKité…ç½®

1. **åœ¨App Store Connectä¸­é…ç½®äº§å“ï¼š**
   - Bundle ID: `com.qinghe.qinghe`
   - äº§å“IDéœ€è¦ä¸åç«¯æ•°æ®åº“ä¸­çš„ `product_id` å®Œå…¨ä¸€è‡´

2. **äº§å“IDåˆ—è¡¨ï¼š**
```
com.qinghe.qinghe.membership.monthlyv4      // è¿ç»­åŒ…æœˆ
com.qinghe.qinghe.membership.monthly.autov5 // æœˆåº¦ä¼šå‘˜
com.qinghe.qinghe.membership.monthly.autov6 // å­£åº¦ä¼šå‘˜
com.qinghe.qinghe.membership.monthly.autov7 // å¹´åº¦ä¼šå‘˜
```

3. **Info.plisté…ç½®ï¼š**
```xml
<key>SKAdNetworkItems</key>
<array>
    <!-- æ·»åŠ è‹¹æœçš„å¹¿å‘Šç½‘ç»œID -->
</array>
```

---

## ğŸ§ª æµ‹è¯•æŒ‡å—

### æ²™ç›’ç¯å¢ƒæµ‹è¯•

1. **åˆ›å»ºæ²™ç›’æµ‹è¯•è´¦å·ï¼š**
   - åœ¨App Store Connectä¸­åˆ›å»ºæ²™ç›’æµ‹è¯•è´¦å·
   - åœ¨iOSè®¾å¤‡çš„è®¾ç½® > App Store > æ²™ç›’è´¦å·ä¸­ç™»å½•

2. **æµ‹è¯•æµç¨‹ï¼š**
   - ä½¿ç”¨æ²™ç›’è´¦å·ç™»å½•
   - é€‰æ‹©äº§å“è¿›è¡Œè´­ä¹°
   - å®Œæˆæ”¯ä»˜ï¼ˆæ²™ç›’ç¯å¢ƒä¸ä¼šçœŸå®æ‰£è´¹ï¼‰
   - éªŒè¯ä¼šå‘˜æ˜¯å¦æ­£å¸¸å¼€é€š

3. **æµ‹è¯•åœºæ™¯ï¼š**
   - âœ… é¦–æ¬¡è´­ä¹°
   - âœ… é‡å¤è´­ä¹°ï¼ˆåº”æç¤ºå·²è´­ä¹°ï¼‰
   - âœ… æ¢å¤è´­ä¹°
   - âœ… å–æ¶ˆè®¢é˜…åé‡æ–°è´­ä¹°
   - âœ… è‡ªåŠ¨ç»­è´¹ï¼ˆéœ€è¦ç­‰å¾…ï¼‰
   - âœ… æ¢è®¾å¤‡æ¢å¤

---

## â“ å¸¸è§é—®é¢˜

### Q1: ç”¨æˆ·æ”¯ä»˜æˆåŠŸä½†æ²¡æœ‰å¼€é€šä¼šå‘˜ï¼Ÿ

**å¯èƒ½åŸå› ï¼š**
- æ”¶æ®éªŒè¯å¤±è´¥
- ç½‘ç»œè¯·æ±‚å¤±è´¥
- æœåŠ¡å™¨å“åº”è¶…æ—¶

**è§£å†³æ–¹æ¡ˆï¼š**
```javascript
// 1. ä¿å­˜äº¤æ˜“ä¿¡æ¯åˆ°æœ¬åœ°
AsyncStorage.setItem('pending_transaction', JSON.stringify({
  productId: product.product_id,
  transactionId: purchase.transactionId,
  timestamp: Date.now()
}));

// 2. åœ¨Appå¯åŠ¨æ—¶æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„äº¤æ˜“
const pendingTransaction = await AsyncStorage.getItem('pending_transaction');
if (pendingTransaction) {
  // é‡æ–°è·å–æ”¶æ®å¹¶éªŒè¯
  const receipt = await StoreKit.getReceiptIOS();
  await verifyReceipt(receipt, JSON.parse(pendingTransaction).productId);
}
```

### Q2: å¦‚ä½•æµ‹è¯•è‡ªåŠ¨ç»­è´¹ï¼Ÿ

æ²™ç›’ç¯å¢ƒçš„è®¢é˜…æ—¶é•¿ä¼šè¢«ç¼©çŸ­ï¼š
- 1ä¸ªæœˆè®¢é˜… â†’ 5åˆ†é’Ÿ
- 3ä¸ªæœˆè®¢é˜… â†’ 15åˆ†é’Ÿ  
- 1å¹´è®¢é˜… â†’ 1å°æ—¶

### Q3: å¦‚ä½•å¤„ç†è´­ä¹°è¢«å–æ¶ˆï¼Ÿ

```javascript
try {
  const purchase = await StoreKit.requestPurchase({ sku: productId });
} catch (error) {
  if (error.code === 'E_USER_CANCELLED') {
    // ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆï¼Œä¸éœ€è¦æŠ¥é”™
    console.log('User cancelled the purchase');
  } else {
    // å…¶ä»–é”™è¯¯
    Alert.alert('è´­ä¹°å¤±è´¥', error.message);
  }
}
```

### Q4: ç”¨æˆ·æ¢äº†è®¾å¤‡ï¼Œå¦‚ä½•æ¢å¤ä¼šå‘˜ï¼Ÿ

```javascript
// æ–¹å¼1: ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»"æ¢å¤è´­ä¹°"
await handleRestore();

// æ–¹å¼2: ç™»å½•åè‡ªåŠ¨å°è¯•æ¢å¤
useEffect(() => {
  if (userToken) {
    checkMembershipStatus();
    // å¦‚æœæ²¡æœ‰ä¼šå‘˜çŠ¶æ€ï¼Œå°è¯•æ¢å¤
    if (!membershipStatus?.isMember) {
      handleRestore();
    }
  }
}, [userToken]);
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·è”ç³»åç«¯å¼€å‘å›¢é˜Ÿï¼š

- ğŸ“§ é‚®ç®±: dev@qinghejihua.com.cn
- ğŸ“± å¾®ä¿¡: [è”ç³»æ–¹å¼]
- ğŸ› Bugåé¦ˆ: åœ¨é¡¹ç›®ä»“åº“æIssue

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### 2025-10-11
- âœ… å®Œæˆè‹¹æœIAPåç«¯æ¥å£å¼€å‘
- âœ… å®Œæˆæ¥å£æµ‹è¯•å’ŒéªŒè¯
- âœ… ç¼–å†™å‰ç«¯é›†æˆæ–‡æ¡£

---

**ç¥å¼€å‘é¡ºåˆ©ï¼** ğŸš€


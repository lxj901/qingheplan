# iOS å‰ç«¯ APNS æ¨é€å®Œæ•´é›†æˆæŒ‡å—

**æ›´æ–°æ—¥æœŸ**: 2025å¹´10æœˆ14æ—¥  
**é€‚ç”¨ç‰ˆæœ¬**: iOS 13.0+  
**åç«¯ API**: https://api.qinghejihua.com.cn

---

## ğŸ“‹ ç›®å½•

1. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
2. [æƒé™è¯·æ±‚](#æƒé™è¯·æ±‚)
3. [è®¾å¤‡Tokenæ³¨å†Œ](#è®¾å¤‡tokenæ³¨å†Œ)
4. [æ¥æ”¶å’Œå¤„ç†æ¨é€](#æ¥æ”¶å’Œå¤„ç†æ¨é€)
5. [æ¨é€æ•°æ®æ ¼å¼](#æ¨é€æ•°æ®æ ¼å¼)
6. [é¡µé¢è·³è½¬å¤„ç†](#é¡µé¢è·³è½¬å¤„ç†)
7. [æ¨é€è®¾ç½®ç®¡ç†](#æ¨é€è®¾ç½®ç®¡ç†)
8. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯¼å…¥å¿…è¦çš„æ¡†æ¶

åœ¨ `AppDelegate.swift` ä¸­ï¼š

```swift
import UIKit
import UserNotifications
```

### 2. è®¾ç½®æ¨é€ä»£ç†

```swift
class AppDelegate: UIResponder, UIApplicationDelegate {
    
    func application(_ application: UIApplication, 
                    didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
        
        // è®¾ç½®æ¨é€é€šçŸ¥ä»£ç†
        UNUserNotificationCenter.current().delegate = self
        
        // è¯·æ±‚æ¨é€æƒé™
        requestPushPermission()
        
        return true
    }
}
```

---

## ğŸ” æƒé™è¯·æ±‚

### è¯·æ±‚æ¨é€é€šçŸ¥æƒé™

```swift
func requestPushPermission() {
    UNUserNotificationCenter.current().requestAuthorization(
        options: [.alert, .sound, .badge]
    ) { granted, error in
        if granted {
            print("âœ… æ¨é€æƒé™å·²æˆæƒ")
            DispatchQueue.main.async {
                UIApplication.shared.registerForRemoteNotifications()
            }
        } else {
            print("âŒ æ¨é€æƒé™è¢«æ‹’ç»")
            if let error = error {
                print("é”™è¯¯: \(error.localizedDescription)")
            }
        }
    }
}
```

### æ£€æŸ¥æƒé™çŠ¶æ€

```swift
func checkPushPermissionStatus() {
    UNUserNotificationCenter.current().getNotificationSettings { settings in
        switch settings.authorizationStatus {
        case .authorized:
            print("âœ… å·²æˆæƒ")
        case .denied:
            print("âŒ å·²æ‹’ç»")
        case .notDetermined:
            print("â³ æœªå†³å®š")
        case .provisional:
            print("ğŸ“ ä¸´æ—¶æˆæƒ")
        case .ephemeral:
            print("â± çŸ­æš‚æˆæƒ")
        @unknown default:
            print("â“ æœªçŸ¥çŠ¶æ€")
        }
    }
}
```

---

## ğŸ“± è®¾å¤‡Tokenæ³¨å†Œ

### 1. è·å–è®¾å¤‡Token

```swift
extension AppDelegate {
    
    // æˆåŠŸè·å–è®¾å¤‡Token
    func application(_ application: UIApplication, 
                    didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data) {
        
        // å°†Dataè½¬æ¢ä¸ºå­—ç¬¦ä¸²
        let tokenString = deviceToken.map { String(format: "%02.2hhx", $0) }.joined()
        print("ğŸ“± è®¾å¤‡Token: \(tokenString)")
        
        // ä¿å­˜åˆ°æœ¬åœ°
        UserDefaults.standard.set(tokenString, forKey: "deviceToken")
        
        // ä¸Šä¼ åˆ°æœåŠ¡å™¨
        registerTokenToServer(deviceToken: tokenString)
    }
    
    // è·å–Tokenå¤±è´¥
    func application(_ application: UIApplication, 
                    didFailToRegisterForRemoteNotificationsWithError error: Error) {
        print("âŒ è·å–è®¾å¤‡Tokenå¤±è´¥: \(error.localizedDescription)")
    }
}
```

### 2. æ³¨å†ŒTokenåˆ°æœåŠ¡å™¨

```swift
func registerTokenToServer(deviceToken: String) {
    // ç¡®ä¿ç”¨æˆ·å·²ç™»å½•
    guard let authToken = UserDefaults.standard.string(forKey: "authToken") else {
        print("âš ï¸ ç”¨æˆ·æœªç™»å½•ï¼Œç¨åæ³¨å†ŒToken")
        // ä¿å­˜Tokenï¼Œç™»å½•åå†æ³¨å†Œ
        UserDefaults.standard.set(deviceToken, forKey: "pendingDeviceToken")
        return
    }
    
    let url = URL(string: "https://api.qinghejihua.com.cn/api/v1/push/register")!
    var request = URLRequest(url: url)
    request.httpMethod = "POST"
    request.setValue("Bearer \(authToken)", forHTTPHeaderField: "Authorization")
    request.setValue("application/json", forHTTPHeaderField: "Content-Type")
    
    let body: [String: Any] = [
        "deviceToken": deviceToken,
        "platform": "ios"
    ]
    
    request.httpBody = try? JSONSerialization.data(withJSONObject: body)
    
    URLSession.shared.dataTask(with: request) { data, response, error in
        if let error = error {
            print("âŒ æ³¨å†ŒTokenå¤±è´¥: \(error.localizedDescription)")
            return
        }
        
        if let httpResponse = response as? HTTPURLResponse {
            if httpResponse.statusCode == 200 {
                print("âœ… Tokenæ³¨å†ŒæˆåŠŸ")
                // æ¸…é™¤å¾…æ³¨å†Œçš„Token
                UserDefaults.standard.removeObject(forKey: "pendingDeviceToken")
            } else {
                print("âŒ Tokenæ³¨å†Œå¤±è´¥ï¼ŒçŠ¶æ€ç : \(httpResponse.statusCode)")
            }
        }
    }.resume()
}
```

### 3. ç™»å½•åæ³¨å†Œå¾…å¤„ç†çš„Token

åœ¨ç”¨æˆ·ç™»å½•æˆåŠŸåè°ƒç”¨ï¼š

```swift
func onLoginSuccess() {
    // æ£€æŸ¥æ˜¯å¦æœ‰å¾…æ³¨å†Œçš„Token
    if let pendingToken = UserDefaults.standard.string(forKey: "pendingDeviceToken") {
        registerTokenToServer(deviceToken: pendingToken)
    }
}
```

---

## ğŸ”” æ¥æ”¶å’Œå¤„ç†æ¨é€

### 1. å®ç°UNUserNotificationCenterDelegate

```swift
extension AppDelegate: UNUserNotificationCenterDelegate {
    
    // åº”ç”¨åœ¨å‰å°æ—¶æ”¶åˆ°æ¨é€
    func userNotificationCenter(_ center: UNUserNotificationCenter, 
                              willPresent notification: UNNotification, 
                              withCompletionHandler completionHandler: @escaping (UNNotificationPresentationOptions) -> Void) {
        
        let userInfo = notification.request.content.userInfo
        print("ğŸ“¨ å‰å°æ”¶åˆ°æ¨é€: \(userInfo)")
        
        // è§£ææ¨é€æ•°æ®
        handlePushData(userInfo)
        
        // åœ¨å‰å°ä¹Ÿæ˜¾ç¤ºé€šçŸ¥ï¼ˆiOS 14+ï¼‰
        if #available(iOS 14.0, *) {
            completionHandler([.banner, .sound, .badge])
        } else {
            completionHandler([.alert, .sound, .badge])
        }
    }
    
    // ç”¨æˆ·ç‚¹å‡»æ¨é€é€šçŸ¥
    func userNotificationCenter(_ center: UNUserNotificationCenter, 
                              didReceive response: UNNotificationResponse, 
                              withCompletionHandler completionHandler: @escaping () -> Void) {
        
        let userInfo = response.notification.request.content.userInfo
        print("ğŸ‘† ç”¨æˆ·ç‚¹å‡»æ¨é€: \(userInfo)")
        
        // å¤„ç†è·³è½¬
        handlePushTap(userInfo)
        
        completionHandler()
    }
}
```

### 2. è§£ææ¨é€æ•°æ®

```swift
func handlePushData(_ userInfo: [AnyHashable: Any]) {
    // è·å–æ¨é€ç±»å‹
    guard let type = userInfo["type"] as? String else {
        print("âš ï¸ æ¨é€ç¼ºå°‘typeå­—æ®µ")
        return
    }
    
    print("ğŸ“‹ æ¨é€ç±»å‹: \(type)")
    
    switch type {
    case "messages":
        handleMessagePush(userInfo)
    case "like":
        handleLikePush(userInfo)
    case "comment":
        handleCommentPush(userInfo)
    case "follow":
        handleFollowPush(userInfo)
    case "system":
        handleSystemPush(userInfo)
    default:
        print("âš ï¸ æœªçŸ¥æ¨é€ç±»å‹: \(type)")
    }
}
```

---

## ğŸ“Š æ¨é€æ•°æ®æ ¼å¼

### 1. ç§èŠæ¶ˆæ¯æ¨é€

```json
{
  "aps": {
    "alert": {
      "title": "å¼ ä¸‰",
      "body": "ä½ å¥½ï¼Œè¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯"
    },
    "badge": 1,
    "sound": "ping.aiff"
  },
  "type": "messages",
  "conversationId": "conv-123",
  "messageId": "msg-456",
  "senderId": 1,
  "senderName": "å¼ ä¸‰",
  "content": "ä½ å¥½ï¼Œè¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯",
  "conversationType": "private",
  "timestamp": "2025-10-14T10:00:00.000Z"
}
```

### 2. ç¾¤èŠæ¶ˆæ¯æ¨é€

```json
{
  "aps": {
    "alert": {
      "title": "å¥èº«äº¤æµç¾¤",
      "body": "å¼ ä¸‰: å¤§å®¶å¥½"
    },
    "badge": 1,
    "sound": "ping.aiff"
  },
  "type": "messages",
  "conversationId": "conv-789",
  "messageId": "msg-101",
  "senderId": 1,
  "senderName": "å¼ ä¸‰",
  "content": "å¤§å®¶å¥½",
  "conversationType": "group",
  "conversationTitle": "å¥èº«äº¤æµç¾¤",
  "timestamp": "2025-10-14T10:00:00.000Z"
}
```

### 3. ç‚¹èµé€šçŸ¥æ¨é€

```json
{
  "aps": {
    "alert": {
      "title": "å¼ ä¸‰ ç‚¹èµäº†ä½ çš„å¸–å­",
      "body": "å¸–å­å†…å®¹é¢„è§ˆ..."
    },
    "badge": 1,
    "sound": "ping.aiff"
  },
  "type": "like",
  "postId": 123,
  "userId": 1,
  "userName": "å¼ ä¸‰",
  "timestamp": "2025-10-14T10:00:00.000Z"
}
```

### 4. è¯„è®ºé€šçŸ¥æ¨é€

```json
{
  "aps": {
    "alert": {
      "title": "å¼ ä¸‰ è¯„è®ºäº†ä½ çš„å¸–å­",
      "body": "è¯„è®ºå†…å®¹..."
    },
    "badge": 1,
    "sound": "ping.aiff"
  },
  "type": "comment",
  "postId": 123,
  "commentId": 456,
  "userId": 1,
  "userName": "å¼ ä¸‰",
  "content": "è¯„è®ºå†…å®¹...",
  "timestamp": "2025-10-14T10:00:00.000Z"
}
```

### 5. å…³æ³¨é€šçŸ¥æ¨é€

```json
{
  "aps": {
    "alert": {
      "title": "å¼ ä¸‰ å…³æ³¨äº†ä½ ",
      "body": ""
    },
    "badge": 1,
    "sound": "ping.aiff"
  },
  "type": "follow",
  "userId": 1,
  "userName": "å¼ ä¸‰",
  "timestamp": "2025-10-14T10:00:00.000Z"
}
```

---

## ğŸ§­ é¡µé¢è·³è½¬å¤„ç†

### å¤„ç†æ¨é€ç‚¹å‡»è·³è½¬

```swift
func handlePushTap(_ userInfo: [AnyHashable: Any]) {
    guard let type = userInfo["type"] as? String else {
        return
    }
    
    // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿åº”ç”¨å®Œå…¨å¯åŠ¨
    DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
        switch type {
        case "messages":
            self.navigateToChat(userInfo)
        case "like", "comment":
            self.navigateToPost(userInfo)
        case "follow":
            self.navigateToUserProfile(userInfo)
        case "system":
            self.navigateToNotifications()
        default:
            break
        }
    }
}

// è·³è½¬åˆ°èŠå¤©é¡µé¢
func navigateToChat(_ userInfo: [AnyHashable: Any]) {
    guard let conversationId = userInfo["conversationId"] as? String else {
        return
    }
    
    // å‘é€é€šçŸ¥ç»™UIå±‚å¤„ç†è·³è½¬
    NotificationCenter.default.post(
        name: NSNotification.Name("NavigateToChat"),
        object: nil,
        userInfo: ["conversationId": conversationId]
    )
}

// è·³è½¬åˆ°å¸–å­è¯¦æƒ…
func navigateToPost(_ userInfo: [AnyHashable: Any]) {
    guard let postId = userInfo["postId"] as? Int else {
        return
    }
    
    NotificationCenter.default.post(
        name: NSNotification.Name("NavigateToPost"),
        object: nil,
        userInfo: ["postId": postId]
    )
}

// è·³è½¬åˆ°ç”¨æˆ·ä¸»é¡µ
func navigateToUserProfile(_ userInfo: [AnyHashable: Any]) {
    guard let userId = userInfo["userId"] as? Int else {
        return
    }
    
    NotificationCenter.default.post(
        name: NSNotification.Name("NavigateToUserProfile"),
        object: nil,
        userInfo: ["userId": userId]
    )
}
```

---

## âš™ï¸ æ¨é€è®¾ç½®ç®¡ç†

### 1. è·å–æ¨é€è®¾ç½®

```swift
func fetchPushSettings(completion: @escaping (Result<PushSettings, Error>) -> Void) {
    guard let authToken = UserDefaults.standard.string(forKey: "authToken") else {
        completion(.failure(NSError(domain: "", code: 401, userInfo: [NSLocalizedDescriptionKey: "æœªç™»å½•"])))
        return
    }
    
    let url = URL(string: "https://api.qinghejihua.com.cn/api/v1/push/settings")!
    var request = URLRequest(url: url)
    request.httpMethod = "GET"
    request.setValue("Bearer \(authToken)", forHTTPHeaderField: "Authorization")
    
    URLSession.shared.dataTask(with: request) { data, response, error in
        if let error = error {
            completion(.failure(error))
            return
        }
        
        guard let data = data else {
            completion(.failure(NSError(domain: "", code: -1, userInfo: [NSLocalizedDescriptionKey: "æ— æ•°æ®"])))
            return
        }
        
        do {
            let decoder = JSONDecoder()
            let response = try decoder.decode(PushSettingsResponse.self, from: data)
            completion(.success(response.data))
        } catch {
            completion(.failure(error))
        }
    }.resume()
}

// æ•°æ®æ¨¡å‹
struct PushSettings: Codable {
    var likes: Bool
    var comments: Bool
    var follows: Bool
    var messages: Bool
    var groupMessages: Bool
    var system: Bool
}

struct PushSettingsResponse: Codable {
    let success: Bool
    let data: PushSettings
}
```

### 2. æ›´æ–°æ¨é€è®¾ç½®

```swift
func updatePushSettings(_ settings: PushSettings, completion: @escaping (Result<Void, Error>) -> Void) {
    guard let authToken = UserDefaults.standard.string(forKey: "authToken") else {
        completion(.failure(NSError(domain: "", code: 401, userInfo: [NSLocalizedDescriptionKey: "æœªç™»å½•"])))
        return
    }
    
    let url = URL(string: "https://api.qinghejihua.com.cn/api/v1/push/settings")!
    var request = URLRequest(url: url)
    request.httpMethod = "PUT"
    request.setValue("Bearer \(authToken)", forHTTPHeaderField: "Authorization")
    request.setValue("application/json", forHTTPHeaderField: "Content-Type")
    
    let encoder = JSONEncoder()
    request.httpBody = try? encoder.encode(settings)
    
    URLSession.shared.dataTask(with: request) { data, response, error in
        if let error = error {
            completion(.failure(error))
            return
        }
        
        if let httpResponse = response as? HTTPURLResponse, httpResponse.statusCode == 200 {
            completion(.success(()))
        } else {
            completion(.failure(NSError(domain: "", code: -1, userInfo: [NSLocalizedDescriptionKey: "æ›´æ–°å¤±è´¥"])))
        }
    }.resume()
}
```

---

## â“ å¸¸è§é—®é¢˜

### 1. æ¨é€é€šçŸ¥ä¸æ˜¾ç¤ºæ ‡é¢˜ï¼Ÿ

**é—®é¢˜**: æ¨é€é€šçŸ¥æ˜¾ç¤º App åç§°è€Œä¸æ˜¯ç”¨æˆ·å

**è§£å†³**: åç«¯å·²ä¿®å¤ï¼Œç¡®ä¿ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„åç«¯ä»£ç ï¼ˆ2025-10-14 ä¹‹åï¼‰

### 2. å‰å°æ”¶ä¸åˆ°æ¨é€ï¼Ÿ

**é—®é¢˜**: åº”ç”¨åœ¨å‰å°æ—¶æ”¶ä¸åˆ°æ¨é€é€šçŸ¥

**è§£å†³**: åœ¨ `willPresent` æ–¹æ³•ä¸­è¿”å›æ­£ç¡®çš„é€‰é¡¹ï¼š

```swift
completionHandler([.banner, .sound, .badge])  // iOS 14+
completionHandler([.alert, .sound, .badge])   // iOS 13
```

### 3. Tokenæ³¨å†Œå¤±è´¥ï¼Ÿ

**é—®é¢˜**: è®¾å¤‡Tokenæ³¨å†Œåˆ°æœåŠ¡å™¨å¤±è´¥

**æ£€æŸ¥**:
- ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
- Authorization header æ˜¯å¦æ­£ç¡®
- ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸

### 4. å¦‚ä½•æµ‹è¯•æ¨é€ï¼Ÿ

**æ–¹æ³•1**: ä½¿ç”¨çœŸå®è®¾å¤‡ï¼ˆæ¨é€ä¸æ”¯æŒæ¨¡æ‹Ÿå™¨ï¼‰
**æ–¹æ³•2**: ä½¿ç”¨åç«¯æµ‹è¯•è„šæœ¬å‘é€æµ‹è¯•æ¨é€
**æ–¹æ³•3**: è§¦å‘å®é™…æ“ä½œï¼ˆå‘æ¶ˆæ¯ã€ç‚¹èµç­‰ï¼‰

---

## ğŸ“ å®Œæ•´ç¤ºä¾‹ä»£ç 

æŸ¥çœ‹å®Œæ•´çš„ç¤ºä¾‹ä»£ç ï¼Œè¯·å‚è€ƒï¼š
- `AppDelegate+Push.swift` - æ¨é€ç›¸å…³æ‰©å±•
- `PushNotificationManager.swift` - æ¨é€ç®¡ç†å™¨
- `PushSettingsViewController.swift` - æ¨é€è®¾ç½®é¡µé¢

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-10-14  
**ç»´æŠ¤è€…**: é’ç¦¾è®¡åˆ’å¼€å‘å›¢é˜Ÿ


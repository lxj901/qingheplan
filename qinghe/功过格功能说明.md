# 功过格功能实现说明

## 📋 概述

功过格功能已成功集成后端 API，实现了完整的功过记录管理系统。用户可以记录每日的善行（功）和过失（过），并查看统计分析。

## 🎯 主要功能

### 1. 功过记录管理
- ✅ 查看月历视图，显示每日功过分数
- ✅ 查看当日详细记录列表
- ✅ 添加新的功过记录
- ✅ 删除已有记录（长按记录项）
- ✅ 月份切换（前一月/后一月）

### 2. 统计分析
- ✅ 查看不同时间段的统计数据（7/30/90/365天）
- ✅ 总览卡片：功德、过失、净分
- ✅ 趋势图表：每日功过趋势可视化
- ✅ 分类统计：各分类的记录次数和分值
- ✅ 连续记录：当前连续天数和最长连续天数

## 📁 文件结构

```
qinghe/qinghe/
├── MeritService.swift              # API 服务层（已完成）
├── MeritViewModel.swift            # 数据管理层（新建）
├── GongGuoGeView.swift             # 主页面（已更新）
├── GongGuoRecordEditorView.swift  # 记录编辑器（已更新）
├── MeritStatisticsView.swift      # 统计页面（新建）
└── GongGuoStandardBook.swift      # 标准条目库
```

## 🔧 技术实现

### API 集成

所有功能都通过 `MeritService` 调用后端 API：

1. **获取记录列表**: `getMeritRecordsList()`
2. **创建记录**: `createMeritRecord()`
3. **更新记录**: `updateMeritRecord()`
4. **删除记录**: `deleteMeritRecord()`
5. **获取统计**: `getMeritStatistics()`

### 架构设计

采用 MVVM 架构：

- **Model**: MeritRecord、MeritStatisticsData 等数据模型
- **ViewModel**: MeritViewModel 管理数据状态和业务逻辑
- **View**: GongGuoGeView、MeritStatisticsView 等 UI 视图

### 数据流

```
用户操作 → View → ViewModel → MeritService → API
                ↓
            更新 UI ← 处理响应 ← API Response
```

## 🎨 UI/UX 特性

### 主页面（GongGuoGeView）
- 月历网格展示，清晰显示每日功过
- 滚动时顶部导航栏渐入效果
- 当日记录卡片，支持空状态提示
- 加载中遮罩和错误提示

### 记录编辑器（GongGuoRecordEditorView）
- 功/过类型快速切换
- 搜索功能快速查找条目
- 分类筛选
- 最近使用记录
- 保存时显示加载状态

### 统计页面（MeritStatisticsView）
- 时间段选择器（7/30/90/365天）
- 总览数据卡片
- 折线图展示趋势
- 分类统计详情
- 连续打卡记录

## 📊 数据结构

### DailyScore
```swift
struct DailyScore {
    var merit: Int      // 功德分数
    var demerit: Int    // 过失分数
}
```

### MeritRecord
```swift
struct MeritRecord: Codable, Identifiable {
    let id: Int
    let userId: Int
    let type: String        // "merit" 或 "demerit"
    let category: String    // 分类
    let title: String       // 标题
    let points: Int         // 分值
    let date: String        // 日期
    let notes: String?      // 备注
    let createdAt: String
    let updatedAt: String
}
```

## 🚀 使用流程

### 添加记录
1. 在主页面点击右上角的 "+" 按钮
2. 选择功/过类型
3. 选择或搜索条目
4. 调整分值（如需要）
5. 点击"保存"

### 查看统计
1. 在主页面点击右上角的统计图标
2. 选择时间段（7/30/90/365天）
3. 查看总览、趋势、分类等数据

### 删除记录
1. 长按记录项
2. 在弹出菜单中选择"删除"

## ⚠️ 注意事项

1. **网络请求**: 所有 API 调用都是异步的，使用 `async/await`
2. **错误处理**: 所有操作都有错误处理和用户提示
3. **加载状态**: 数据加载时显示进度指示器
4. **日期格式**: API 使用 ISO 8601 格式（YYYY-MM-DD）
5. **认证**: 需要在请求头中携带有效的 JWT Token

## 🔐 API 配置

API 基础地址配置在 `APIConfig.swift`:
```swift
static let baseURL = "https://api.qinghejihua.com.cn/api/v1"
```

## 📝 待改进

以下是可以进一步优化的方向：

1. ⏳ 添加下拉刷新功能
2. 📱 支持离线缓存
3. 🔔 添加每日提醒功能
4. 📈 更多图表类型（饼图、柱状图等）
5. 🎯 设置功过目标和提醒
6. 📤 导出数据功能
7. 🎨 主题自定义

## 🐛 调试

如需调试，在控制台中查看以下日志：

- ✅ 成功操作：以 "✅" 开头
- ❌ 错误信息：以 "❌" 开头
- 📡 API 调用详情
- 📊 数据处理流程

## 📞 技术支持

如有问题，请检查：
1. 网络连接是否正常
2. Token 是否有效（未过期）
3. API 服务器是否可访问
4. 控制台错误日志

---

**更新日期**: 2025-10-06
**版本**: 1.0.0
**作者**: AI Assistant


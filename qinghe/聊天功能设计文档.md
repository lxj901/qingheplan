# 青禾计划 - 聊天功能设计文档

## 概述

本文档描述了青禾计划应用中聊天功能的完整设计，包括UI/UX设计、数据模型、API服务和技术实现。

## 功能特性

### 🎯 核心功能
- ✅ 私聊和群聊支持
- ✅ 实时消息发送和接收
- ✅ 消息状态显示（发送中、已发送、已送达、已读）
- ✅ 未读消息计数和提醒
- ✅ 消息搜索功能
- ✅ 聊天列表分类筛选
- ✅ 会话置顶和静音
- ✅ 在线状态显示

### 🎨 UI/UX 特性
- ✅ 现代化的Material Design风格
- ✅ 流畅的动画和交互效果
- ✅ 响应式布局适配
- ✅ 无障碍支持
- ✅ 深色模式兼容
- ✅ 直观的消息气泡设计

### 📱 交互功能
- ✅ 长按消息显示操作菜单
- ✅ 下拉刷新聊天列表
- ✅ 上拉加载历史消息
- ✅ 智能输入框（支持多行文本）
- ✅ 表情和附件支持（预留接口）

## 架构设计

### 📁 文件结构
```
qinghe/qinghe/
├── ChatModels.swift           # 聊天数据模型
├── ChatAPIService.swift       # 聊天API服务
├── ChatUIComponents.swift     # 聊天UI组件
├── MessagesView.swift         # 聊天列表页面
├── ChatListViewModel.swift    # 聊天列表视图模型
├── NewChatView.swift          # 新建聊天页面
├── NewChatViewModel.swift     # 新建聊天视图模型
├── ChatDetailView.swift       # 聊天详情页面
└── ChatDetailViewModel.swift  # 聊天详情视图模型
```

### 🏗️ 数据模型

#### ChatConversation（聊天会话）
```swift
struct ChatConversation {
    let id: String
    let title: String?
    let type: ConversationType  // private, group, system
    let participants: [ChatUser]
    let lastMessage: ChatMessage?
    let unreadCount: Int
    let lastActiveAt: String
    let isPinned: Bool
    let isMuted: Bool
    // ... 其他属性
}
```

#### ChatMessage（聊天消息）
```swift
struct ChatMessage {
    let id: String
    let conversationId: String
    let senderId: Int
    let senderInfo: ChatUser
    let content: String
    let type: MessageType       // text, image, video, audio, file
    let status: MessageStatus   // sending, sent, delivered, read, failed
    let createdAt: String
    let attachments: [MessageAttachment]?
    // ... 其他属性
}
```

#### ChatUser（聊天用户）
```swift
struct ChatUser {
    let id: Int
    let nickname: String
    let avatar: String?
    let isOnline: Bool
    let lastSeenAt: String?
}
```

### 🌐 API 设计

#### 主要端点
- `GET /chat/conversations` - 获取聊天列表
- `POST /chat/conversations` - 创建新会话
- `GET /chat/messages/{conversationId}` - 获取消息列表
- `POST /chat/messages` - 发送消息
- `POST /chat/conversations/{id}/read` - 标记已读
- `PUT /chat/conversations/{id}/pin` - 置顶会话
- `PUT /chat/conversations/{id}/mute` - 静音会话
- `DELETE /chat/conversations/{id}` - 删除会话

## UI 设计详解

### 🏠 聊天列表页面 (MessagesView)

#### 设计特点
- **现代化导航栏**：包含标题、搜索和新建聊天按钮
- **智能搜索栏**：支持实时搜索，带有清除和取消功能
- **分类筛选器**：全部、私聊、群聊、未读消息快速筛选
- **聊天列表项**：
  - 用户头像（带在线状态指示器）
  - 会话名称和最后消息预览
  - 时间显示和未读消息徽章
  - 置顶和静音状态图标

#### 交互功能
- 点击进入聊天详情
- 长按显示操作菜单（置顶、静音、删除等）
- 下拉刷新列表
- 支持无限滚动加载

### 💬 聊天详情页面 (ChatDetailView)

#### 设计特点
- **自定义导航栏**：
  - 返回按钮
  - 对方头像和在线状态
  - 会话名称和参与人数
  - 更多操作按钮
- **消息列表**：
  - 消息气泡（发送方和接收方不同样式）
  - 时间戳显示
  - 消息状态图标
  - 发送者头像（群聊）
- **输入区域**：
  - 附件按钮
  - 多行文本输入框
  - 表情按钮
  - 发送按钮（智能激活）

#### 消息气泡设计
- **发送方消息**：右对齐，绿色背景，白色文字
- **接收方消息**：左对齐，白色背景，黑色文字
- **系统消息**：居中显示，灰色背景
- **状态指示**：发送中、已送达、已读等状态图标

### 👥 新建聊天页面 (NewChatView)

#### 设计特点
- **用户搜索**：实时搜索用户列表
- **多选功能**：支持选择多个用户创建群聊
- **已选用户展示**：芯片式展示已选用户
- **用户列表**：头像、昵称、在线状态展示

## 技术实现

### 🔧 核心技术栈
- **SwiftUI**：现代化UI框架
- **Combine**：响应式编程
- **AsyncImage**：异步图片加载
- **@StateObject/@ObservableObject**：状态管理
- **Task/async-await**：异步编程

### 📊 状态管理
- **ChatListViewModel**：管理聊天列表状态
- **ChatDetailViewModel**：管理聊天详情状态
- **NewChatViewModel**：管理新建聊天状态

### 🎨 设计系统
- **ModernDesignSystem**：统一的设计规范
- **颜色系统**：主题色、文本色、背景色等
- **字体系统**：标题、正文、说明文字等
- **间距系统**：统一的边距和间距规范
- **圆角系统**：统一的圆角规范

### 🔄 实时更新
- 预留WebSocket接口用于实时消息推送
- 本地状态实时同步
- 消息状态实时更新

## 用户体验优化

### ⚡ 性能优化
- **LazyVStack**：列表虚拟化，提升滚动性能
- **AsyncImage**：图片异步加载和缓存
- **任务取消**：避免重复请求
- **分页加载**：减少单次数据加载量

### 🎯 交互优化
- **智能键盘处理**：输入时自动调整布局
- **流畅动画**：页面切换和状态变化动画
- **haptic反馈**：重要操作提供触觉反馈
- **无障碍支持**：VoiceOver和动态字体支持

### 🛡️ 错误处理
- **网络错误**：友好的错误提示和重试机制
- **加载状态**：清晰的加载指示器
- **空状态**：有意义的空状态页面
- **离线模式**：基本的离线功能支持

## 扩展功能

### 🔮 未来规划
- **语音消息**：录制和播放语音消息
- **图片视频**：多媒体消息支持
- **文件传输**：文档和文件分享
- **消息回复**：引用回复功能
- **消息转发**：消息转发到其他会话
- **消息撤回**：发送后撤回消息
- **阅后即焚**：临时消息功能
- **群聊管理**：群主、管理员权限管理

### 🎨 UI增强
- **主题切换**：多种聊天主题
- **字体大小**：可调节字体大小
- **聊天背景**：自定义聊天背景
- **表情包**：丰富的表情包支持

## 总结

这个聊天系统设计充分考虑了现代移动应用的用户体验标准，采用了最新的SwiftUI技术栈，具有良好的可扩展性和维护性。通过模块化的架构设计，可以轻松添加新功能和优化现有功能。

整个系统遵循了青禾计划应用的设计语言，与现有功能保持一致的视觉风格和交互模式，为用户提供了流畅、直观的聊天体验。

# å¥åº·åŠ©æ‰‹å¸–å­é“¾æ¥ä¼˜åŒ–è¯´æ˜

## ä¿®æ”¹æ—¥æœŸ
2025-10-04

## é—®é¢˜æè¿°
åœ¨å¥åº·åŠ©æ‰‹é¡µé¢ï¼ŒAI æ¨èçš„ Markdown é“¾æ¥ï¼ˆæ ¼å¼ï¼š`[å¸–å­æ ‡é¢˜](qinghe://post/{postId})`ï¼‰ç‚¹å‡»åä¼šè·³è½¬åˆ°å¸–å­è¯¦æƒ…é¡µï¼Œä½†ä½“éªŒä¸Šæœ‰ä¸¤ä¸ªé—®é¢˜ï¼š
1. è·³è½¬ä¼šç¦»å¼€å½“å‰å¥åº·åŠ©æ‰‹é¡µé¢
2. ç”¨æˆ·éœ€è¦æ‰‹åŠ¨è¿”å›æ‰èƒ½ç»§ç»­ä¸ AI å¯¹è¯

## è§£å†³æ–¹æ¡ˆ
ä¿®æ”¹é“¾æ¥ç‚¹å‡»è¡Œä¸ºï¼Œç‚¹å‡»å¸–å­é“¾æ¥åä»¥ **sheetï¼ˆå¼¹å‡ºè¡¨å•ï¼‰** çš„æ–¹å¼åœ¨å¥åº·åŠ©æ‰‹é¡µé¢å†…æ‰“å¼€å¸–å­è¯¦æƒ…é¡µã€‚

### ä¼˜åŠ¿
- âœ… ä¿æŒåœ¨å¥åº·åŠ©æ‰‹ä¸Šä¸‹æ–‡ä¸­
- âœ… æŸ¥çœ‹å®Œå¸–å­åè½»æ¾è¿”å›å¯¹è¯
- âœ… æ›´æµç•…çš„ç”¨æˆ·ä½“éªŒ
- âœ… ç¬¦åˆ iOS åº”ç”¨çš„äº¤äº’è®¾è®¡è§„èŒƒ

## æŠ€æœ¯å®ç°

### 1. æ·»åŠ çŠ¶æ€ç®¡ç†
åœ¨ `HealthAssistantView` ä¸­æ·»åŠ ï¼š
```swift
// å¸–å­è¯¦æƒ…é¡µ sheet
@State private var showingPostDetail = false
@State private var selectedPostId: String? = nil
```

### 2. æ·»åŠ  Sheet ä¿®é¥°ç¬¦
åœ¨ä¸»è§†å›¾æ·»åŠ  `.sheet` ä¿®é¥°ç¬¦ï¼š
```swift
.sheet(isPresented: $showingPostDetail) {
    if let postId = selectedPostId {
        NavigationStack {
            PostDetailView(postId: postId)
                .navigationBarHidden(true)
        }
    }
}
```

### 3. æ·»åŠ é“¾æ¥ç‚¹å‡»å›è°ƒæ”¯æŒ
ç”±äº `MarkdownTextView` å’Œ `MessageBubble` æ˜¯ç‹¬ç«‹çš„ç»„ä»¶ï¼Œéœ€è¦é€šè¿‡å›è°ƒæœºåˆ¶ä¼ é€’é“¾æ¥ç‚¹å‡»äº‹ä»¶ï¼š

**3.1 åœ¨ `MarkdownTextView` ä¸­æ·»åŠ å›è°ƒå‚æ•°ï¼š**
```swift
struct MarkdownTextView: View {
    let text: String
    @Environment(\.openURL) var openURL
    var onLinkTap: ((String) -> Void)? = nil  // é“¾æ¥ç‚¹å‡»å›è°ƒ
    
    // åœ¨ handleLinkTap ä¸­ä½¿ç”¨å›è°ƒ
    private func handleLinkTap(_ urlString: String) {
        if let onLinkTap = onLinkTap {
            onLinkTap(urlString)  // ä½¿ç”¨è‡ªå®šä¹‰å›è°ƒ
        } else {
            // é»˜è®¤è¡Œä¸ºï¼šæ‰“å¼€ URL
            if let url = URL(string: urlString) {
                openURL(url)
            }
        }
    }
}
```

**3.2 åœ¨ `MessageBubble` ä¸­æ·»åŠ å›è°ƒå‚æ•°ï¼š**
```swift
struct MessageBubble: View {
    let message: HealthAssistantView.ChatMessage
    let displayedText: String
    var onLinkTap: ((String) -> Void)? = nil
    
    // ä¼ é€’ç»™ MarkdownTextView
    MarkdownTextView(text: displayedText, onLinkTap: onLinkTap)
}
```

**3.3 åœ¨ `HealthAssistantView` ä¸­å®ç°é“¾æ¥å¤„ç†ï¼š**
```swift
// å¤„ç†é“¾æ¥ç‚¹å‡»ï¼ˆä»æ¶ˆæ¯ä¸­çš„ Markdown é“¾æ¥ï¼‰
private func handleLinkTap(_ urlString: String) {
    print("ğŸ”— é“¾æ¥ç‚¹å‡»: \(urlString)")
    
    // æ£€æµ‹æ˜¯å¦æ˜¯ qinghe://post/{postId} æ ¼å¼
    if urlString.hasPrefix("qinghe://post/") {
        let postId = String(urlString.dropFirst("qinghe://post/".count))
        print("ğŸ” å‡†å¤‡æ‰“å¼€å¸–å­è¯¦æƒ…ï¼ˆsheetï¼‰ï¼Œå¸–å­ID: \(postId)")
        
        // åœ¨å¥åº·åŠ©æ‰‹é¡µé¢ä»¥ sheet æ–¹å¼æ‰“å¼€å¸–å­è¯¦æƒ…é¡µ
        selectedPostId = postId
        showingPostDetail = true
    } else if let url = URL(string: urlString) {
        // å…¶ä»–é“¾æ¥ä½¿ç”¨ç³»ç»Ÿé»˜è®¤æ–¹å¼æ‰“å¼€
        openURL(url)
    }
}

// åœ¨ä½¿ç”¨ MessageBubble çš„åœ°æ–¹ä¼ é€’å›è°ƒ
MessageBubble(message: message, displayedText: message.content, onLinkTap: handleLinkTap)
```

### 4. åŒæ—¶ä¿®æ”¹ URL Scheme å¤„ç†
å°†åŸæ¥çš„ `handleCustomURL` æ–¹æ³•ä¹Ÿæ”¹ä¸ºä½¿ç”¨ sheetï¼š
```swift
private func handleCustomURL(_ url: URL) {
    if url.scheme == "qinghe", url.host == "post" {
        let postId = url.pathComponents.last ?? url.path.trimmingCharacters(in: CharacterSet(charactersIn: "/"))
        
        if !postId.isEmpty {
            // æ”¹ä¸ºä½¿ç”¨ sheet è€Œä¸æ˜¯ NavigationManager
            selectedPostId = postId
            showingPostDetail = true
        }
    }
}
```

**æ”¹åŠ¨è¯´æ˜**ï¼š
- âŒ ç§»é™¤ï¼š`NavigationManager.shared.navigateToPost(id: postId)`
- âœ… æ–°å¢ï¼šè®¾ç½® `selectedPostId` å’Œ `showingPostDetail` æ¥è§¦å‘ sheet
- âœ… æ–°å¢ï¼šé€šè¿‡å›è°ƒé“¾ä¼ é€’é“¾æ¥ç‚¹å‡»äº‹ä»¶

## é“¾æ¥æ ¼å¼
AI æ¨èå¸–å­æ—¶ä½¿ç”¨çš„é“¾æ¥æ ¼å¼ï¼š
```markdown
[å¸–å­æ ‡é¢˜](qinghe://post/å¸–å­ID)
```

ç¤ºä¾‹ï¼š
```markdown
[å¦‚ä½•è°ƒç†è„¾èƒƒï¼Ÿ](qinghe://post/12345)
```

## ç”¨æˆ·ä½“éªŒæµç¨‹
1. ç”¨æˆ·åœ¨å¥åº·åŠ©æ‰‹ä¸ AI å¯¹è¯
2. AI æ¨èç›¸å…³å¸–å­ï¼ˆä»¥ Markdown é“¾æ¥å½¢å¼ï¼‰
3. ç”¨æˆ·ç‚¹å‡»é“¾æ¥
4. å¸–å­è¯¦æƒ…é¡µä»¥ sheet å½¢å¼ä»åº•éƒ¨å¼¹å‡º
5. ç”¨æˆ·æŸ¥çœ‹å¸–å­å†…å®¹ã€è¯„è®ºç­‰
6. ç”¨æˆ·ä¸‹æ»‘æˆ–ç‚¹å‡»è¿”å›ï¼Œå…³é—­ sheet
7. å›åˆ°å¥åº·åŠ©æ‰‹å¯¹è¯é¡µé¢ï¼Œç»§ç»­ä¸ AI äº¤æµ

## ç›¸å…³æ–‡ä»¶
- `qinghe/HealthAssistantView.swift` - ä¸»è¦ä¿®æ”¹æ–‡ä»¶
- `qinghe/PostDetailView.swift` - å¸–å­è¯¦æƒ…é¡µè§†å›¾

## æµ‹è¯•å»ºè®®
1. âœ… æµ‹è¯•ç‚¹å‡»é“¾æ¥æ˜¯å¦æ­£ç¡®æ‰“å¼€å¸–å­è¯¦æƒ…é¡µ
2. âœ… æµ‹è¯•ä¸‹æ»‘å…³é—­ sheet æ˜¯å¦æ­£å¸¸
3. âœ… æµ‹è¯•åœ¨å¸–å­è¯¦æƒ…é¡µçš„æ‰€æœ‰äº¤äº’åŠŸèƒ½ï¼ˆç‚¹èµã€è¯„è®ºã€æ”¶è—ç­‰ï¼‰
4. âœ… æµ‹è¯•å…³é—­ sheet åå¯¹è¯çŠ¶æ€æ˜¯å¦ä¿æŒ
5. âœ… æµ‹è¯•è¿ç»­ç‚¹å‡»å¤šä¸ªä¸åŒçš„å¸–å­é“¾æ¥

## æ³¨æ„äº‹é¡¹
- PostDetailView æœ¬èº«å·²ç»æœ‰è‡ªå·±çš„å¯¼èˆªæ å’Œè¿”å›æŒ‰é’®
- Sheet é»˜è®¤æ”¯æŒä¸‹æ»‘å…³é—­æ‰‹åŠ¿
- å¸–å­è¯¦æƒ…é¡µå†…çš„æ‰€æœ‰åŠŸèƒ½ï¼ˆç‚¹èµã€è¯„è®ºã€åˆ†äº«ç­‰ï¼‰åº”è¯¥æ­£å¸¸å·¥ä½œ
- ç¡®ä¿ PostDetailView åœ¨ sheet ä¸­çš„å±•ç¤ºæ•ˆæœè‰¯å¥½


# AI题库过滤已回答题目集成说明

**修复日期**: 2025-10-21  
**修复人员**: AI Assistant  
**编译状态**: ✅ BUILD SUCCEEDED (iPhone 16 Pro 模拟器, iOS 18.5)

---

## 📋 问题描述

用户提交答案后，题库列表仍然显示已回答正确的题目。后端已经实现了过滤逻辑，但前端在查询题目列表时没有传递 `userId` 参数。

---

## 🔧 解决方案

### 1️⃣ 修改 API 服务层 - 添加 userId 参数

**文件**: `qinghe/ /qinghe/qinghe/AIQuestionAPIService.swift`

**修改位置**: `getQuestions` 方法（第 53-110 行）

**修改内容**:
```swift
func getQuestions(
    bookId: String? = nil,
    chapterId: String? = nil,
    questionType: QuestionType? = nil,
    difficulty: QuestionDifficulty? = nil,
    batchId: String? = nil,
    limit: Int = 10,
    offset: Int = 0
) async throws -> QuestionListResponse {
    var parameters: [String: Any] = [
        "limit": limit,
        "offset": offset
    ]

    // ... 其他参数 ...
    
    // ⭐ 添加 userId 参数以过滤已回答正确的题目
    if let userId = authManager.getCurrentUserId() {
        parameters["userId"] = userId
    }

    // ... 发送请求 ...
}
```

**说明**:
- 使用 `authManager.getCurrentUserId()` 获取当前登录用户的 ID
- 如果用户已登录，自动添加 `userId` 参数到请求中
- 后端会根据 `userId` 过滤掉该用户已回答正确的题目

---

### 2️⃣ 修改 ViewModel 层 - 答对后刷新列表

**文件**: `qinghe/ /qinghe/qinghe/AIQuestionViewModel.swift`

**修改位置**: `submitAnswer` 方法（第 139-192 行）

**修改内容**:
```swift
func submitAnswer() async {
    // ... 提交答案逻辑 ...
    
    do {
        let result = try await apiService.submitAnswer(
            questionId: question.id,
            userAnswer: userAnswer,
            answerTime: answerTime
        )
        
        answerResult = result
        hasSubmitted = true

        // 保存答题记录
        let record = AnswerRecord(...)
        answerRecords.append(record)
        
        // ⭐ 如果答对了，重新加载题目列表（会自动过滤掉已答对的题目）
        if result.isAnswerCorrect {
            // 延迟一下，让用户看到答题结果
            try? await Task.sleep(nanoseconds: 500_000_000) // 0.5秒
            await loadQuestions(batchId: lastGeneratedBatchId)
        }
        
        isLoading = false
    } catch {
        // ... 错误处理 ...
    }
}
```

**说明**:
- 当用户答对题目后，延迟 0.5 秒让用户看到答题结果
- 然后重新加载题目列表
- 由于 API 服务层已经添加了 `userId` 参数，重新加载时会自动过滤掉已答对的题目

---

## 📊 API 对比

### ❌ 修改前（不传 userId）

```http
GET /api/v1/classics/ai-questions?offset=0&limit=100
```

**返回结果**: 所有题目（包括已回答正确的）

---

### ✅ 修改后（传 userId）

```http
GET /api/v1/classics/ai-questions?userId=1&offset=0&limit=100
```

**返回结果**: 排除用户已回答正确的题目

---

## 🎯 功能特性

### 过滤规则
- ✅ **答对的题目**: 不再显示在题库列表中
- ✅ **答错的题目**: 仍然显示，可以重新作答
- ✅ **未作答的题目**: 正常显示

### 用户体验
1. 用户答对题目后，看到答题结果（0.5秒）
2. 题目列表自动刷新
3. 已答对的题目从列表中消失
4. 自动跳转到下一题（如果有）

---

## 🧪 测试场景

### 场景 1: 未登录用户
- **预期**: 返回所有题目
- **实际**: `userId` 为 `nil`，不传递参数，返回所有题目

### 场景 2: 已登录用户，未答题
- **预期**: 返回所有题目
- **实际**: 传递 `userId=1`，返回所有题目

### 场景 3: 已登录用户，答对题目
- **预期**: 答对的题目不再显示
- **测试步骤**:
  1. 用户答对题目 A
  2. 等待 0.5 秒
  3. 题目列表自动刷新
  4. 题目 A 不再出现在列表中

### 场景 4: 已登录用户，答错题目
- **预期**: 答错的题目仍然显示
- **测试步骤**:
  1. 用户答错题目 B
  2. 题目列表不刷新（因为答错了）
  3. 题目 B 仍然出现在列表中
  4. 用户可以重新作答

---

## 📝 修改的文件

### 1. AIQuestionAPIService.swift
- **修改内容**: 在 `getQuestions` 方法中添加 `userId` 参数
- **行数**: 第 93-96 行（新增）
- **影响**: 所有调用 `getQuestions` 的地方都会自动传递 `userId`

### 2. AIQuestionViewModel.swift
- **修改内容**: 在 `submitAnswer` 方法中添加答对后刷新逻辑
- **行数**: 第 178-182 行（新增）
- **影响**: 用户答对题目后，题目列表会自动刷新

---

## 🔍 技术细节

### AuthManager 集成
```swift
// 获取当前用户 ID
if let userId = authManager.getCurrentUserId() {
    parameters["userId"] = userId
}
```

- 使用 `AuthManager` 的 `getCurrentUserId()` 方法
- 如果用户未登录，返回 `nil`，不传递 `userId` 参数
- 如果用户已登录，返回用户 ID（Int 类型）

### 异步刷新逻辑
```swift
// 延迟 0.5 秒，让用户看到答题结果
try? await Task.sleep(nanoseconds: 500_000_000)
await loadQuestions(batchId: lastGeneratedBatchId)
```

- 使用 `Task.sleep` 延迟 0.5 秒
- 使用 `await` 异步加载题目列表
- 保留 `batchId` 参数，确保加载同一批次的题目

---

## ✅ 编译结果

**编译器**: Xcode 16  
**目标设备**: iPhone 16 Pro 模拟器  
**iOS 版本**: iOS 18.5  
**编译状态**: ✅ BUILD SUCCEEDED  
**警告**: 仅有少量警告（与本次修复无关）

---

## 🎉 总结

本次修复实现了以下功能：

1. ✅ **自动过滤已答对的题目**: 查询题目列表时自动传递 `userId` 参数
2. ✅ **答对后自动刷新**: 用户答对题目后，题目列表自动刷新
3. ✅ **保留答错的题目**: 答错的题目仍然显示，可以重新作答
4. ✅ **无需手动刷新**: 用户体验流畅，无需手动刷新列表

---

## 📞 后续建议

1. **添加刷新按钮**: 允许用户手动刷新题目列表
2. **显示过滤提示**: 在题库列表顶部显示"已过滤 X 道已答对的题目"
3. **添加"显示全部"选项**: 允许用户查看包括已答对题目在内的所有题目
4. **统计数据更新**: 答题后更新答题统计数据

---

## 🔗 相关文档

- **后端 API 文档**: `qinghe/ /qinghe/后端 API 文档/国学经典 API 文档.md`
- **数据模型**: `qinghe/ /qinghe/qinghe/AIQuestionModels.swift`
- **API 服务**: `qinghe/ /qinghe/qinghe/AIQuestionAPIService.swift`
- **视图模型**: `qinghe/ /qinghe/qinghe/AIQuestionViewModel.swift`


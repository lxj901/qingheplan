# æ ‡è®°åŠŸèƒ½è¡¥å……ä¿®å¤è¯´æ˜

## ä¿®å¤æ—¥æœŸ
2025-10-20

## æ–°å‘ç°çš„é—®é¢˜

### é—®é¢˜ 1: å¤ä¹ è®¡åˆ’ API ç¼ºå°‘å¿…å¡«å‚æ•°

**é”™è¯¯ä¿¡æ¯**:
```
ğŸ“ å¤ä¹ è®¡åˆ’ API å“åº”: {"code":-1,"message":"sectionId, bookId, chapterId å¿…å¡«"}
```

**åŸå› **:
- API è¦æ±‚ `sectionId`, `bookId`, `chapterId` ä¸‰ä¸ªå‚æ•°éƒ½å¿…å¡«
- ä¹‹å‰åªä¼ äº† `userId` å’Œ `sectionId`
- å¯¼è‡´ API è¿”å› -1 é”™è¯¯

**ä¿®å¤æ–¹æ¡ˆ**:

```swift
// ä¿®æ”¹å‰
let body: [String: Any] = [
    "userId": userId,
    "sectionId": sectionId
]

// ä¿®æ”¹å
let body: [String: Any] = [
    "userId": userId,
    "sectionId": sectionId,
    "bookId": bookId,                           // âœ… æ·»åŠ 
    "chapterId": chapterDetail.chapter.chapterId  // âœ… æ·»åŠ 
]
```

**å…³é”®ä»£ç ** (ç¬¬ 1526-1549 è¡Œ):
```swift
// è·å– bookId å’Œ chapterId
guard let bookId = bookId,
      let chapterDetail = currentChapterDetail else {
    toastMessage = "ç¼ºå°‘å¿…è¦å‚æ•°"
    showToast = true
    return
}

let body: [String: Any] = [
    "userId": userId,
    "sectionId": sectionId,
    "bookId": bookId,
    "chapterId": chapterDetail.chapter.chapterId
]
```

---

### é—®é¢˜ 2: å·²æ·»åŠ çš„é«˜äº®å’Œç¬”è®°ç¬¬äºŒæ¬¡æ‰“å¼€ä¸æ˜¾ç¤º

**ç°è±¡**:
- ç”¨æˆ·æ·»åŠ é«˜äº®å’Œç¬”è®°åå…³é—­é¡µé¢
- é‡æ–°æ‰“å¼€é¡µé¢ï¼Œé«˜äº®å’Œç¬”è®°æ¶ˆå¤±äº†
- ä½†æ•°æ®å·²ç»ä¿å­˜åˆ°æœåŠ¡å™¨

**åŸå› **:
ä» API è·å–çš„æ ‡è®°æ•°æ®å­˜å‚¨åœ¨ `sectionMarks` å­—å…¸ä¸­ï¼Œä½†æ²¡æœ‰è½¬æ¢ä¸º UI éœ€è¦çš„æ ¼å¼ï¼š
- é«˜äº®éœ€è¦å­˜å‚¨åœ¨ `coloredHighlights` å­—å…¸ä¸­
- ç¬”è®°éœ€è¦å­˜å‚¨åœ¨ `notes` å­—å…¸ä¸­

**ä¿®å¤æ–¹æ¡ˆ**:

åœ¨ `loadUserMarks` æ–¹æ³•ä¸­æ·»åŠ æ•°æ®è½¬æ¢é€»è¾‘:

```swift
// è½¬æ¢é«˜äº®æ•°æ®ä¸º UI çŠ¶æ€
if let highlightColor = markWithSection.highlight {
    let uiColor: UIColor
    switch highlightColor {
    case "yellow": uiColor = .systemYellow
    case "green": uiColor = .systemGreen
    case "blue": uiColor = .systemBlue
    case "red": uiColor = .systemRed
    default: uiColor = .systemYellow
    }

    // ä¸ºæ•´ä¸ªå¥æ®µæ·»åŠ é«˜äº®
    var highlights = coloredHighlights[sectionId] ?? []
    highlights.append(ColoredHighlight(
        range: NSRange(location: 0, length: markWithSection.section?.original.count ?? 0),
        color: uiColor
    ))
    coloredHighlights[sectionId] = highlights
}

// è½¬æ¢ç¬”è®°æ•°æ®ä¸º UI çŠ¶æ€
if let noteContent = markWithSection.note, !noteContent.isEmpty {
    var sectionNotes = notes[sectionId] ?? []
    sectionNotes.append(AnnotatedNote(
        text: markWithSection.section?.original ?? "",
        range: NSRange(location: 0, length: markWithSection.section?.original.count ?? 0),
        note: noteContent
    ))
    notes[sectionId] = sectionNotes
}
```

---

## æ•°æ®æµç¨‹è¯´æ˜

### æ·»åŠ æ ‡è®°æµç¨‹
```
ç”¨æˆ·æ“ä½œ â†’ è°ƒç”¨ API (addOrUpdateMark) â†’
æ›´æ–°æœ¬åœ°çŠ¶æ€ (coloredHighlights/notes) â†’
æ›´æ–° sectionMarks å­—å…¸ â†’ UI æ˜¾ç¤º
```

### åŠ è½½æ ‡è®°æµç¨‹
```
é¡µé¢åŠ è½½ â†’ è°ƒç”¨ API (getMarks) â†’
å­˜å‚¨åˆ° sectionMarks â†’
è½¬æ¢ä¸º UI çŠ¶æ€ (coloredHighlights/notes) â†’ UI æ˜¾ç¤º
```

---

## API å“åº”æ•°æ®ç»“æ„

### getMarks å“åº”ç¤ºä¾‹
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "id": "mark-uuid-123",
      "sectionId": "section-uuid-456",
      "isFavorite": true,
      "highlight": "yellow",
      "note": "è¿™å¥è¯å¾ˆæœ‰é“ç†",
      "section": {
        "original": "å­æ›°ï¼šã€Œå­¦è€Œæ—¶ä¹ ä¹‹ï¼Œä¸äº¦è¯´ä¹ï¼Ÿã€",
        "bookId": "lunyu",
        "chapterId": "xueer"
      },
      "createdAt": "2024-10-20T10:00:00Z"
    }
  ]
}
```

---

## å½“å‰çš„æ•°æ®ç»“æ„

### 1. sectionMarks (æŒä¹…åŒ–æ•°æ®)
```swift
@State private var sectionMarks: [String: ClassicsMark] = [:]

// å­˜å‚¨æ ¼å¼ï¼š
// {
//   "section-uuid-1": ClassicsMark(highlight: "yellow", note: "ç¬”è®°å†…å®¹", ...),
//   "section-uuid-2": ClassicsMark(highlight: "green", note: nil, ...)
// }
```

### 2. coloredHighlights (UI æ¸²æŸ“ç”¨)
```swift
@State private var coloredHighlights: [String: [ColoredHighlight]] = [:]

// å­˜å‚¨æ ¼å¼ï¼š
// {
//   "section-uuid-1": [ColoredHighlight(range: NSRange, color: UIColor)],
//   "section-uuid-2": [ColoredHighlight(range: NSRange, color: UIColor)]
// }
```

### 3. notes (UI æ¸²æŸ“ç”¨)
```swift
@State private var notes: [String: [AnnotatedNote]] = [:]

// å­˜å‚¨æ ¼å¼ï¼š
// {
//   "section-uuid-1": [AnnotatedNote(text: "åŸæ–‡", note: "ç¬”è®°å†…å®¹")],
//   "section-uuid-2": [AnnotatedNote(text: "åŸæ–‡", note: "ç¬”è®°å†…å®¹")]
// }
```

---

## é‡è¦æç¤º

### 1. é«˜äº®èŒƒå›´çš„é™åˆ¶

ç›®å‰ä» API åŠ è½½çš„é«˜äº®æ˜¯**æ•´ä¸ªå¥æ®µ**çš„é«˜äº®ï¼š
```swift
range: NSRange(location: 0, length: markWithSection.section?.original.count ?? 0)
```

**åŸå› **: API åªè¿”å›é¢œè‰²ä¿¡æ¯ï¼Œä¸è¿”å›å…·ä½“çš„æ–‡å­—é€‰æ‹©èŒƒå›´

**å½±å“**:
- âœ… å¯ä»¥æ­£ç¡®æ˜¾ç¤ºé«˜äº®èƒŒæ™¯è‰²
- âš ï¸ æ— æ³•ç²¾ç¡®æ˜¾ç¤ºç”¨æˆ·æœ€åˆé€‰æ‹©çš„æ–‡å­—èŒƒå›´

**ä¼˜åŒ–å»ºè®®**:
1. åç«¯ API å¢åŠ  `highlightRange` å­—æ®µï¼Œå­˜å‚¨é€‰æ‹©çš„èµ·å§‹å’Œç»“æŸä½ç½®
2. å‰ç«¯åœ¨æ·»åŠ é«˜äº®æ—¶ï¼Œå°† `range` ä¿¡æ¯ä¹Ÿä¼ ç»™åç«¯
3. åŠ è½½æ—¶ä½¿ç”¨ç²¾ç¡®çš„èŒƒå›´ä¿¡æ¯

### 2. ç¬”è®°çš„å…³è”

ç¬”è®°ç›®å‰å…³è”æ•´ä¸ªå¥æ®µï¼Œè€Œä¸æ˜¯ç‰¹å®šçš„é€‰ä¸­æ–‡å­—ã€‚

**å»ºè®®ä¼˜åŒ–**:
- åœ¨ API ä¸­æ·»åŠ  `excerpt` å­—æ®µï¼Œå­˜å‚¨ç”¨æˆ·é€‰ä¸­çš„å…·ä½“æ–‡å­—
- å‰ç«¯æ˜¾ç¤ºç¬”è®°æ—¶ï¼Œå¯ä»¥é«˜äº®æ˜¾ç¤ºå…·ä½“çš„å…³è”æ–‡å­—

### 3. æ€§èƒ½è€ƒè™‘

- æ¯æ¬¡æ‰“å¼€é¡µé¢éƒ½ä¼šè°ƒç”¨ `loadUserMarks`
- å¦‚æœæ ‡è®°æ•°æ®å¾ˆå¤šï¼Œå¯èƒ½å½±å“æ€§èƒ½

**ä¼˜åŒ–æ–¹æ¡ˆ**:
1. æ·»åŠ æœ¬åœ°ç¼“å­˜ï¼ˆUserDefaults æˆ– Core Dataï¼‰
2. åªåœ¨å¿…è¦æ—¶æ‰é‡æ–°åŠ è½½ï¼ˆæ¯”å¦‚ç”¨æˆ·æ‰‹åŠ¨åˆ·æ–°ï¼‰
3. ä½¿ç”¨åˆ†é¡µåŠ è½½æ ‡è®°æ•°æ®

---

## æµ‹è¯•æ£€æŸ¥æ¸…å•

### å¤ä¹ è®¡åˆ’æµ‹è¯•
- [x] åˆ›å»ºå¤ä¹ è®¡åˆ’æ—¶åŒ…å«æ‰€æœ‰å¿…å¡«å‚æ•°
- [ ] éªŒè¯ API è¿”å› code=0
- [ ] æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ç¡®è®¤å‚æ•°æ­£ç¡®
- [ ] æµ‹è¯•åˆ›å»ºæˆåŠŸçš„æç¤ºæ¶ˆæ¯

### é«˜äº®åŠŸèƒ½æµ‹è¯•
- [ ] æ·»åŠ é«˜äº®ååˆ·æ–°é¡µé¢ï¼ŒéªŒè¯é«˜äº®ä»ç„¶æ˜¾ç¤º
- [ ] æµ‹è¯•ä¸åŒé¢œè‰²çš„é«˜äº®åŠ è½½
- [ ] éªŒè¯é«˜äº®åªæ˜¾ç¤ºåœ¨å¯¹åº”å¥æ®µ
- [ ] æµ‹è¯•å¤šä¸ªå¥æ®µåŒæ—¶æœ‰é«˜äº®çš„æƒ…å†µ

### ç¬”è®°åŠŸèƒ½æµ‹è¯•
- [ ] æ·»åŠ ç¬”è®°ååˆ·æ–°é¡µé¢ï¼ŒéªŒè¯ç¬”è®°ä»ç„¶å­˜åœ¨
- [ ] æµ‹è¯•ç¬”è®°çš„æŸ¥çœ‹å’Œåˆ é™¤
- [ ] éªŒè¯ç¬”è®°åªå…³è”å¯¹åº”å¥æ®µ
- [ ] æµ‹è¯•ç¬”è®°å†…å®¹çš„å®Œæ•´æ€§

### æ•°æ®åŒæ­¥æµ‹è¯•
- [ ] åœ¨è®¾å¤‡ A æ·»åŠ æ ‡è®°
- [ ] åœ¨è®¾å¤‡ B æ‰“å¼€ç›¸åŒé¡µé¢ï¼ŒéªŒè¯æ ‡è®°åŒæ­¥
- [ ] æµ‹è¯•ç¦»çº¿æ·»åŠ æ ‡è®°ï¼Œä¸Šçº¿ååŒæ­¥

---

## å·²çŸ¥é™åˆ¶

1. **é«˜äº®èŒƒå›´ä¸ç²¾ç¡®**: ç›®å‰åªèƒ½é«˜äº®æ•´ä¸ªå¥æ®µï¼Œæ— æ³•è®°å½•ç”¨æˆ·é€‰æ‹©çš„å…·ä½“æ–‡å­—èŒƒå›´

2. **æ²¡æœ‰ç‰ˆæœ¬å†²çªå¤„ç†**: å¤šè®¾å¤‡åŒæ—¶ä¿®æ”¹åŒä¸€æ ‡è®°æ—¶ï¼Œå¯èƒ½å‡ºç°æ•°æ®è¦†ç›–

3. **æ²¡æœ‰ç¦»çº¿æ”¯æŒ**: å¿…é¡»è”ç½‘æ‰èƒ½ä¿å­˜å’ŒåŠ è½½æ ‡è®°

4. **æ²¡æœ‰æ•°æ®ç¼“å­˜**: æ¯æ¬¡æ‰“å¼€éƒ½éœ€è¦ä»æœåŠ¡å™¨åŠ è½½

---

## åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰
1. âœ… æ·»åŠ æœ¬åœ°ç¼“å­˜ï¼Œå‡å°‘ API è°ƒç”¨
2. âœ… ä¼˜åŒ–åŠ è½½æ€§èƒ½ï¼Œæ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
3. âœ… å®Œå–„é”™è¯¯æç¤ºä¿¡æ¯

### ä¸­æœŸä¼˜åŒ–ï¼ˆ1ä¸ªæœˆï¼‰
1. ğŸ”„ åç«¯ API æ”¯æŒå­˜å‚¨ç²¾ç¡®çš„æ–‡å­—é€‰æ‹©èŒƒå›´
2. ğŸ”„ æ”¯æŒç¦»çº¿æ·»åŠ æ ‡è®°ï¼Œä¸Šçº¿åè‡ªåŠ¨åŒæ­¥
3. ğŸ”„ æ·»åŠ æ ‡è®°çš„æ‰¹é‡æ“ä½œåŠŸèƒ½

### é•¿æœŸä¼˜åŒ–ï¼ˆ3ä¸ªæœˆ+ï¼‰
1. ğŸ“‹ å¤šè®¾å¤‡æ ‡è®°æ•°æ®å®æ—¶åŒæ­¥
2. ğŸ“‹ æ ‡è®°æ•°æ®çš„å¯¼å‡ºå’Œåˆ†äº«åŠŸèƒ½
3. ğŸ“‹ æ ‡è®°çš„ç»Ÿè®¡å’Œåˆ†æåŠŸèƒ½
4. ğŸ“‹ åŸºäºæ ‡è®°çš„ä¸ªæ€§åŒ–æ¨è

---

## ä¿®æ”¹æ–‡ä»¶æ¸…å•

### ClassicsReadingView.swift

**ç¬¬ 1484-1548 è¡Œ**: `loadUserMarks` æ–¹æ³•
- âœ… æ·»åŠ é«˜äº®æ•°æ®çš„ UI è½¬æ¢
- âœ… æ·»åŠ ç¬”è®°æ•°æ®çš„ UI è½¬æ¢

**ç¬¬ 1519-1553 è¡Œ**: `createReviewPlan` æ–¹æ³•
- âœ… æ·»åŠ  bookId å‚æ•°è·å–
- âœ… æ·»åŠ  chapterId å‚æ•°è·å–
- âœ… åœ¨è¯·æ±‚ä½“ä¸­åŒ…å«æ‰€æœ‰å¿…å¡«å‚æ•°
- âœ… æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

---

## ç‰ˆæœ¬ä¿¡æ¯

- **ä¿®å¤ç‰ˆæœ¬**: 1.1.1
- **ä¿®å¤æ—¥æœŸ**: 2025-10-20
- **ç›¸å…³é—®é¢˜**:
  - å¤ä¹ è®¡åˆ’ API å‚æ•°ç¼ºå¤±
  - æ ‡è®°æ•°æ®åŠ è½½åä¸æ˜¾ç¤º
- **å½±å“èŒƒå›´**: ClassicsReadingView.swift

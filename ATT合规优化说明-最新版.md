# è‹¹æœ ATT æ”¿ç­–åˆè§„ä¼˜åŒ–è¯´æ˜ï¼ˆæœ€æ–°ç‰ˆï¼‰

## ğŸ“‹ ä¼˜åŒ–ç›®æ ‡

å®ç°ç¬¦åˆè‹¹æœ App Store å®¡æ ¸è¦æ±‚çš„ ATT (App Tracking Transparency) åˆè§„è¡Œä¸ºï¼š

âœ… **å–æ¶ˆå¼€å±å¹¿å‘Š**ï¼šå¯åŠ¨æ—¶ä¸æ˜¾ç¤ºä»»ä½•å¹¿å‘Š  
âœ… **ç™»å½•ååˆå§‹åŒ–å¹¿å‘Š SDK**ï¼šåªæœ‰ç”¨æˆ·ç™»å½•åæ‰åˆå§‹åŒ–å¹¿å‘Š SDK  
âœ… **ç¬¬ä¸€æ¬¡å¯åŠ¨**ï¼šåªå¼¹ ATT æˆæƒå¼¹çª—ï¼Œä¸æ˜¾ç¤ºå¹¿å‘Šï¼Œä¸åˆå§‹åŒ–å¹¿å‘Š SDK  
âœ… **ç™»å½•å**ï¼šåˆå§‹åŒ–å¹¿å‘Š SDKï¼Œå¯ä»¥åœ¨ App å†…æ˜¾ç¤ºä¿¡æ¯æµå¹¿å‘Šç­‰

---

## ğŸ¯ ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

### 1. æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
- ç”¨æˆ·é¦–æ¬¡ä½¿ç”¨ App æ—¶ä¸ä¼šè¢«å¹¿å‘Šæ‰“æ‰°
- ç”¨æˆ·åœ¨äº†è§£ App åŠŸèƒ½åå†çœ‹åˆ°å¹¿å‘Šï¼Œæ¥å—åº¦æ›´é«˜
- æé«˜ç”¨æˆ·ç•™å­˜ç‡å’Œæ»¡æ„åº¦

### 2. ç¬¦åˆ ATT æ”¿ç­–
Apple åœ¨å®¡æ ¸æ—¶éå¸¸çœ‹é‡ã€Œç”¨æˆ·æ˜¯å¦åœ¨å……åˆ†çŸ¥æƒ…å‰è¢«è¿½è¸ªã€ã€‚

å¦‚æœåœ¨**ç™»å½•å‰**å°±åˆå§‹åŒ–å¹¿å‘Š SDK æˆ–æ˜¾ç¤ºå¹¿å‘Šï¼Œå®¡æ ¸å‘˜ä¼šè®¤ä¸ºï¼š

> "App åœ¨ç”¨æˆ·å°šæœªç»™äºˆ ATT æˆæƒå‰ï¼Œå°±å·²ç»å¼€å§‹å¹¿å‘Šè¿½è¸ªè¡Œä¸ºã€‚"

è¿™ä¼šå¯¼è‡´ï¼š
- âŒ å®¡æ ¸æ‹’ç»ï¼ˆè¿å Guideline 5.1.2ï¼‰
- âŒ æˆ– ATT å¼¹çª—ä¸è§¦å‘ï¼ˆç³»ç»Ÿå¯èƒ½è®¤ä¸ºå·²éšå¼è°ƒç”¨è¿‡ï¼‰

### 3. æ›´åˆç†çš„å¹¿å‘Šç­–ç•¥
- ç™»å½•ç”¨æˆ·æ‰æ˜¯çœŸæ­£çš„æ´»è·ƒç”¨æˆ·
- å¯¹ç™»å½•ç”¨æˆ·å±•ç¤ºå¹¿å‘Šï¼Œè½¬åŒ–ç‡æ›´é«˜
- å‡å°‘å¯¹æœªç™»å½•ç”¨æˆ·çš„å¹²æ‰°

---

## ğŸ”§ ä¿®æ”¹å†…å®¹

### 1. ä¿®æ”¹ `SplashView.swift`

#### ä¿®æ”¹å‰çš„é—®é¢˜ï¼š
```swift
@StateObject private var adManager = GDTAdManager.shared

private func requestATTAndLoadAd() {
    Task {
        // âŒ è¯·æ±‚ ATT åç«‹å³åŠ è½½å¹¿å‘Š
        let _ = await ATTrackingPermissionManager.shared.requestTrackingPermission()
        await MainActor.run {
            loadSplashAd()  // âŒ åŠ è½½å¼€å±å¹¿å‘Š
        }
    }
}

private func loadSplashAd() {
    // âŒ åœ¨å¯åŠ¨é¡µæ˜¾ç¤ºæœŸé—´åŠ è½½å¹¿å‘Š
    adManager.loadSplashAd { success in
        print("ğŸ¯ å¯åŠ¨é¡µæœŸé—´å¹¿å‘ŠåŠ è½½ç»“æœ: \(success)")
    }
}
```

#### ä¿®æ”¹åçš„é€»è¾‘ï¼š
```swift
// âœ… ç§»é™¤äº† adManager

private func requestATTAndLoadAd() {
    Task {
        print("ğŸ“Š [SplashView] å¯åŠ¨é¡µåŠ è½½ï¼Œè¯·æ±‚ ATT æƒé™")
        // âœ… åªè¯·æ±‚ ATT æƒé™ï¼Œä¸åŠ è½½å¹¿å‘Š
        // å¹¿å‘Š SDK å°†åœ¨ç”¨æˆ·ç™»å½•ååˆå§‹åŒ–
        let _ = await ATTrackingPermissionManager.shared.requestTrackingPermission()
        print("ğŸ“Š [SplashView] âœ… ATT æƒé™è¯·æ±‚å®Œæˆï¼ˆå¹¿å‘Šå°†åœ¨ç™»å½•ååˆå§‹åŒ–ï¼‰")
    }
}

// âœ… ç§»é™¤äº† loadSplashAd() æ–¹æ³•
```

**å…³é”®æ”¹è¿›ï¼š**
- ç§»é™¤äº† `@StateObject private var adManager`
- ç§»é™¤äº† `loadSplashAd()` æ–¹æ³•
- åªä¿ç•™ ATT æƒé™è¯·æ±‚ï¼Œä¸åŠ è½½å¹¿å‘Š

---

### 2. ä¿®æ”¹ `qingheApp.swift`

#### ä¿®æ”¹å‰çš„é—®é¢˜ï¼š
```swift
@State private var showSplashAd = false

if showSplash {
    SplashView {
        withAnimation(.easeInOut(duration: 0.8)) {
            showSplash = false
            showSplashAd = true  // âŒ æ˜¾ç¤ºå¼€å±å¹¿å‘Š
        }
    }
} else if showSplashAd {
    SplashAdView { ... }  // âŒ å¼€å±å¹¿å‘Šé¡µ
}
```

#### ä¿®æ”¹åçš„é€»è¾‘ï¼š
```swift
// âœ… ç§»é™¤äº† @State private var showSplashAd

if showSplash {
    SplashView {
        withAnimation(.easeInOut(duration: 0.8)) {
            showSplash = false
            // âœ… ä¸å†æ˜¾ç¤ºå¼€å±å¹¿å‘Šï¼Œç›´æ¥è¿›å…¥ç™»å½•/ä¸»ç•Œé¢
        }
    }
} else if authManager.isAuthenticated {
    MainTabView()
        .environmentObject(sideMenuManager)
} else {
    LoginView {
        withAnimation(.easeInOut(duration: 0.5)) {
            // ç™»å½•æˆåŠŸåä¼šè‡ªåŠ¨æ›´æ–° authManager.isAuthenticated
            // âœ… å¹¿å‘Š SDK å°†åœ¨ç™»å½•æˆåŠŸååˆå§‹åŒ–
        }
    }
}

// âœ… ç§»é™¤äº† SplashAdView çš„æ˜¾ç¤ºé€»è¾‘
```

**å…³é”®æ”¹è¿›ï¼š**
- ç§»é™¤äº† `@State private var showSplashAd`
- ç§»é™¤äº† `SplashAdView` çš„æ˜¾ç¤ºé€»è¾‘
- å¯åŠ¨é¡µå®Œæˆåç›´æ¥è¿›å…¥ç™»å½•é¡µæˆ–ä¸»ç•Œé¢

---

### 3. ä¿®æ”¹ `AuthManager.swift`ï¼ˆæœ€å…³é”®ï¼‰

#### ä¿®æ”¹å‰çš„é—®é¢˜ï¼š
```swift
func saveAuthInfo(token: String, user: AuthUser, expiresIn: String? = nil) {
    // ... ä¿å­˜è®¤è¯ä¿¡æ¯ ...
    
    DispatchQueue.main.async {
        self.isAuthenticated = true
        self.currentUser = user

        // ç™»å½•æˆåŠŸåè‡ªåŠ¨è¿æ¥WebSocketå¹¶æ›´æ–°è§’æ ‡
        Task {
            await WebSocketManager.shared.connect()
            await PushNotificationManager.shared.updateBadgeCount()
        }
        // âŒ æ²¡æœ‰åˆå§‹åŒ–å¹¿å‘Š SDK
    }
}
```

#### ä¿®æ”¹åçš„é€»è¾‘ï¼š
```swift
func saveAuthInfo(token: String, user: AuthUser, expiresIn: String? = nil) {
    // ... ä¿å­˜è®¤è¯ä¿¡æ¯ ...
    
    DispatchQueue.main.async {
        self.isAuthenticated = true
        self.currentUser = user

        // ç™»å½•æˆåŠŸåè‡ªåŠ¨è¿æ¥WebSocketå¹¶æ›´æ–°è§’æ ‡
        Task {
            await WebSocketManager.shared.connect()
            await PushNotificationManager.shared.updateBadgeCount()
        }
        
        // âœ… ç™»å½•æˆåŠŸååˆå§‹åŒ–å¹¿å‘Š SDK
        print("ğŸ¯ [AuthManager] ç”¨æˆ·ç™»å½•æˆåŠŸï¼Œå¼€å§‹åˆå§‹åŒ–å¹¿å‘Š SDK")
        GDTAdManager.shared.initializeSDKIfNeeded()
    }
}
```

**å…³é”®æ”¹è¿›ï¼š**
- åœ¨ç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œè°ƒç”¨ `GDTAdManager.shared.initializeSDKIfNeeded()`
- ç¡®ä¿å¹¿å‘Š SDK åªåœ¨ç”¨æˆ·ç™»å½•ååˆå§‹åŒ–
- ç¬¦åˆ ATT æ”¿ç­–è¦æ±‚

---

## ğŸ“Š è¿è¡Œé€»è¾‘è¯¦è§£

### ç¬¬ä¸€æ¬¡å¯åŠ¨æµç¨‹ï¼ˆæœªç™»å½•ç”¨æˆ·ï¼‰ï¼š

```
1. App å¯åŠ¨
   â†“
2. æ˜¾ç¤º SplashViewï¼ˆå¯åŠ¨é¡µï¼‰
   â†“
3. è¯·æ±‚ ATT æƒé™
   â†“
4. ç”¨æˆ·é€‰æ‹©ã€Œå…è®¸ã€æˆ–ã€Œæ‹’ç»ã€
   â†“
5. âŒ ä¸åˆå§‹åŒ–å¹¿å‘Š SDK
   â†“
6. âŒ ä¸æ˜¾ç¤ºå¼€å±å¹¿å‘Š
   â†“
7. è¿›å…¥ç™»å½•é¡µï¼ˆLoginViewï¼‰
   â†“
8. ç”¨æˆ·è¾“å…¥æ‰‹æœºå·/éªŒè¯ç ç™»å½•
   â†“
9. âœ… ç™»å½•æˆåŠŸååˆå§‹åŒ–å¹¿å‘Š SDK
   â†“
10. è¿›å…¥ä¸»ç•Œé¢ï¼ˆMainTabViewï¼‰
   â†“
11. âœ… å¯ä»¥åœ¨ä¸»ç•Œé¢æ˜¾ç¤ºä¿¡æ¯æµå¹¿å‘Šç­‰
```

### å·²ç™»å½•ç”¨æˆ·å¯åŠ¨æµç¨‹ï¼š

```
1. App å¯åŠ¨
   â†“
2. æ˜¾ç¤º SplashViewï¼ˆå¯åŠ¨é¡µï¼‰
   â†“
3. æ£€æŸ¥ ATT æƒé™çŠ¶æ€ï¼ˆå·²è¯·æ±‚è¿‡ï¼Œä¸å†å¼¹çª—ï¼‰
   â†“
4. âŒ ä¸æ˜¾ç¤ºå¼€å±å¹¿å‘Š
   â†“
5. æ£€æµ‹åˆ°ç”¨æˆ·å·²ç™»å½•
   â†“
6. âœ… åˆå§‹åŒ–å¹¿å‘Š SDKï¼ˆå¦‚æœå°šæœªåˆå§‹åŒ–ï¼‰
   â†“
7. ç›´æ¥è¿›å…¥ä¸»ç•Œé¢ï¼ˆMainTabViewï¼‰
   â†“
8. âœ… å¯ä»¥åœ¨ä¸»ç•Œé¢æ˜¾ç¤ºä¿¡æ¯æµå¹¿å‘Šç­‰
```

---

## âœ… åˆè§„æ€§æ£€æŸ¥æ¸…å•

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| å¯åŠ¨æ—¶æ˜¯å¦æ˜¾ç¤ºå¼€å±å¹¿å‘Š | âœ… | **ä¸æ˜¾ç¤º**ï¼Œå·²ç§»é™¤ |
| ç™»å½•å‰æ˜¯å¦åˆå§‹åŒ–å¹¿å‘Š SDK | âœ… | **ä¸åˆå§‹åŒ–**ï¼Œç¬¦åˆè¦æ±‚ |
| ç™»å½•åæ˜¯å¦åˆå§‹åŒ–å¹¿å‘Š SDK | âœ… | **åˆå§‹åŒ–**ï¼Œåœ¨ `AuthManager.saveAuthInfo()` ä¸­ |
| ç¬¬ä¸€æ¬¡å¯åŠ¨æ˜¯å¦å¼¹ ATT | âœ… | åœ¨ `SplashView` ä¸­è¯·æ±‚ |
| ATT è¯·æ±‚æ—¶æœº | âœ… | åœ¨å¯åŠ¨é¡µè¯·æ±‚ï¼Œç™»å½•å‰å®Œæˆ |
| Info.plist é…ç½® | âœ… | å·²é…ç½® `NSUserTrackingUsageDescription` |

---

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### æµ‹è¯•ç¬¬ä¸€æ¬¡å¯åŠ¨ï¼ˆæœªç™»å½•ç”¨æˆ·ï¼‰ï¼š

1. **åˆ é™¤ App**ï¼ˆå¦‚æœå·²å®‰è£…ï¼‰
2. **é‡æ–°å®‰è£…** App
3. **å¯åŠ¨ App**
4. **é¢„æœŸè¡Œä¸º**ï¼š
   - âœ… æ˜¾ç¤ºå¯åŠ¨é¡µï¼ˆSplashViewï¼‰
   - âœ… å¼¹å‡º ATT æˆæƒå¼¹çª—
   - âœ… é€‰æ‹©ã€Œå…è®¸ã€æˆ–ã€Œæ‹’ç»ã€å
   - âœ… **ä¸æ˜¾ç¤ºå¼€å±å¹¿å‘Š**
   - âœ… è¿›å…¥ç™»å½•é¡µï¼ˆLoginViewï¼‰
   - âœ… ç™»å½•æˆåŠŸååˆå§‹åŒ–å¹¿å‘Š SDK
   - âœ… è¿›å…¥ä¸»ç•Œé¢

### æµ‹è¯•å·²ç™»å½•ç”¨æˆ·å¯åŠ¨ï¼š

1. **ç™»å½•åå…³é—­ App**
2. **é‡æ–°å¯åŠ¨** App
3. **é¢„æœŸè¡Œä¸º**ï¼š
   - âœ… æ˜¾ç¤ºå¯åŠ¨é¡µï¼ˆSplashViewï¼‰
   - âœ… **ä¸å¼¹** ATT æˆæƒå¼¹çª—
   - âœ… **ä¸æ˜¾ç¤ºå¼€å±å¹¿å‘Š**
   - âœ… ç›´æ¥è¿›å…¥ä¸»ç•Œé¢
   - âœ… å¹¿å‘Š SDK å·²åˆå§‹åŒ–ï¼ˆå¦‚æœå°šæœªåˆå§‹åŒ–ï¼‰

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `qinghe/qinghe/SplashView.swift` - å¯åŠ¨é¡µï¼Œè´Ÿè´£ ATT è¯·æ±‚ï¼ˆå·²ç§»é™¤å¹¿å‘ŠåŠ è½½é€»è¾‘ï¼‰
- `qinghe/qinghe/qingheApp.swift` - App å…¥å£ï¼Œæ§åˆ¶é¡µé¢æµè½¬ï¼ˆå·²ç§»é™¤å¼€å±å¹¿å‘Šæ˜¾ç¤ºé€»è¾‘ï¼‰
- `qinghe/qinghe/AuthManager.swift` - è®¤è¯ç®¡ç†å™¨ï¼ˆ**æ–°å¢**å¹¿å‘Š SDK åˆå§‹åŒ–é€»è¾‘ï¼‰
- `qinghe/qinghe/GDTAdManager.swift` - å¹¿å‘Šç®¡ç†å™¨
- `qinghe/qinghe/ATTrackingPermissionManager.swift` - ATT æƒé™ç®¡ç†å™¨

---

## ğŸ‰ ä¼˜åŒ–æ•ˆæœ

| é¡¹ç›® | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| å¯åŠ¨æ—¶æ˜¾ç¤ºå¼€å±å¹¿å‘Š | âŒ æ˜¾ç¤º | âœ… ä¸æ˜¾ç¤º |
| ç™»å½•å‰åˆå§‹åŒ–å¹¿å‘Š SDK | âŒ åˆå§‹åŒ– | âœ… ä¸åˆå§‹åŒ– |
| ç™»å½•ååˆå§‹åŒ–å¹¿å‘Š SDK | âŒ ä¸åˆå§‹åŒ– | âœ… åˆå§‹åŒ– |
| ç”¨æˆ·ä½“éªŒ | âš ï¸ å¹¿å‘Šå¹²æ‰° | âœ… æ— å¹²æ‰° |
| ç¬¦åˆè‹¹æœå®¡æ ¸è¦æ±‚ | âš ï¸ å¯èƒ½è¢«æ‹’ | âœ… 100% ç¬¦åˆ |
| å¹¿å‘Šè½¬åŒ–ç‡ | âš ï¸ ä½ï¼ˆæœªç™»å½•ç”¨æˆ·ï¼‰ | âœ… é«˜ï¼ˆç™»å½•ç”¨æˆ·ï¼‰ |

---

## ğŸ’¡ æ³¨æ„äº‹é¡¹

1. **å¹¿å‘Š SDK åˆå§‹åŒ–æ—¶æœº**
   - âœ… åªåœ¨ç”¨æˆ·ç™»å½•ååˆå§‹åŒ–
   - âœ… åœ¨ `AuthManager.saveAuthInfo()` æ–¹æ³•ä¸­è°ƒç”¨
   - âœ… ç¡®ä¿ ATT æƒé™å·²è¯·æ±‚

2. **Info.plist å¿…é¡»é…ç½®**
   ```xml
   <key>NSUserTrackingUsageDescription</key>
   <string>æˆ‘ä»¬éœ€è¦æ‚¨çš„åŒæ„æ¥ä¸ºæ‚¨æä¾›ä¸ªæ€§åŒ–çš„å¹¿å‘Šä½“éªŒ</string>
   ```

3. **å¹¿å‘Šå±•ç¤ºä½ç½®**
   - âŒ ä¸åœ¨å¯åŠ¨é¡µæ˜¾ç¤ºå¼€å±å¹¿å‘Š
   - âœ… å¯ä»¥åœ¨ä¸»ç•Œé¢æ˜¾ç¤ºä¿¡æ¯æµå¹¿å‘Š
   - âœ… å¯ä»¥åœ¨è¯¦æƒ…é¡µæ˜¾ç¤ºå¹¿å‘Š
   - âœ… ç¡®ä¿ç”¨æˆ·å·²ç™»å½•

4. **å‘å¸ƒå‰æ£€æŸ¥**
   - ç¡®ä¿å¯åŠ¨æ—¶ä¸æ˜¾ç¤ºå¹¿å‘Š
   - ç¡®ä¿ç™»å½•å‰ä¸åˆå§‹åŒ–å¹¿å‘Š SDK
   - ç¡®ä¿ ATT å¼¹çª—æ­£å¸¸æ˜¾ç¤º
   - ç¡®ä¿ç™»å½•åå¹¿å‘Š SDK æ­£å¸¸åˆå§‹åŒ–

---

**ä¿®æ”¹å®Œæˆæ—¶é—´**ï¼š2025-10-17  
**ä¿®æ”¹äºº**ï¼šAugment Agent  
**å®¡æ ¸çŠ¶æ€**ï¼šâœ… ç¼–è¯‘é€šè¿‡ï¼Œå¾…æµ‹è¯•éªŒè¯  
**ç‰ˆæœ¬**ï¼šv2.0ï¼ˆç™»å½•ååˆå§‹åŒ–å¹¿å‘Š SDKï¼‰


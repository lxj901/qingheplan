# 诊断支付对话框不弹出问题

## 🐛 问题描述

**现象**：点击"连续包月"套餐后，没有弹出沙盒支付对话框

**环境**：真机测试

## 🔍 可能的原因

### 原因 1：支付对话框一闪而过（自动完成）

**症状**：
- 日志显示购买成功
- 但没有看到支付对话框

**原因**：
- StoreKit Testing 自动完成了购买
- 或者之前的购买记录被缓存

**解决方法**：

#### 方法 1：检查 Xcode StoreKit 交易记录

1. 在 Xcode 菜单栏选择：
   ```
   Debug → StoreKit → Manage Transactions...
   ```

2. 查看是否有未完成的交易

3. 删除所有测试交易记录

4. 重新运行应用测试

#### 方法 2：重置 StoreKit 测试环境

```bash
# 1. 清理 Xcode 缓存
rm -rf ~/Library/Developer/Xcode/DerivedData

# 2. 在 Xcode 中
Product → Clean Build Folder (Cmd + Shift + K)
Product → Run (Cmd + R)
```

---

### 原因 2：真机环境未登录沙盒账号

**症状**：
- 点击购买后没有反应
- 或者要求登录 Apple ID

**检查方法**：

1. 打开设备的 **设置 → App Store**
2. 滚动到底部，找到 **"沙盒账户"** 部分
3. 确认状态：
   - ✅ 已登录沙盒测试账号 → 正常
   - ❌ 未登录 → 需要登录
   - ❌ 登录了真实 Apple ID → 需要退出并登录沙盒账号

**解决方法**：

#### 步骤 1：创建沙盒测试账号（如果还没有）

1. 登录 [App Store Connect](https://appstoreconnect.apple.com)
2. 点击 **用户和访问**
3. 选择 **沙盒技术测试员**
4. 点击 **"+"** 创建新的测试账号
5. 填写信息：
   - 名字：Test
   - 姓氏：User
   - 电子邮件：testuser@example.com（任意邮箱，不需要真实存在）
   - 密码：设置一个测试密码
   - 国家或地区：中国
6. 点击 **"邀请"**

#### 步骤 2：在设备上登录沙盒账号

1. 打开设备的 **设置 → App Store**
2. 如果已登录真实 Apple ID：
   - 点击账号 → 退出登录
3. 滚动到底部，找到 **"沙盒账户"**
4. 点击 **"登录"**
5. 输入沙盒测试账号的邮箱和密码
6. 登录成功后，会显示账号信息

**注意**：
- ⚠️ 不要在 App Store 主界面登录沙盒账号
- ⚠️ 只在 "沙盒账户" 部分登录
- ⚠️ 沙盒账号只能用于测试，不能购买真实商品

---

### 原因 3：产品价格配置问题

**症状**：
- 价格显示为 ¥198.00（异常高）
- 可能触发了某些限制

**检查日志**：
```
💰 价格: ¥198.00  ← ❌ 这个价格不正常
```

**解决方法**：

1. **修改 App Store Connect 中的价格**
   - 登录 App Store Connect
   - 找到产品 `com.qinghe.qinghe.membership.monthlyv4`
   - 将价格从 ¥198.00 改为 ¥30.00
   - 保存并等待同步（5-30分钟）

2. **验证价格是否更新**
   - 重新运行应用
   - 查看日志中的价格是否变为 ¥30.00

---

### 原因 4：StoreKit 配置文件未正确加载

**症状**：
- 真机测试时，StoreKit 配置文件不生效
- 只能从 App Store Connect 获取产品信息

**检查方法**：

查看日志中的运行环境：
```
📱 运行环境: 真机  ← 真机环境不使用 StoreKit 配置文件
```

**说明**：
- **模拟器**：使用 StoreKit 配置文件（Configuration.storekit）
- **真机**：从 App Store Connect 获取产品信息

**解决方法**：

如果要在真机上测试，必须：
1. ✅ 在 App Store Connect 中正确配置产品
2. ✅ 登录沙盒测试账号
3. ✅ 等待产品信息同步

**或者切换到模拟器测试**：
- 模拟器会使用 StoreKit 配置文件
- 不需要登录沙盒账号
- 测试更快更方便

---

### 原因 5：购买流程被中断

**症状**：
- 点击购买后，应用切换到后台
- 或者有其他弹窗干扰

**检查日志**：
```
📱 TabBarVisibilityModifier: 主页面被推入后台  ← 可能的干扰
```

**解决方法**：

1. 确保应用在前台运行
2. 关闭其他可能的弹窗或通知
3. 重新测试购买流程

---

## 🧪 完整的测试步骤

### 步骤 1：准备测试环境

1. **清理 Xcode 缓存**
   ```bash
   rm -rf ~/Library/Developer/Xcode/DerivedData
   ```

2. **在 Xcode 中清理项目**
   ```
   Product → Clean Build Folder (Cmd + Shift + K)
   ```

3. **重置 StoreKit 交易记录**
   ```
   Debug → StoreKit → Manage Transactions... → 删除所有交易
   ```

### 步骤 2：配置沙盒账号（真机测试）

1. **在设备上登录沙盒账号**
   - 设置 → App Store → 沙盒账户
   - 登录测试账号

2. **验证登录状态**
   - 确认显示沙盒账号信息

### 步骤 3：运行应用并测试

1. **运行应用**
   ```
   Product → Run (Cmd + R)
   ```

2. **进入会员购买页面**

3. **查看控制台日志**
   ```
   📦 开始加载产品列表...
   ✅ StoreKit 返回 4 个产品
   ```

4. **点击"连续包月"套餐**

5. **观察现象**：
   - ✅ 弹出支付对话框 → 正常
   - ❌ 要求登录 Apple ID → 沙盒账号未登录或价格配置错误
   - ❌ 没有任何反应 → 检查日志中的错误信息

### 步骤 4：查看详细日志

点击购买后，应该看到以下日志：

```
🛒 开始购买流程...
📦 计划代码: monthly_auto
🔍 查找产品 planCode: monthly_auto
✅ 找到匹配的后端产品: com.qinghe.qinghe.membership.monthlyv4
✅ 找到对应的 StoreKit 产品: 连续包月
✅ 找到产品: com.qinghe.qinghe.membership.monthlyv4 - 连续包月
💰 价格: ¥30.00  ← 应该是正确的价格
🔄 开始调用 StoreKit 购买...
[此时应该弹出支付对话框]
```

**如果没有弹出对话框，查看是否有错误日志**：
```
❌ 未找到匹配的内购产品
❌ 购买流程正在进行中，忽略重复请求
❌ 其他错误信息
```

---

## 🎯 快速诊断清单

请按顺序检查以下项目：

- [ ] **沙盒账号已登录**（设置 → App Store → 沙盒账户）
- [ ] **价格配置正确**（日志中显示 ¥30.00 而不是 ¥198.00）
- [ ] **产品加载成功**（日志显示 "✅ StoreKit 返回 4 个产品"）
- [ ] **没有重复购买**（日志没有 "⚠️ 购买流程正在进行中"）
- [ ] **应用在前台运行**（没有被其他弹窗干扰）
- [ ] **StoreKit 交易记录已清理**（Debug → StoreKit → Manage Transactions...）

---

## 📱 推荐的测试方式

### 方式 1：模拟器测试（推荐）

**优点**：
- 使用 StoreKit 配置文件，不需要 App Store Connect
- 不需要登录沙盒账号
- 测试快速，可以立即看到效果

**步骤**：
1. 选择模拟器（iPhone 16）
2. 确认 Xcode Scheme 中启用了 StoreKit Configuration
3. 运行应用
4. 测试购买流程

### 方式 2：真机测试

**优点**：
- 更接近真实环境
- 可以测试真实的支付流程

**要求**：
- ✅ 必须登录沙盒测试账号
- ✅ App Store Connect 中的产品配置必须正确
- ✅ 需要等待产品信息同步

**步骤**：
1. 在设备上登录沙盒账号
2. 确认 App Store Connect 中的价格正确
3. 运行应用
4. 测试购买流程

---

## 🔧 如果仍然无法解决

请提供以下信息：

1. **完整的控制台日志**（从点击购买到结束）
2. **测试环境**：
   - 设备型号和 iOS 版本
   - 是否登录了沙盒账号
   - App Store Connect 中的产品价格
3. **具体现象**：
   - 点击购买后发生了什么
   - 是否有任何弹窗或提示
   - 应用是否崩溃或卡住

---

**更新时间**：2025-10-13  
**相关文档**：
- 连续包月价格问题-快速修复指南.md
- StoreKit用户取消购买修复说明.md


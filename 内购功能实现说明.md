# 内购功能实现说明

## 功能概述

已完整实现 Apple 内购（In-App Purchase）功能，支持模拟器测试和真机购买。

## 实现的功能

### 1. 产品加载 ✅
- 从后端获取产品列表 (`/apple-iap/products`)
- 从 StoreKit 加载产品信息
- 支持 4 种会员套餐：
  - 连续包月会员 (¥29.9)
  - 月度会员 (¥39.9)
  - 季度会员 (¥69.9)
  - 年度会员 (¥169)

### 2. 购买流程 ✅
- 调用 StoreKit 2 API 发起购买
- 验证交易签名
- 获取交易信息
- 向后端验证并激活会员

### 3. 收据处理 ✅
- **真机环境**：使用真实的 App Store 收据
- **模拟器环境**：生成包含交易信息的模拟收据

### 4. 后端验证 ✅
- 调用 `/apple-iap/verify` 接口
- 提交收据数据和交易ID
- 激活会员权益

## 技术实现

### 核心文件

1. **IAPService.swift** - 内购服务核心类
   - `loadProducts()` - 加载产品列表
   - `purchase(plan:)` - 购买流程
   - `verifyWithServer()` - 后端验证
   - `currentReceiptBase64()` - 获取收据

2. **AppleIAPModels.swift** - 数据模型
   - `AppleProductItem` - 产品信息
   - `AppleVerifyRequest` - 验证请求
   - `AppleVerifyResponse` - 验证响应

3. **Configuration.storekit** - StoreKit 配置文件
   - 包含 4 个产品配置
   - 用于模拟器测试

### 购买流程图

```
用户点击购买
    ↓
检查产品是否已加载
    ↓
调用 StoreKit 购买 API
    ↓
用户确认购买（模拟器：自动确认）
    ↓
验证交易签名
    ↓
获取收据数据
    ├─ 真机：读取 App Store 收据
    └─ 模拟器：生成模拟收据
    ↓
调用后端验证接口
    ↓
后端验证并激活会员
    ↓
完成交易
    ↓
刷新会员状态
```

## 模拟器 vs 真机

### 模拟器测试

**优点**：
- ✅ 无需真实支付
- ✅ 快速测试购买流程
- ✅ 可以重复测试

**限制**：
- ⚠️ 不生成真实收据
- ⚠️ 使用模拟交易数据
- ⚠️ 需要后端支持模拟器模式

**实现方式**：
```swift
#if targetEnvironment(simulator)
// 生成模拟收据数据
let mockReceiptData: [String: Any] = [
    "environment": "Xcode",
    "transaction_id": String(transaction.id),
    "product_id": transaction.productID,
    "purchase_date": ISO8601DateFormatter().string(from: transaction.purchaseDate)
]
#endif
```

### 真机测试

**要求**：
- ✅ 使用沙盒测试账号
- ✅ 在设置中登录沙盒账号
- ✅ 产品已在 App Store Connect 中配置

**优点**：
- ✅ 完全真实的购买流程
- ✅ 生成真实的 App Store 收据
- ✅ 可以测试订阅管理

**实现方式**：
```swift
#else
// 真机环境：使用真实收据
let receipt = try await currentReceiptBase64()
try await verifyWithServer(receiptData: receipt, transactionId: String(transaction.id))
#endif
```

## 后端接口

### 1. 获取产品列表
```http
GET /apple-iap/products
```

**响应示例**：
```json
{
  "success": true,
  "data": [
    {
      "id": 2,
      "product_id": "com.qinghe.qinghe.membership.monthlyv4",
      "product_name": "连续包月会员",
      "price": 29.9,
      "membership_plan": {
        "plan_code": "monthly_auto"
      }
    }
  ]
}
```

### 2. 验证购买
```http
POST /apple-iap/verify
Authorization: Bearer {token}
```

**请求体**：
```json
{
  "receiptData": "base64_encoded_receipt",
  "transactionId": "1000000987654321"
}
```

**响应示例**：
```json
{
  "success": true,
  "message": "会员激活成功",
  "membership": {
    "status": "active",
    "startDate": "2024-10-08T10:00:00.000Z",
    "endDate": "2024-11-08T10:00:00.000Z"
  }
}
```

## 测试步骤

### 模拟器测试

1. ✅ 在 Xcode 中选择模拟器（iPhone 16）
2. ✅ 运行应用 (Cmd + R)
3. ✅ 登录账号
4. ✅ 进入会员中心
5. ✅ 点击任意套餐购买
6. ✅ 在弹出的对话框中点击"订阅"
7. ✅ 查看控制台日志，确认购买流程

**期望日志**：
```
🛒 开始购买流程...
✅ 找到产品: com.qinghe.qinghe.membership.monthlyv4 - 连续包月会员
💰 价格: ¥29.90
🔄 开始调用 StoreKit 购买...
✅ 购买成功，开始验证交易...
🖥️ 模拟器环境：使用交易信息验证...
✅ 生成模拟收据
🔄 向后端验证（模拟器模式）...
✅ 后端验证成功
🎉 购买流程完成！
```

### 真机测试

1. ⏳ 创建沙盒测试账号（App Store Connect）
2. ⏳ 在真机设置中登录沙盒账号
3. ⏳ 在 App Store Connect 中配置产品
4. ⏳ 运行应用到真机
5. ⏳ 测试购买流程

## 注意事项

### 1. 后端支持

后端需要支持两种验证模式：

**真机模式**：
- 验证真实的 App Store 收据
- 调用 Apple 的收据验证 API
- 解析收据中的交易信息

**模拟器模式**（可选）：
- 接受模拟收据数据
- 直接使用交易ID激活会员
- 用于开发测试

### 2. 产品配置

确保以下配置一致：
- ✅ 后端数据库中的产品ID
- ✅ StoreKit 配置文件中的产品ID
- ✅ App Store Connect 中的产品ID（真机测试）

### 3. 错误处理

已实现的错误处理：
- ✅ 产品未找到
- ✅ 用户取消购买
- ✅ 交易验证失败
- ✅ 收据获取失败
- ✅ 后端验证失败

## 下一步

### 立即可测试 ✅
- [x] 模拟器购买流程
- [x] 产品列表加载
- [x] 购买对话框显示
- [x] 后端验证（需要后端支持模拟器模式）

### 需要配置 ⏳
- [ ] App Store Connect 产品配置
- [ ] 沙盒测试账号创建
- [ ] 真机测试
- [ ] 订阅管理功能

### 可选优化 💡
- [ ] 添加购买历史记录
- [ ] 实现恢复购买功能
- [ ] 添加订阅状态监听
- [ ] 优化错误提示

## 相关文档

- [Apple StoreKit 文档](https://developer.apple.com/documentation/storekit)
- [StoreKit Testing in Xcode](https://developer.apple.com/documentation/xcode/setting-up-storekit-testing-in-xcode)
- [后端 API 文档](./qinghe/ /qinghe/后端 API 文档/会员订阅与支付.md)

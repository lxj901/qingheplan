# 白噪音与睡眠追踪解耦修复说明

## 问题描述

之前的实现中，白噪音播放功能和睡眠追踪功能被错误地耦合在一起：

1. **播放白噪音时会自动暂停睡眠录制**
2. **停止白噪音时会尝试恢复睡眠录制**
3. **导致音频会话冲突**

### 错误日志示例

```
🛑 正在停止音频录制...
🧹 强制完成当前事件 (reason=stop)，样本数: 29440
...
⚠️ 检测到播放中断！正在尝试恢复... (第 1 次)
❌ 音频会话激活失败: Error Domain=NSOSStatusErrorDomain Code=561015905
❌ 音频会话重新激活仍然失败: Error Domain=NSOSStatusErrorDomain Code=-50 "(null)"
```

## 根本原因

白噪音播放和睡眠追踪是两个**完全独立**的功能：

- **白噪音播放**：帮助用户放松、助眠的音频播放功能
- **睡眠追踪**：记录用户睡眠时的声音事件（打鼾、说梦话等）

这两个功能不应该相互干扰，但之前的代码在 `WhiteNoisePlayer` 中错误地调用了 `SleepDataManager` 的方法。

## 修复方案

### 1. 移除不必要的耦合

从 `WhiteNoisePlayer.swift` 中移除了以下调用：

#### `play()` 方法
**修复前：**
```swift
func play(whiteNoise: WhiteNoise) {
    // ❌ 错误：不应该干预睡眠录制
    Task { @MainActor in
        await SleepDataManager.shared.pauseRecordingForWhiteNoise()
    }
    // ...
}
```

**修复后：**
```swift
func play(whiteNoise: WhiteNoise) {
    // ✅ 直接播放，不干预睡眠录制
    // ...
}
```

#### `pause()` 方法
**修复前：**
```swift
func pause() {
    player?.pause()
    isPlaying = false
    stopPlaybackMonitor()
    updateNowPlayingInfo()
    // ❌ 错误：不应该恢复睡眠录制
    Task { @MainActor in
        await SleepDataManager.shared.maybeResumeRecordingAfterWhiteNoise()
    }
}
```

**修复后：**
```swift
func pause() {
    player?.pause()
    isPlaying = false
    stopPlaybackMonitor()
    updateNowPlayingInfo()
    // ✅ 只处理播放暂停，不涉及睡眠录制
}
```

#### `resume()` 方法
**修复前：**
```swift
func resume() {
    guard let player = player else { return }
    activateAudioSession()
    // ❌ 错误：不应该暂停睡眠录制
    Task { @MainActor in
        await SleepDataManager.shared.pauseRecordingForWhiteNoise()
    }
    player.play()
    isPlaying = true
}
```

**修复后：**
```swift
func resume() {
    guard let player = player else { return }
    activateAudioSession()
    // ✅ 只处理播放恢复
    player.play()
    isPlaying = true
}
```

#### `stop()` 方法
**修复前：**
```swift
func stop() {
    player?.pause()
    removeTimeObserver()
    // ... 其他清理
    MPNowPlayingInfoCenter.default().nowPlayingInfo = nil
    // ❌ 错误：不应该恢复睡眠录制
    Task { @MainActor in
        await SleepDataManager.shared.maybeResumeRecordingAfterWhiteNoise()
    }
}
```

**修复后：**
```swift
func stop() {
    player?.pause()
    removeTimeObserver()
    // ... 其他清理
    MPNowPlayingInfoCenter.default().nowPlayingInfo = nil
    // ✅ 只处理播放停止
}
```

### 2. 音频会话管理优化

保留了正确的音频会话配置：

```swift
private func activateAudioSession() {
    let audioSession = AVAudioSession.sharedInstance()
    
    do {
        // 只在需要时更新音频会话类别
        if audioSession.category != .playback {
            try audioSession.setCategory(
                .playback,
                mode: .default,
                options: [.allowBluetoothA2DP]
            )
        }
        
        // 激活音频会话
        try audioSession.setActive(true, options: [])
        
    } catch {
        // 错误处理...
    }
}
```

## 正确的设计原则

### 白噪音播放器职责
- ✅ 播放、暂停、停止音频
- ✅ 管理播放进度和状态
- ✅ 处理后台播放
- ✅ 更新锁屏控制
- ❌ **不应该**管理睡眠录制

### 睡眠追踪管理器职责
- ✅ 录制睡眠时的音频
- ✅ 分析音频事件（打鼾、说梦话）
- ✅ 保存睡眠数据
- ❌ **不应该**被白噪音播放器控制

### 音频会话配置
- **白噪音播放**：使用 `AVAudioSessionCategoryPlayback`（仅播放）
- **睡眠录制**：使用 `AVAudioSessionCategoryRecord`（仅录制）
- **未来扩展**：如需同时播放和录制，应使用 `AVAudioSessionCategoryPlayAndRecord`

## 预期效果

修复后：

1. ✅ **白噪音可以独立播放**，不会影响睡眠录制
2. ✅ **睡眠录制可以独立运行**，不会因白噪音播放而暂停
3. ✅ **不再出现音频会话冲突**（-50 错误、561015905 错误）
4. ✅ **后台播放更稳定**，不会因为错误的状态切换而中断

## 测试验证

### 测试场景 1：仅播放白噪音
1. 打开白噪音列表
2. 选择一个白噪音播放
3. 锁屏
4. **预期**：白噪音正常播放，没有任何睡眠录制相关日志

### 测试场景 2：仅进行睡眠追踪
1. 不播放白噪音
2. 开始睡眠追踪
3. **预期**：正常录制音频，分析睡眠事件

### 测试场景 3：同时使用两个功能（未来支持）
*当前版本中，这两个功能应该分开使用。如果用户需求明确需要同时支持，需要：*
1. 修改音频会话类别为 `.playAndRecord`
2. 添加适当的音频混合选项
3. 确保音频路由正确

## 相关文件

- `qinghe/qinghe/WhiteNoisePlayer.swift` - 白噪音播放器（已修复）
- `qinghe/qinghe/SleepDataManager.swift` - 睡眠追踪管理器（保持不变）

## 注意事项

1. **不要重新引入耦合代码** - 未来的开发中，请确保白噪音播放器和睡眠追踪管理器保持独立
2. **音频会话管理** - 每个功能应该只管理自己的音频会话
3. **单一职责原则** - 每个类应该只负责一个明确的功能

## 总结

这次修复解决了白噪音播放功能和睡眠追踪功能之间错误的耦合关系，确保两个功能可以独立、稳定地运行，避免了音频会话冲突导致的播放中断问题。


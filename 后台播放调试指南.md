# ç™½å™ªéŸ³åå°æ’­æ”¾è°ƒè¯•æŒ‡å—

## ğŸ”§ æœ€æ–°ä¿®å¤å†…å®¹ (2025-10-09)

### å…³é”®é—®é¢˜è¯†åˆ«
**ç—‡çŠ¶**: é”å±ç•Œé¢æ˜¾ç¤ºéŸ³é¢‘æ§åˆ¶ï¼Œä½†éŸ³é¢‘å®é™…ä¸Šæ²¡æœ‰ç»§ç»­æ’­æ”¾

**æ ¹æœ¬åŸå› **:
1. âŒ éŸ³é¢‘ä¼šè¯æ²¡æœ‰åœ¨æ¯æ¬¡æ’­æ”¾æ—¶é‡æ–°æ¿€æ´»
2. âŒ AVPlayer æ²¡æœ‰é…ç½® `automaticallyWaitsToMinimizeStalling`
3. âŒ ç¼ºå°‘éŸ³é¢‘ä¼šè¯ä¸­æ–­å¤„ç†
4. âŒ ç¼ºå°‘è®¾å¤‡æ–­å¼€ï¼ˆå¦‚æ‹”è€³æœºï¼‰å¤„ç†

### ä¿®å¤æªæ–½

#### 1. æ·»åŠ éŸ³é¢‘ä¼šè¯æ¿€æ´»æ–¹æ³•
```swift
private func activateAudioSession() {
    do {
        let audioSession = AVAudioSession.sharedInstance()
        try audioSession.setActive(true)
        print("ğŸ”Š éŸ³é¢‘ä¼šè¯å·²æ¿€æ´»")
    } catch {
        print("âŒ éŸ³é¢‘ä¼šè¯æ¿€æ´»å¤±è´¥: \(error)")
    }
}
```

#### 2. åœ¨æ’­æ”¾å’Œæ¢å¤æ—¶æ¿€æ´»éŸ³é¢‘ä¼šè¯
```swift
func play(whiteNoise: WhiteNoise) {
    // ç¡®ä¿éŸ³é¢‘ä¼šè¯æ¿€æ´»
    activateAudioSession()
    // ... å…¶ä½™ä»£ç 
}

func resume() {
    // ç¡®ä¿éŸ³é¢‘ä¼šè¯æ¿€æ´»
    activateAudioSession()
    // ... å…¶ä½™ä»£ç 
}
```

#### 3. é…ç½® AVPlayer
```swift
// é…ç½®æ’­æ”¾å™¨ä»¥æ”¯æŒåå°æ’­æ”¾
player?.automaticallyWaitsToMinimizeStalling = false
```

#### 4. æ·»åŠ éŸ³é¢‘ä¼šè¯ä¸­æ–­å¤„ç†
- ç›‘å¬ `AVAudioSession.interruptionNotification`
- å¤„ç†ä¸­æ–­å¼€å§‹å’Œç»“æŸ
- åœ¨ä¸­æ–­ç»“æŸåè‡ªåŠ¨æ¢å¤æ’­æ”¾

#### 5. æ·»åŠ è®¾å¤‡è·¯ç”±å˜åŒ–å¤„ç†
- ç›‘å¬ `AVAudioSession.routeChangeNotification`
- å¤„ç†è€³æœºæ‹”å‡ºç­‰æƒ…å†µ

---

## ğŸ§ª è°ƒè¯•æ­¥éª¤

### æ­¥éª¤ 1: æ¸…ç†å¹¶é‡æ–°ç¼–è¯‘

```bash
# 1. åœ¨ Xcode ä¸­
# Product â†’ Clean Build Folder (Shift + Cmd + K)

# 2. åˆ é™¤æ´¾ç”Ÿæ•°æ®
rm -rf ~/Library/Developer/Xcode/DerivedData/qinghe-*

# 3. åˆ é™¤ Appï¼ˆå¦‚æœå·²å®‰è£…ï¼‰
# åœ¨è®¾å¤‡ä¸Šé•¿æŒ‰ App å›¾æ ‡ï¼Œåˆ é™¤ App

# 4. é‡æ–°ç¼–è¯‘å¹¶å®‰è£…
# Cmd + R
```

### æ­¥éª¤ 2: ç›‘æ§æ§åˆ¶å°è¾“å‡º

åœ¨ Xcode ä¸­æŸ¥çœ‹æ§åˆ¶å°ï¼Œç¡®è®¤ä»¥ä¸‹æ—¥å¿—ï¼š

#### åº”ç”¨å¯åŠ¨æ—¶
```
ğŸ”Š ç™½å™ªéŸ³æ’­æ”¾å™¨éŸ³é¢‘ä¼šè¯é…ç½®æˆåŠŸ - æ”¯æŒåå°æ’­æ”¾
ğŸ® è¿œç¨‹æ§åˆ¶å·²è®¾ç½®
ğŸ“¢ éŸ³é¢‘ä¼šè¯é€šçŸ¥å·²è®¾ç½®
```

#### æ’­æ”¾éŸ³é¢‘æ—¶
```
ğŸ”Š éŸ³é¢‘ä¼šè¯å·²æ¿€æ´»
â–¶ï¸ å¼€å§‹æ’­æ”¾: [éŸ³é¢‘æ ‡é¢˜]
ğŸ“± Now Playing Info å·²æ›´æ–°: [éŸ³é¢‘æ ‡é¢˜]
```

#### é”å±å
```
ğŸ”Š éŸ³é¢‘ä¼šè¯å·²æ¿€æ´»  // resume() è¢«è°ƒç”¨
â–¶ï¸ ç»§ç»­æ’­æ”¾
ğŸ“± Now Playing Info å·²æ›´æ–°: [éŸ³é¢‘æ ‡é¢˜]
```

#### å¦‚æœçœ‹åˆ°é”™è¯¯
```
âŒ éŸ³é¢‘ä¼šè¯æ¿€æ´»å¤±è´¥: [é”™è¯¯ä¿¡æ¯]
âŒ éŸ³é¢‘ä¼šè¯é…ç½®å¤±è´¥: [é”™è¯¯ä¿¡æ¯]
```

### æ­¥éª¤ 3: æµ‹è¯•æ’­æ”¾æµç¨‹

1. **æ‰“å¼€ Appï¼Œæ’­æ”¾ç™½å™ªéŸ³**
   - è§‚å¯Ÿæ§åˆ¶å°æ˜¯å¦è¾“å‡º: `ğŸ”Š éŸ³é¢‘ä¼šè¯å·²æ¿€æ´»`
   - è§‚å¯Ÿæ§åˆ¶å°æ˜¯å¦è¾“å‡º: `â–¶ï¸ å¼€å§‹æ’­æ”¾`
   - ç¡®è®¤éŸ³é¢‘æ­£å¸¸æ’­æ”¾

2. **æŒ‰ Home é”®é€€å‡ºåˆ°ä¸»å±å¹•**
   - ç¡®è®¤éŸ³é¢‘æ˜¯å¦ç»§ç»­æ’­æ”¾
   - å¦‚æœåœæ­¢ï¼Œæ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯

3. **é”å®šå±å¹•**
   - ç¡®è®¤éŸ³é¢‘æ˜¯å¦ç»§ç»­æ’­æ”¾
   - æ£€æŸ¥é”å±ç•Œé¢æ˜¯å¦æ˜¾ç¤ºæ’­æ”¾æ§åˆ¶

4. **ä»é”å±ç•Œé¢æ§åˆ¶æ’­æ”¾**
   - ç‚¹å‡»æš‚åœæŒ‰é’®
   - è§‚å¯Ÿæ§åˆ¶å°: `â¸ æš‚åœæ’­æ”¾` (å¦‚æœæ·»åŠ äº†æ—¥å¿—)
   - ç‚¹å‡»æ’­æ”¾æŒ‰é’®
   - è§‚å¯Ÿæ§åˆ¶å°: `ğŸ”Š éŸ³é¢‘ä¼šè¯å·²æ¿€æ´»` â†’ `â–¶ï¸ ç»§ç»­æ’­æ”¾`

---

## ğŸ” å¸¸è§é—®é¢˜è¯Šæ–­

### é—®é¢˜ 1: éŸ³é¢‘ä»ç„¶åœ¨é”å±ååœæ­¢

**æ£€æŸ¥æ¸…å•**:
- [ ] ç¡®è®¤ `Background Modes` åŒ…å« `audio`
- [ ] ç¡®è®¤éŸ³é¢‘ä¼šè¯ç±»åˆ«æ˜¯ `.playback`
- [ ] ç¡®è®¤ `activateAudioSession()` è¢«è°ƒç”¨
- [ ] ç¡®è®¤ AVPlayer ä¸ä¸º nil
- [ ] ç¡®è®¤ `isPlaying` çŠ¶æ€ä¸º true

**è°ƒè¯•ä»£ç **:
åœ¨ `play()` æ–¹æ³•ä¸­æ·»åŠ æ›´å¤šæ—¥å¿—ï¼š

```swift
func play(whiteNoise: WhiteNoise) {
    print("ğŸµ å¼€å§‹ play() æ–¹æ³•")
    
    activateAudioSession()
    print("âœ… éŸ³é¢‘ä¼šè¯å·²å°è¯•æ¿€æ´»")
    
    // ... åˆ›å»º player
    
    player?.play()
    print("âœ… player?.play() å·²è°ƒç”¨")
    print("âœ… player æ˜¯å¦ä¸º nil: \(player == nil)")
    print("âœ… isPlaying: \(isPlaying)")
}
```

### é—®é¢˜ 2: é”å±ç•Œé¢æ²¡æœ‰æ˜¾ç¤ºæ’­æ”¾æ§åˆ¶

**å¯èƒ½åŸå› **:
1. `Now Playing Info` æ²¡æœ‰è®¾ç½®
2. è¿œç¨‹æ§åˆ¶æ²¡æœ‰å¯ç”¨
3. éŸ³é¢‘ä¼šè¯æ²¡æœ‰æ¿€æ´»

**æ£€æŸ¥æ–¹æ³•**:
```swift
// åœ¨ updateNowPlayingInfo() ä¸­æ·»åŠ 
print("ğŸ“± Now Playing Info å†…å®¹:")
print(nowPlayingInfo)
```

### é—®é¢˜ 3: éŸ³é¢‘æ’­æ”¾ä¸€æ®µæ—¶é—´ååœæ­¢

**å¯èƒ½åŸå› **:
1. éŸ³é¢‘ä¼šè¯è¢«å…¶ä»–åº”ç”¨ä¸­æ–­
2. ç³»ç»Ÿèµ„æºé™åˆ¶
3. AVPlayer çŠ¶æ€å¼‚å¸¸

**è°ƒè¯•æ–¹æ³•**:
åœ¨ `handleAudioSessionInterruption` ä¸­æ·»åŠ æ—¥å¿—ï¼š

```swift
@objc private func handleAudioSessionInterruption(notification: Notification) {
    print("âš ï¸ éŸ³é¢‘ä¼šè¯ä¸­æ–­é€šçŸ¥")
    print("âš ï¸ é€šçŸ¥è¯¦æƒ…: \(notification.userInfo ?? [:])")
    // ... å…¶ä½™ä»£ç 
}
```

### é—®é¢˜ 4: AVPlayer çŠ¶æ€å¼‚å¸¸

**æ·»åŠ æ’­æ”¾å™¨çŠ¶æ€ç›‘æ§**:

åœ¨ `addPlayerObservers` ä¸­æ·»åŠ ï¼š

```swift
private func addPlayerObservers(playerItem: AVPlayerItem) {
    // ç°æœ‰ä»£ç ...
    
    // æ·»åŠ æ’­æ”¾å™¨çŠ¶æ€è§‚å¯Ÿ
    playerItem.addObserver(self, forKeyPath: "status", options: [.new], context: nil)
}

override func observeValue(forKeyPath keyPath: String?, 
                          of object: Any?, 
                          change: [NSKeyValueChangeKey : Any]?, 
                          context: UnsafeMutableRawPointer?) {
    if keyPath == "status" {
        if let playerItem = object as? AVPlayerItem {
            switch playerItem.status {
            case .readyToPlay:
                print("âœ… æ’­æ”¾å™¨å‡†å¤‡å°±ç»ª")
            case .failed:
                print("âŒ æ’­æ”¾å™¨å¤±è´¥: \(playerItem.error?.localizedDescription ?? "æœªçŸ¥é”™è¯¯")")
            case .unknown:
                print("âš ï¸ æ’­æ”¾å™¨çŠ¶æ€æœªçŸ¥")
            @unknown default:
                break
            }
        }
    }
}
```

---

## ğŸ¯ éªŒè¯åå°æ’­æ”¾çš„å…³é”®ç‚¹

### 1. éŸ³é¢‘ä¼šè¯é…ç½® âœ…
```swift
try audioSession.setCategory(
    .playback,  // å¿…é¡»æ˜¯ .playback
    mode: .default,
    options: [.mixWithOthers, .allowBluetooth, .allowBluetoothA2DP]
)
```

### 2. éŸ³é¢‘ä¼šè¯æ¿€æ´» âœ…
```swift
try audioSession.setActive(true)  // å¿…é¡»åœ¨æ’­æ”¾å‰æ¿€æ´»
```

### 3. Background Modes âœ…
åœ¨ `project.pbxproj` ä¸­:
```
INFOPLIST_KEY_UIBackgroundModes = "audio location";
```

### 4. Now Playing Info âœ…
```swift
MPNowPlayingInfoCenter.default().nowPlayingInfo = [
    MPMediaItemPropertyTitle: "éŸ³é¢‘æ ‡é¢˜",
    MPNowPlayingInfoPropertyPlaybackRate: 1.0  // å¿…é¡»è®¾ç½®ä¸º 1.0ï¼ˆæ’­æ”¾ä¸­ï¼‰
]
```

### 5. è¿œç¨‹æ§åˆ¶ âœ…
```swift
MPRemoteCommandCenter.shared().playCommand.isEnabled = true
MPRemoteCommandCenter.shared().pauseCommand.isEnabled = true
```

---

## ğŸ“Š æ€§èƒ½ç›‘æ§

### æ£€æŸ¥éŸ³é¢‘ä¼šè¯çŠ¶æ€

åœ¨ `play()` æ–¹æ³•ä¸­æ·»åŠ ï¼š

```swift
let audioSession = AVAudioSession.sharedInstance()
print("ğŸ” éŸ³é¢‘ä¼šè¯ä¿¡æ¯:")
print("  - ç±»åˆ«: \(audioSession.category)")
print("  - æ¨¡å¼: \(audioSession.mode)")
print("  - é€‰é¡¹: \(audioSession.categoryOptions)")
print("  - æ˜¯å¦æ¿€æ´»: \(audioSession.secondaryAudioShouldBeSilencedHint)")
print("  - å½“å‰è·¯ç”±: \(audioSession.currentRoute)")
```

### æ£€æŸ¥ AVPlayer çŠ¶æ€

```swift
if let player = player {
    print("ğŸ” AVPlayer ä¿¡æ¯:")
    print("  - rate: \(player.rate)")  // åº”è¯¥æ˜¯ 1.0ï¼ˆæ’­æ”¾ä¸­ï¼‰æˆ– 0.0ï¼ˆæš‚åœï¼‰
    print("  - timeControlStatus: \(player.timeControlStatus.rawValue)")
    print("  - currentItem: \(player.currentItem != nil)")
}
```

---

## ğŸš¨ ç´§æ€¥ä¿®å¤ï¼šå¦‚æœä»ç„¶ä¸å·¥ä½œ

### å°è¯• 1: å¼ºåˆ¶è®¾ç½®æ’­æ”¾é€Ÿç‡

åœ¨ `play()` å’Œ `resume()` ä¸­ï¼š

```swift
player?.play()
player?.rate = 1.0  // å¼ºåˆ¶è®¾ç½®æ’­æ”¾é€Ÿç‡
```

### å°è¯• 2: ä½¿ç”¨ AVAudioPlayer æ›¿ä»£æ–¹æ¡ˆ

å¦‚æœ AVPlayer æœ‰é—®é¢˜ï¼Œè€ƒè™‘ä½¿ç”¨ AVAudioPlayerï¼š

```swift
import AVFoundation

var audioPlayer: AVAudioPlayer?

func playWithAVAudioPlayer(url: URL) {
    do {
        audioPlayer = try AVAudioPlayer(contentsOf: url)
        audioPlayer?.numberOfLoops = -1  // æ— é™å¾ªç¯
        audioPlayer?.prepareToPlay()
        audioPlayer?.play()
    } catch {
        print("âŒ AVAudioPlayer é”™è¯¯: \(error)")
    }
}
```

### å°è¯• 3: æ£€æŸ¥ iOS è®¾ç½®

1. æ‰“å¼€ iPhone **è®¾ç½®**
2. è¿›å…¥ **é€šç”¨** â†’ **åå° App åˆ·æ–°**
3. ç¡®è®¤ **åå° App åˆ·æ–°** å·²å¼€å¯
4. ç¡®è®¤ä½ çš„ App åœ¨åˆ—è¡¨ä¸­å·²å¼€å¯

---

## ğŸ“± çœŸæœºæµ‹è¯•è¦ç‚¹

### æµ‹è¯•è®¾å¤‡è¦æ±‚
- iOS 14.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- å»ºè®®ä½¿ç”¨ iOS 15+ è¿›è¡Œæµ‹è¯•
- çœŸæœºæµ‹è¯•ï¼ˆæ¨¡æ‹Ÿå™¨å¯èƒ½æ— æ³•å®Œå…¨æ¨¡æ‹Ÿåå°è¡Œä¸ºï¼‰

### æµ‹è¯•ç¯å¢ƒ
1. **å®‰é™ç¯å¢ƒ** - ç¡®ä¿èƒ½å¬åˆ°éŸ³é¢‘
2. **æœ‰çº¿è€³æœºæˆ–è“ç‰™è€³æœº** - æ›´å®¹æ˜“å¬åˆ°åå°æ’­æ”¾
3. **å……è¶³ç”µé‡** - ä½ç”µé‡æ¨¡å¼å¯èƒ½å½±å“åå°è¡Œä¸º

### æµ‹è¯•åœºæ™¯
- [ ] å‰å°æ’­æ”¾æ­£å¸¸
- [ ] é”å±åç»§ç»­æ’­æ”¾
- [ ] é€€å‡º App åç»§ç»­æ’­æ”¾
- [ ] é”å±ç•Œé¢æ§åˆ¶æœ‰æ•ˆ
- [ ] æ§åˆ¶ä¸­å¿ƒæ§åˆ¶æœ‰æ•ˆ
- [ ] è“ç‰™è€³æœºæ§åˆ¶æœ‰æ•ˆ
- [ ] æ¥å¬ç”µè¯åæ¢å¤æ’­æ”¾
- [ ] å…¶ä»– App æ’­æ”¾éŸ³é¢‘åæ¢å¤æ’­æ”¾

---

## ğŸ“ ä¸‹ä¸€æ­¥

å¦‚æœæŒ‰ç…§ä»¥ä¸Šæ­¥éª¤ä»ç„¶æ— æ³•è§£å†³é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **æ§åˆ¶å°å®Œæ•´è¾“å‡º** - ä»å¯åŠ¨åˆ°é”å±çš„æ‰€æœ‰æ—¥å¿—
2. **iOS ç‰ˆæœ¬** - è®¾å¤‡çš„ iOS ç‰ˆæœ¬
3. **è®¾å¤‡å‹å·** - iPhone å‹å·
4. **å…·ä½“è¡¨ç°** - è¯¦ç»†æè¿°éŸ³é¢‘åœæ­¢çš„æ—¶æœº
5. **é”™è¯¯ä¿¡æ¯** - å¦‚æœæœ‰ä»»ä½•é”™è¯¯æ—¥å¿—

---

**æœ€åæ›´æ–°**: 2025-10-09  
**ä¿®å¤ç‰ˆæœ¬**: v2.0 - æ·»åŠ éŸ³é¢‘ä¼šè¯æ¿€æ´»å’Œä¸­æ–­å¤„ç†


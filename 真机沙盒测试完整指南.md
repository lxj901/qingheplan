# 真机沙盒测试完整指南

## 🎯 问题描述

**当前状态**：
- ✅ 价格显示正常（¥29.90）
- ❌ 点击购买后要求登录 Apple ID（而不是沙盒支付）
- ❌ 点击"取消登录"后显示"购买成功"（但实际没有购买）

**目标**：
- ✅ 点击购买后直接弹出沙盒支付对话框
- ✅ 点击取消后不显示"购买成功"

---

## 📋 完整解决步骤

### 步骤 1：创建沙盒测试账号

#### 1.1 在 App Store Connect 创建

1. **登录 App Store Connect**
   ```
   https://appstoreconnect.apple.com
   ```

2. **导航到沙盒测试员**
   - 点击顶部的 **"用户和访问"**
   - 左侧菜单选择 **"沙盒技术测试员"**

3. **创建新的测试账号**
   - 点击左上角的 **"+"** 按钮
   - 填写以下信息：
     ```
     名字：Test
     姓氏：Qinghe
     电子邮件：testqinghe001@icloud.com
     密码：TestQinghe123!
     国家或地区：中国
     ```
   - ⚠️ **注意**：邮箱可以是任意格式，不需要真实存在
   - 点击 **"邀请"**

4. **确认创建成功**
   - 在列表中应该能看到新创建的测试账号
   - 状态应该是 **"已邀请"** 或 **"活跃"**

#### 1.2 记录测试账号信息

请记下以下信息（稍后需要在设备上登录）：
```
邮箱：testqinghe001@icloud.com
密码：TestQinghe123!
```

---

### 步骤 2：在设备上登录沙盒账号

#### 2.1 检查当前登录状态

1. **打开设备的"设置"**
2. **滚动找到"App Store"**
3. **点击进入**
4. **滚动到最底部**，找到以下部分：
   ```
   SANDBOX ACCOUNT
   或
   沙盒账户
   ```

5. **检查当前状态**：

   **情况 A：显示 "Sign In" 或 "登录"**
   ```
   SANDBOX ACCOUNT
   Sign In
   ```
   - ❌ 未登录沙盒账号
   - ✅ 需要登录（继续下一步）

   **情况 B：显示一个邮箱地址**
   ```
   SANDBOX ACCOUNT
   testqinghe001@icloud.com
   ```
   - ✅ 已登录沙盒账号
   - 如果仍有问题，尝试退出重新登录

   **情况 C：找不到 "SANDBOX ACCOUNT" 部分**
   - ⚠️ 可能需要先运行一次测试应用
   - 或者 iOS 版本不支持（需要 iOS 12+）

#### 2.2 登录沙盒账号

1. **在 "SANDBOX ACCOUNT" 部分点击 "Sign In"**

2. **输入沙盒测试账号**：
   ```
   邮箱：testqinghe001@icloud.com
   密码：TestQinghe123!
   ```

3. **点击"登录"**

4. **确认登录成功**：
   - 应该显示邮箱地址
   - 不应该有任何错误提示

#### 2.3 重要注意事项

⚠️ **不要在以下位置登录沙盒账号**：
- ❌ 设置 → 顶部的 Apple ID（这是真实账号）
- ❌ App Store 应用中（这是真实账号）
- ✅ 只在 "设置 → App Store → SANDBOX ACCOUNT" 中登录

⚠️ **沙盒账号的限制**：
- 只能用于测试 IAP
- 不能购买真实商品
- 不能登录 iCloud
- 不能下载真实应用

---

### 步骤 3：验证配置

#### 3.1 检查 App Store Connect 产品状态

1. **登录 App Store Connect**
2. **进入您的应用（青禾计划）**
3. **点击左侧的 "App 内购买项目"**
4. **找到产品**：`com.qinghe.qinghe.membership.monthlyv4`
5. **检查状态**：
   - ✅ **"准备提交"** → 可以测试
   - ✅ **"等待审核"** → 可以测试
   - ✅ **"已批准"** → 可以测试
   - ❌ **"草稿"** → 需要完成配置
   - ❌ **"被拒绝"** → 需要修改

6. **检查价格**：
   - 应该是 **¥30.00** 或 **¥29.90**
   - 如果是 ¥198.00，需要修改

#### 3.2 检查 Xcode 配置

1. **在 Xcode 中打开项目**
2. **选择顶部的 Scheme（qinghe）**
3. **点击 "Edit Scheme..."**
4. **选择左侧的 "Run"**
5. **切换到 "Options" 标签**
6. **检查 "StoreKit Configuration"**：
   - 模拟器测试：应该选择 `Configuration.storekit`
   - 真机测试：可以选择 `None`（使用 App Store Connect）

---

### 步骤 4：重新测试

#### 4.1 清理环境

1. **清理 Xcode 缓存**
   ```bash
   rm -rf ~/Library/Developer/Xcode/DerivedData
   ```

2. **在 Xcode 中清理项目**
   ```
   Product → Clean Build Folder (Cmd + Shift + K)
   ```

3. **重置 StoreKit 交易记录**
   ```
   Debug → StoreKit → Manage Transactions... → 删除所有交易
   ```

#### 4.2 运行应用

1. **连接真机**
2. **在 Xcode 中选择真机设备**
3. **运行应用**
   ```
   Product → Run (Cmd + R)
   ```

4. **打开 Xcode 控制台**
   ```
   View → Debug Area → Show Debug Area (Cmd + Shift + Y)
   ```

#### 4.3 测试购买流程

1. **进入会员购买页面**

2. **查看控制台日志**，确认产品加载成功：
   ```
   📦 开始加载产品列表...
   ✅ 后端返回 4 个产品
   ✅ StoreKit 返回 4 个产品
     - com.qinghe.qinghe.membership.monthlyv4: 连续包月 - ¥29.90
   ```

3. **点击"连续包月"套餐**

4. **观察现象**：

   **✅ 正常情况（目标）**：
   - 弹出沙盒支付对话框
   - 显示产品名称和价格
   - 有"订阅"和"取消"按钮

   **❌ 异常情况 1：要求登录 Apple ID**
   - 说明沙盒账号未正确登录
   - 返回步骤 2 重新登录

   **❌ 异常情况 2：没有任何反应**
   - 查看控制台日志中的错误信息
   - 可能是产品配置问题

5. **查看详细日志**：
   ```
   🛒 开始购买流程...
   📦 计划代码: monthly_auto
   ✅ 找到产品: com.qinghe.qinghe.membership.monthlyv4 - 连续包月
   💰 价格: ¥29.90
   🔄 开始调用 StoreKit 购买...
   [此时应该弹出支付对话框]
   ```

#### 4.4 测试取消购买

1. **在支付对话框中点击"取消"**

2. **查看控制台日志**：
   ```
   📱 StoreKit 返回结果...
   🔍 结果类型: userCancelled
   ❌ 用户取消购买
   ✅ 确认：用户取消了购买
   ```

3. **确认 UI 行为**：
   - ✅ 不应该显示任何提示
   - ✅ 页面保持原状
   - ❌ 不应该显示"购买成功"

#### 4.5 测试完整购买

1. **再次点击"连续包月"**

2. **在支付对话框中点击"订阅"**

3. **查看控制台日志**：
   ```
   📱 StoreKit 返回结果...
   ✅ 购买成功，开始验证交易...
   ✅ 交易验证通过
   🆔 交易ID: 2000001031446753
   🔄 向后端验证...
   ✅ 后端验证成功
   🎉 购买流程完成！
   ```

4. **确认 UI 行为**：
   - ✅ 显示"购买成功"提示
   - ✅ 关闭购买页面
   - ✅ 会员状态更新

---

## 🔍 故障排除

### 问题 1：仍然要求登录 Apple ID

**可能原因**：
- 沙盒账号未正确登录
- 产品在 App Store Connect 中的状态不正确
- 设备缓存了旧的配置

**解决方法**：

1. **确认沙盒账号登录**
   - 设置 → App Store → SANDBOX ACCOUNT
   - 应该显示邮箱地址

2. **退出重新登录**
   - 点击邮箱 → Sign Out
   - 重新登录

3. **重启设备**
   - 完全关机
   - 重新开机
   - 重新测试

4. **检查产品状态**
   - App Store Connect → 产品状态应该不是"草稿"

### 问题 2：取消后仍显示"购买成功"

**可能原因**：
- 代码中的错误处理有遗漏
- StoreKit 返回了意外的状态

**解决方法**：

1. **查看完整的控制台日志**
   - 找到 "❌ StoreKit purchase() 抛出异常" 相关日志
   - 查看异常类型和描述

2. **提供日志给我分析**
   - 从点击购买到显示"购买成功"的完整日志

### 问题 3：支付对话框一闪而过

**可能原因**：
- StoreKit Testing 自动完成了购买
- 之前的购买记录被缓存

**解决方法**：

1. **重置 StoreKit 交易**
   ```
   Debug → StoreKit → Manage Transactions... → 删除所有
   ```

2. **清理应用数据**
   - 在设备上删除应用
   - 重新安装

---

## 📊 预期的正常日志

### 产品加载
```
📦 开始加载产品列表...
✅ 后端返回 4 个产品
  - com.qinghe.qinghe.membership.monthlyv4 -> planCode: monthly_auto
🔍 从 StoreKit 请求 4 个产品
📱 运行环境: 真机
✅ StoreKit 返回 4 个产品
  - com.qinghe.qinghe.membership.monthlyv4: 连续包月 - ¥29.90
```

### 点击购买
```
🛒 开始购买流程...
📦 计划代码: monthly_auto
✅ 找到产品: com.qinghe.qinghe.membership.monthlyv4 - 连续包月
💰 价格: ¥29.90
🔄 开始调用 StoreKit 购买...
[弹出沙盒支付对话框]
```

### 用户取消
```
📱 StoreKit 返回结果...
❌ StoreKit purchase() 抛出异常: userCancelled
🔍 StoreKitError 详情: userCancelled
✅ 确认：用户取消了购买
[不显示任何提示]
```

### 购买成功
```
📱 StoreKit 返回结果...
🔍 开始处理购买结果...
✅ 购买成功，开始验证交易...
✅ 交易验证通过
🆔 交易ID: 2000001031446753
🔄 向后端验证...
✅ 后端验证成功
🎉 购买流程完成！
[显示"购买成功"提示]
```

---

## ✅ 成功标准

完成以上步骤后，应该达到以下效果：

- [x] 设备上已登录沙盒测试账号
- [x] 点击"连续包月"后直接弹出沙盒支付对话框
- [x] 支付对话框显示正确的价格（¥29.90）
- [x] 点击"取消"后不显示任何提示
- [x] 点击"订阅"后显示"购买成功"并激活会员
- [x] 其他套餐的购买流程也正常

---

## 📞 需要帮助？

如果按照以上步骤仍然有问题，请提供：

1. **沙盒账号登录状态截图**（设置 → App Store → SANDBOX ACCOUNT）
2. **完整的控制台日志**（从点击购买到结束）
3. **具体现象描述**（点击后发生了什么）

---

**更新时间**：2025-10-13  
**测试环境**：iOS 真机 + 沙盒账号  
**相关文档**：
- 连续包月价格问题-快速修复指南.md
- 诊断支付对话框不弹出问题.md


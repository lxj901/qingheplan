# 删除标记功能实现说明

## 实现日期
2025-10-20

## 功能概述

实现了删除笔记、高亮和收藏的 API 对接功能。

## API 设计说明

由于后端 API 文档中**没有专门的删除接口**，我们采用的策略是：
- **删除 = 更新为空值**

通过调用 `POST /api/v1/classics/marks` 接口，将字段设置为空值来实现删除效果：
- 删除笔记：`note: ""`
- 删除高亮：`highlight: ""`
- 取消收藏：`isFavorite: false`

## 实现细节

### 1. ClassicsAPIService.swift

添加了三个便捷方法，封装删除逻辑：

```swift
/// 删除笔记（通过将 note 设置为空字符串）
func deleteNote(userId: Int, sectionId: String) async throws -> ClassicsMark {
    return try await addOrUpdateMark(userId: userId, sectionId: sectionId, note: "")
}

/// 删除高亮（通过将 highlight 设置为空字符串）
func deleteHighlight(userId: Int, sectionId: String) async throws -> ClassicsMark {
    return try await addOrUpdateMark(userId: userId, sectionId: sectionId, highlight: "")
}

/// 取消收藏（通过将 isFavorite 设置为 false）
func deleteFavorite(userId: Int, sectionId: String) async throws -> ClassicsMark {
    return try await addOrUpdateMark(userId: userId, sectionId: sectionId, isFavorite: false)
}
```

**优点**:
- 复用现有的 `addOrUpdateMark` 方法
- API 调用逻辑一致
- 代码简洁易维护

### 2. ClassicsReadingView.swift

#### 修改前的删除笔记逻辑

```swift
// 删除笔记
private func deleteNote(_ note: AnnotatedNote) {
    // 从所有 section 的笔记中查找并删除
    for (sectionId, var sectionNotes) in notes {
        if let index = sectionNotes.firstIndex(where: { $0.id == note.id }) {
            sectionNotes.remove(at: index)
            notes[sectionId] = sectionNotes
            break
        }
    }
    viewingNote = nil
    // ❌ 没有调用 API
}
```

#### 修改后的删除笔记逻辑

```swift
// 删除笔记
private func deleteNote(_ note: AnnotatedNote) {
    // 从所有 section 的笔记中查找并删除
    var targetSectionId: String? = nil
    for (sectionId, var sectionNotes) in notes {
        if let index = sectionNotes.firstIndex(where: { $0.id == note.id }) {
            sectionNotes.remove(at: index)
            notes[sectionId] = sectionNotes
            targetSectionId = sectionId  // ✅ 记录 sectionId
            break
        }
    }
    viewingNote = nil

    // ✅ 调用 API 删除笔记
    if let sectionId = targetSectionId {
        Task {
            await deleteNoteFromAPI(sectionId: sectionId)
        }
    }
}

/// 从 API 删除笔记
private func deleteNoteFromAPI(sectionId: String) async {
    guard let userId = AuthManager.shared.getCurrentUserId() else {
        return
    }

    do {
        _ = try await ClassicsAPIService.shared.deleteNote(userId: userId, sectionId: sectionId)
        print("✅ 成功删除笔记: sectionId=\(sectionId)")
    } catch {
        await MainActor.run {
            toastMessage = "删除笔记失败: \(error.localizedDescription)"
            showToast = true
        }
    }
}
```

**改进点**:
1. ✅ 记录被删除笔记所属的 `sectionId`
2. ✅ 调用 API 同步删除服务器上的数据
3. ✅ 添加错误处理和用户提示

## 删除流程

### 删除笔记流程
```
用户点击删除 → 从本地 notes 字典中删除 →
获取 sectionId → 调用 API deleteNote() →
发送 POST /marks (note: "") → 服务器更新 →
返回成功 → 打印日志
```

### 删除高亮流程
```
用户取消高亮 → 从本地 coloredHighlights 中删除 →
调用 API deleteHighlight() →
发送 POST /marks (highlight: "") → 服务器更新
```

### 取消收藏流程
```
用户取消收藏 → 从本地状态中更新 →
调用 API deleteFavorite() →
发送 POST /marks (isFavorite: false) → 服务器更新
```

## API 请求示例

### 删除笔记
```http
POST /api/v1/classics/marks
Content-Type: application/json
Authorization: Bearer {token}

{
  "userId": 123,
  "sectionId": "uuid",
  "note": ""              // 空字符串表示删除
}
```

### 删除高亮
```http
POST /api/v1/classics/marks
Content-Type: application/json
Authorization: Bearer {token}

{
  "userId": 123,
  "sectionId": "uuid",
  "highlight": ""         // 空字符串表示删除
}
```

### 取消收藏
```http
POST /api/v1/classics/marks
Content-Type: application/json
Authorization: Bearer {token}

{
  "userId": 123,
  "sectionId": "uuid",
  "isFavorite": false     // false 表示取消收藏
}
```

## 注意事项

### 1. 空值处理

后端需要正确处理空值：
- `note: ""` 应该清除数据库中的 note 字段
- `highlight: ""` 应该清除数据库中的 highlight 字段
- `isFavorite: false` 应该更新为 false

### 2. 数据同步

删除操作的流程：
1. **先更新本地 UI** - 立即响应用户操作
2. **再调用 API** - 后台同步到服务器
3. **失败回滚** - 如果 API 调用失败，需要考虑是否回滚本地状态

目前实现：
- ✅ 立即更新本地 UI
- ✅ 异步调用 API
- ⚠️ **未实现失败回滚**（如果 API 失败，本地已删除但服务器未删除）

### 3. 多字段删除

如果需要同时删除多个字段（例如笔记+高亮），应该：
```swift
// 一次性删除多个字段
try await addOrUpdateMark(
    userId: userId,
    sectionId: sectionId,
    highlight: "",
    note: ""
)
```

而不是分别调用两次 API。

## 待实现功能

目前**只实现了删除笔记**的 UI 对接，其他两个功能还需要实现：

### 1. 删除高亮功能

需要在高亮菜单中添加"删除高亮"按钮：

```swift
// 在高亮选择器中添加
Button(action: {
    if let sectionId = currentSectionId, let r = pendingRange {
        // 从本地删除
        var sectionHighlights = coloredHighlights[sectionId] ?? []
        sectionHighlights.removeAll { $0.range.location == r.location && $0.range.length == r.length }
        coloredHighlights[sectionId] = sectionHighlights

        // 调用 API 删除
        Task {
            await deleteHighlightFromAPI(sectionId: sectionId)
        }
    }
    showHighlightPicker = false
}) {
    Text("删除高亮")
        .foregroundColor(.red)
}
```

### 2. 取消收藏功能

需要在收藏后添加"取消收藏"选项：

```swift
// 检测是否已收藏
if isFavorite {
    Button("取消收藏") {
        Task {
            await deleteFavoriteFromAPI(sectionId: section.id)
        }
    }
}
```

## 测试检查清单

### 删除笔记测试
- [x] 添加笔记后删除 → 本地 UI 立即更新
- [ ] 验证控制台日志显示"成功删除笔记"
- [ ] 刷新页面后验证笔记确实被删除
- [ ] 测试删除失败的情况（网络错误等）

### 删除高亮测试（待实现）
- [ ] 添加高亮后删除
- [ ] 验证高亮从 UI 中消失
- [ ] 刷新页面后验证高亮确实被删除

### 取消收藏测试（待实现）
- [ ] 添加收藏后取消
- [ ] 验证收藏状态更新
- [ ] 刷新页面后验证收藏确实被取消

### 边界情况测试
- [ ] 用户未登录时尝试删除
- [ ] 网络断开时删除操作
- [ ] 删除不存在的标记
- [ ] 快速连续删除多个标记

## 优化建议

### 短期优化

1. **实现失败回滚**:
   ```swift
   // 保存删除前的状态
   let backupNotes = notes[sectionId]

   // 删除
   notes[sectionId] = updatedNotes

   // API 调用
   do {
       try await deleteNote(...)
   } catch {
       // 失败回滚
       notes[sectionId] = backupNotes
       showError("删除失败")
   }
   ```

2. **添加删除确认**:
   ```swift
   .alert("确认删除", isPresented: $showDeleteConfirm) {
       Button("取消", role: .cancel) { }
       Button("删除", role: .destructive) {
           deleteNote(note)
       }
   }
   ```

3. **完善其他删除功能**:
   - 实现删除高亮的 UI
   - 实现取消收藏的 UI

### 中期优化

1. **批量删除**:
   - 支持一次删除多个笔记
   - 支持清空某个 section 的所有标记

2. **撤销功能**:
   - 删除后显示"撤销"按钮
   - 3秒内可以撤销删除操作

3. **离线支持**:
   - 离线时缓存删除操作
   - 上线后自动同步

## 修改文件清单

### ClassicsAPIService.swift

**第 415-440 行**: 添加三个删除方法
- `deleteNote()` - 删除笔记
- `deleteHighlight()` - 删除高亮
- `deleteFavorite()` - 取消收藏

### ClassicsReadingView.swift

**第 216-253 行**: 修改 `deleteNote` 方法
- 记录被删除笔记的 sectionId
- 添加 `deleteNoteFromAPI()` 方法
- 添加错误处理

## 版本信息

- **版本**: 1.3.0
- **实现日期**: 2025-10-20
- **实现功能**:
  - ✅ 删除笔记 API 对接（已完成）
  - ⚠️ 删除高亮 UI（待实现）
  - ⚠️ 取消收藏 UI（待实现）
- **影响范围**:
  - ClassicsAPIService.swift
  - ClassicsReadingView.swift

# 内购问题诊断指南

## 问题概述

从日志分析，发现以下问题：

### 1. StoreKit 返回 0 个产品 ⚠️

```
🔍 从 StoreKit 请求 5 个产品: ["com.qinghejihua.membership.basic.monthly", ...]
✅ StoreKit 返回 0 个产品
```

**原因：** App Store Connect 中可能没有配置这些产品 ID，或产品状态不正确。

### 2. planCode 不匹配 ⚠️

```
🔍 查找产品 planCode: monthly_auto
❌ 未找到匹配的后端产品
```

后端会员计划列表中可能有 `monthly_auto`，但 Apple IAP 产品列表中没有对应的产品。

## 解决步骤

### 步骤 1: 检查 App Store Connect 配置

1. 登录 [App Store Connect](https://appstoreconnect.apple.com)
2. 进入你的 App
3. 点击 "功能" → "App 内购买项目和订阅"
4. 确保以下产品已创建并处于 **"准备提交"** 或 **"已批准"** 状态：

   - `com.qinghejihua.membership.basic.monthly`
   - `com.qinghejihua.membership.standard.monthly`
   - `com.qinghejihua.membership.premium.monthly`
   - `com.qinghejihua.membership.standard.yearly`
   - `com.qinghejihua.membership.premium.yearly`

5. 每个产品必须：
   - 有产品 ID（与上面的列表匹配）
   - 有本地化信息（至少中文）
   - 有价格点
   - 状态为 "准备提交" 或更高

### 步骤 2: 验证沙盒测试环境

1. **检查设备设置：**
   - 打开 "设置" → "App Store" → "沙盒账户"
   - 确保已登录沙盒测试账号
   - 如果没有，请在 App Store Connect 中创建沙盒测试用户

2. **清除缓存：**
   - 退出沙盒账号
   - 重新登录
   - 重启设备

3. **确保协议已签署：**
   - 在 App Store Connect 中，检查 "协议、税务和银行业务"
   - 确保 "付费 App 协议" 已签署并处于活动状态

### 步骤 3: 修复 planCode 不匹配问题

有两种解决方案：

#### 方案 A: 后端添加 Apple IAP 产品（推荐）

如果后端有 `monthly_auto` 会员计划，需要在后端创建对应的 Apple IAP 产品：

```sql
INSERT INTO apple_iap_products (product_id, membership_plan_id, ...)
VALUES ('com.qinghejihua.membership.monthly.auto', <monthly_auto_plan_id>, ...);
```

#### 方案 B: 前端过滤无效套餐

修改前端代码，只显示有对应 Apple IAP 产品的套餐。

### 步骤 4: 测试购买流程

1. 重新运行应用
2. 查看新的日志输出：
   ```
   📋 会员计划列表:
     - basic_monthly: 基础会员（月付） - ¥19.9
     - ...
   ```
3. 点击一个有对应 Apple IAP 产品的套餐（如 `basic_monthly`）
4. 观察是否能成功发起购买

## 预期日志输出

成功的日志应该类似：

```
📦 开始加载产品列表...
✅ 后端返回 5 个产品
  - com.qinghejihua.membership.basic.monthly -> planCode: basic_monthly
  - ...
🔍 从 StoreKit 请求 5 个产品: [...]
✅ StoreKit 返回 5 个产品  👈 关键！必须 > 0
  - com.qinghejihua.membership.basic.monthly: 基础会员（月付） - ¥19.9
  - ...

📋 会员计划列表:
  - basic_monthly: 基础会员（月付） - ¥19.9
  - ...

🔍 查找产品 planCode: basic_monthly
🔍 后端产品数量: 5
  - 产品: com.qinghejihua.membership.basic.monthly, planCode: basic_monthly
✅ 找到匹配的后端产品: com.qinghejihua.membership.basic.monthly
✅ 找到对应的 StoreKit 产品  👈 成功！
```

## 常见问题

### Q1: StoreKit 一直返回 0 个产品？

**A:** 可能的原因：
1. 产品 ID 拼写错误
2. 产品在 App Store Connect 中状态不正确
3. Bundle ID 不匹配
4. 需要等待 App Store Connect 同步（最多 2 小时）
5. 协议未签署或过期

### Q2: 提示 "未找到匹配的内购产品"？

**A:** 说明：
- 会员计划的 `planCode` 与 Apple IAP 产品的 `membershipPlan.planCode` 不匹配
- 需要在后端添加对应的 Apple IAP 产品，或前端过滤掉该套餐

### Q3: 如何测试沙盒购买？

**A:** 
1. 使用测试设备（真机，不能用模拟器）
2. 设置 → App Store → 沙盒账户 → 登录测试账号
3. **不要**在 App Store 中登录测试账号
4. 首次购买时会弹出登录框，输入测试账号密码

## 下一步

1. 运行应用并检查新的日志输出
2. 将日志发送给我，我会帮你进一步诊断
3. 特别注意：
   - `✅ StoreKit 返回 X 个产品` 中 X 的值
   - `📋 会员计划列表` 中的 planCode 列表
   - 你点击的是哪个套餐

